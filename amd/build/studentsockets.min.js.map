{"version":3,"file":"studentsockets.min.js","sources":["../src/studentsockets.js"],"sourcesContent":["\"use strict\";\n\nimport jQuery from 'jquery';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport Ajax from 'core/ajax';\nimport Encryptor from 'mod_jqshow/encryptor';\nimport mEvent from 'core/event';\n\nlet REGION = {\n    MESSAGEBOX: '#message-box',\n    USERLIST: '[data-region=\"active-users\"]',\n    COUNTUSERS: '#countusers',\n    ROOT: '[data-region=\"student-canvas\"]'\n};\n\nlet SERVICES = {\n    SESSIONFIINISHED: 'mod_jqshow_sessionfinished',\n    USERQUESTIONRESPONSE: 'mod_jqshow_getuserquestionresponse'\n};\n\nlet TEMPLATES = {\n    LOADING: 'core/overlay_loading',\n    SUCCESS: 'core/notification_success',\n    ERROR: 'core/notification_error',\n    PARTICIPANT: 'mod_jqshow/session/manual/waitingroom/participant',\n    GROUPPARTICIPANT: 'mod_jqshow/session/manual/waitingroom/groupparticipant',\n    SESSIONFIINISHED: 'mod_jqshow/session/manual/closeconnection',\n    QUESTION: 'mod_jqshow/questions/encasement',\n    PROVISIONALRANKING: 'mod_jqshow/ranking/provisional'\n};\n\nlet portUrl = '8080';\n\n/**\n * @constructor\n * @param {String} region\n * @param {String} port\n */\nfunction Sockets(region, port) {\n    this.root = jQuery(region);\n    portUrl = port;\n    this.initSockets();\n    this.disableDevTools();\n    this.initListeners();\n}\n\nSockets.prototype.disableDevTools = function() {\n    document.addEventListener('contextmenu', (e) => e.preventDefault());\n    document.onkeydown = (e) => {\n        return !(event.keyCode === 123 ||\n            this.ctrlShiftKey(e, 'I') ||\n            this.ctrlShiftKey(e, 'J') ||\n            this.ctrlShiftKey(e, 'C') ||\n            (e.ctrlKey && e.keyCode === 'U'.charCodeAt(0)));\n    };\n};\n\nSockets.prototype.ctrlShiftKey = function(e, keyCode) {\n    return e.ctrlKey && e.shiftKey && e.keyCode === keyCode.charCodeAt(0);\n};\n\n/** @type {jQuery} The jQuery node for the page region. */\nSockets.prototype.root = null;\n\nlet userid = null;\nlet usersocketid = null;\nlet username = null;\nlet userimage = null;\nlet messageBox = null;\nlet countusers = null;\nlet cmid = null;\nlet sid = null;\nlet jqshowid = null;\nlet currentCuestionJqid = null;\nlet groupid = 0;\nlet groupmode = 0;\nlet groupimage = null;\nlet groupname = null;\n\nSockets.prototype.initSockets = function() {\n    userid = this.root[0].dataset.userid;\n    username = this.root[0].dataset.username;\n    userimage = this.root[0].dataset.userimage;\n    jqshowid = this.root[0].dataset.jqshowid;\n    cmid = this.root[0].dataset.cmid;\n    sid = this.root[0].dataset.sid;\n    messageBox = this.root.find(REGION.MESSAGEBOX);\n    countusers = this.root.find(REGION.COUNTUSERS);\n    groupmode = this.root[0].dataset.groupmode;\n    if (groupmode != '0') {\n        groupimage = this.root[0].dataset.groupimage;\n        groupid = parseInt(this.root[0].dataset.groupid);\n        groupname = this.root[0].dataset.groupname;\n    }\n\n    Sockets.prototype.webSocket = new WebSocket(\n        'wss://' + M.cfg.wwwroot.replace(/^https?:\\/\\//, '') + ':' + portUrl + '/jqshow'\n    );\n\n    Sockets.prototype.webSocket.onopen = function() {\n\n    };\n\n    Sockets.prototype.webSocket.onmessage = function(ev) {\n        let msgDecrypt = Encryptor.decrypt(ev.data);\n        let response = JSON.parse(msgDecrypt); // PHP sends Json data.\n        let resAction = response.action; // Message type.\n        switch (resAction) {\n            case 'connect':\n                // The server has returned the connected status, it is time to identify yourself.\n                if (response.usersocketid !== undefined) {\n                    usersocketid = response.usersocketid;\n                    let msg = {\n                        'userid': userid,\n                        'name': username,\n                        'pic': userimage, // TODO encrypt.\n                        'cmid': cmid,\n                        'sid': sid,\n                        'usersocketid': usersocketid,\n                        'action': 'newuser',\n                    };\n                    if (groupmode) {\n                        msg.action = 'newgroup';\n                        msg.name = groupname;\n                        msg.pic = groupimage; // TODO encrypt.\n                        msg.groupid = groupid;\n                    }\n                    Sockets.prototype.sendMessageSocket(JSON.stringify(msg));\n                }\n                break;\n            case 'newuser': {\n                let identifier = jQuery(REGION.USERLIST);\n                let data = response.students;\n                identifier.html('');\n                jQuery.each(data, function (i, student) {\n                    let templateContext = {\n                        'usersocketid': student.usersocketid,\n                        'userimage': student.picture,\n                        'userfullname': student.name,\n                    };\n                    Templates.render(TEMPLATES.PARTICIPANT, templateContext).then(function(html) {\n                        identifier.append(html);\n                    }).fail(Notification.exception);\n                });\n                countusers.html(response.count);\n                break;\n            }\n            case 'newgroup': {\n                let participantshtml = jQuery(REGION.USERLIST);\n                let grouplist = response.groups;\n                participantshtml.html('');\n                jQuery.each(grouplist, function (i, group) {\n                    let templateContext = {\n                        'usersocketid': group.usersocketid,\n                        'groupimage': group.picture,\n                        'groupid': group.groupid,\n                        'name': group.name,\n                        'numgroupusers': group.numgroupusers,\n                    };\n                    Templates.render(TEMPLATES.GROUPPARTICIPANT, templateContext).then(function(html) {\n                        participantshtml.append(html);\n                    }).fail(Notification.exception);\n                });\n                countusers.html(response.count);\n                break;\n            }\n            case 'countusers':\n                countusers.html(response.count);\n                break;\n            case 'question':\n                Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n                    let identifier = jQuery(REGION.ROOT);\n                    identifier.append(html);\n                    currentCuestionJqid = response.context.jqid;\n                    let request = {\n                        methodname: SERVICES.USERQUESTIONRESPONSE,\n                        args: {\n                            jqid: response.context.jqid,\n                            cmid: cmid,\n                            sid: sid,\n                            uid: 0\n                        }\n                    };\n                    Ajax.call([request])[0].done(function(answer) {\n                        const questionData = {\n                            ...response.context.value,\n                            ...answer\n                        };\n                        Templates.render(TEMPLATES.QUESTION, questionData).then(function(html, js) {\n                            identifier.html(html);\n                            Templates.runTemplateJS(js);\n                            mEvent.notifyFilterContentUpdated(document.querySelector(REGION.ROOT));\n                            jQuery(REGION.LOADING).remove();\n                        }).fail(Notification.exception);\n                    });\n                });\n                break;\n            case 'ranking':\n                Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n                    let identifier = jQuery(REGION.ROOT);\n                    identifier.append(html);\n                    Templates.render(TEMPLATES.PROVISIONALRANKING, response.context).then(function(html, js) {\n                        identifier.html(html);\n                        Templates.runTemplateJS(js);\n                        jQuery(REGION.LOADING).remove();\n                    }).fail(Notification.exception);\n                });\n                break;\n            case 'pauseQuestion':\n                dispatchEvent(new Event('pauseQuestion_' + response.jqid));\n                break;\n            case 'playQuestion':\n                dispatchEvent(new Event('playQuestion_' + response.jqid));\n                break;\n            case 'showAnswers':\n                dispatchEvent(new Event('showAnswers_' + response.jqid));\n                break;\n            case 'hideAnswers':\n                dispatchEvent(new Event('hideAnswers_' + response.jqid));\n                break;\n            case 'showStatistics':\n                dispatchEvent(new Event('showStatistics_' + response.jqid));\n                break;\n            case 'hideStatistics':\n                dispatchEvent(new Event('hideStatistics_' + response.jqid));\n                break;\n            case 'showFeedback':\n                dispatchEvent(new Event('showFeedback_' + response.jqid));\n                break;\n            case 'hideFeedback':\n                dispatchEvent(new Event('hideFeedback_' + response.jqid));\n                break;\n            case 'endSession':\n                Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n                    let identifier = jQuery(REGION.ROOT);\n                    identifier.append(html);\n                    currentCuestionJqid = response.context.jqid;\n                    Templates.render(TEMPLATES.QUESTION, response.context.value).then(function(html, js) {\n                        identifier.html(html);\n                        Templates.runTemplateJS(js);\n                        jQuery(REGION.LOADING).remove();\n                    }).fail(Notification.exception);\n                });\n                break;\n            case 'teacherQuestionEnd':\n                dispatchEvent(new CustomEvent('teacherQuestionEnd_' + response.jqid, {\n                    \"detail\": {\"statistics\": response.statistics}\n                }));\n                break;\n            case 'userdisconnected':\n                jQuery('[data-userid=\"' + response.usersocketid + '\"]').remove();\n                countusers.html(response.count);\n                break;\n            default:\n                break;\n        }\n        messageBox[0].scrollTop = messageBox[0].scrollHeight;\n    };\n\n    Sockets.prototype.webSocket.onerror = function(ev) {\n        messageBox.append('<div class=\"system_error\">Error Occurred - ' + ev.data + '</div>');\n    };\n\n    Sockets.prototype.webSocket.onclose = function() {\n        let request = {\n            methodname: SERVICES.SESSIONFIINISHED,\n            args: {\n                jqshowid: jqshowid,\n                cmid: cmid\n            }\n        };\n        Ajax.call([request])[0].done(function(response) {\n            Templates.render(TEMPLATES.SESSIONFIINISHED, response).then(function(html, js) {\n                jQuery(REGION.ROOT).html(html);\n                Templates.runTemplateJS(js);\n            }).fail(Notification.exception);\n        });\n    };\n};\n\nSockets.prototype.initListeners = function() {\n    addEventListener('studentQuestionEnd', () => {\n        // TODO get the result and score of the user's response and send it to the socket for the teacher to receive.\n        // TODO there is no way to get the note yet, it can be stored in dataSotarge with id->currentsid so that it can pick it up.\n        let msg = {\n            'userid': userid,\n            'sid': sid,\n            'usersocketid': usersocketid,\n            'jqid': currentCuestionJqid,\n            'answer': '', // TODO get pulsed response.\n            'points': '', // TODO obtain total score.\n            'oft': true, // IMPORTANT: Only for teacher.\n            'action': 'studentQuestionEnd',\n        };\n        Sockets.prototype.sendMessageSocket(JSON.stringify(msg));\n    }, false);\n};\n\nSockets.prototype.sendMessageSocket = function(msg) {\n    this.webSocket.send(msg);\n};\n\nexport const studentInitSockets = (region, port, groupmode, groupid) => {\n    return new Sockets(region, port, groupmode, groupid);\n};\n"],"names":["REGION","MESSAGEBOX","USERLIST","COUNTUSERS","ROOT","SERVICES","TEMPLATES","portUrl","Sockets","region","port","root","initSockets","disableDevTools","initListeners","prototype","document","addEventListener","e","preventDefault","onkeydown","event","keyCode","this","ctrlShiftKey","ctrlKey","charCodeAt","shiftKey","userid","usersocketid","username","userimage","messageBox","countusers","cmid","sid","jqshowid","currentCuestionJqid","groupid","groupmode","groupimage","groupname","dataset","find","parseInt","webSocket","WebSocket","M","cfg","wwwroot","replace","onopen","onmessage","ev","msgDecrypt","Encryptor","decrypt","data","response","JSON","parse","action","undefined","msg","name","pic","sendMessageSocket","stringify","identifier","students","html","each","i","student","templateContext","picture","render","then","append","fail","Notification","exception","count","participantshtml","grouplist","groups","group","numgroupusers","visible","done","context","jqid","request","methodname","args","uid","call","answer","questionData","value","js","runTemplateJS","notifyFilterContentUpdated","querySelector","LOADING","remove","dispatchEvent","Event","CustomEvent","statistics","scrollTop","scrollHeight","onerror","onclose","send"],"mappings":"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"}