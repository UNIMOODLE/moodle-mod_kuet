{"version":3,"file":"studentsockets.min.js","sources":["../src/studentsockets.js"],"sourcesContent":["\"use strict\";\n/* eslint-disable no-unused-vars */ // TODO remove.\n\nimport jQuery from 'jquery';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport Ajax from 'core/ajax';\n\nlet REGION = {\n    MESSAGEBOX: '#message-box',\n    USERLIST: '[data-region=\"active-users\"]',\n    COUNTUSERS: '#countusers',\n    ROOT: '[data-region=\"student-canvas\"]'\n};\n\nlet SERVICES = {\n    SESSIONFIINISHED: 'mod_jqshow_sessionfinished',\n};\n\nlet TEMPLATES = {\n    LOADING: 'core/overlay_loading',\n    SUCCESS: 'core/notification_success',\n    ERROR: 'core/notification_error',\n    PARTICIPANT: 'mod_jqshow/session/manual/waitingroom/participant',\n    SESSIONFIINISHED: 'mod_jqshow/session/manual/closeconnection',\n};\n\nlet portUrl = '8080';\n\n/**\n * @constructor\n * @param {String} region\n * @param {String} port\n */\nfunction Sockets(region, port) {\n    this.root = jQuery(region);\n    portUrl = port;\n    this.initSockets();\n}\n\n/** @type {jQuery} The jQuery node for the page region. */\nSockets.prototype.root = null;\n\nlet userid = null;\nlet usersocketid = null;\nlet username = null;\nlet userimage = null;\nlet messageBox = null;\nlet userlist = null;\nlet countusers = null;\nlet cmid = null;\nlet sid = null;\nlet jqshowid = null;\n\nSockets.prototype.initSockets = function() {\n    userid = this.root[0].dataset.userid;\n    username = this.root[0].dataset.username;\n    userimage = this.root[0].dataset.userimage;\n    jqshowid = this.root[0].dataset.jqshowid;\n    cmid = this.root[0].dataset.cmid;\n    sid = this.root[0].dataset.sid;\n    messageBox = this.root.find(REGION.MESSAGEBOX);\n    userlist = this.root.find(REGION.USERLIST);\n    countusers = this.root.find(REGION.COUNTUSERS);\n\n    Sockets.prototype.webSocket = new WebSocket(\n        'wss://' + M.cfg.wwwroot.replace(/^https?:\\/\\//, '') + ':' + portUrl + '/jqshow'\n    );\n\n    Sockets.prototype.webSocket.onopen = function(event) {\n        // TODO delete.\n        messageBox.append(\n            '<div class=\"system_msg\" style=\"color:#bbbbbb\">' +\n            'Bienvenido a Jam Quiz Show ' + username + '!</div>'\n        );\n    };\n\n    Sockets.prototype.webSocket.onmessage = function(ev) {\n        let response = JSON.parse(ev.data); // PHP sends Json data.\n        let resAction = response.action; // Message type.\n        switch (resAction) {\n            case 'connect':\n                // The server has returned the connected status, it is time to identify yourself.\n                if (response.usersocketid !== undefined) {\n                    usersocketid = response.usersocketid;\n                    // eslint-disable-next-line no-console\n                    console.log(response.usersocketid);\n                    let msg = {\n                        'userid': userid,\n                        'name': username,\n                        'pic': userimage, // TODO encrypt.\n                        'cmid': cmid,\n                        'sid': sid,\n                        'usersocketid': usersocketid,\n                        'action': 'newuser',\n                    };\n                    Sockets.prototype.sendMessageSocket(JSON.stringify(msg));\n                }\n                break;\n            case 'newuser': {\n                let identifier = jQuery(REGION.USERLIST);\n                let data = response.students;\n                identifier.html('');\n                jQuery.each(data, function (i, student) {\n                    let templateContext = {\n                        'usersocketid': student.usersocketid,\n                        'userimage': student.picture,\n                        'userfullname': student.name,\n                    };\n                    Templates.render(TEMPLATES.PARTICIPANT, templateContext).then(function(html, js) {\n                        identifier.append(html);\n                    }).fail(Notification.exception);\n                });\n                countusers.html(response.count);\n                break;\n            }\n            case 'countusers':\n                countusers.html(response.count);\n                break;\n            case 'userdisconnected':\n                jQuery('[data-userid=\"' + response.usersocketid + '\"]').remove();\n                countusers.html(response.count);\n                break;\n            default:\n                break;\n        }\n        messageBox[0].scrollTop = messageBox[0].scrollHeight;\n    };\n\n    Sockets.prototype.webSocket.onerror = function(ev) {\n        messageBox.append('<div class=\"system_error\">Error Occurred - ' + ev.data + '</div>');\n    };\n\n    Sockets.prototype.webSocket.onclose = function() {\n        let request = {\n            methodname: SERVICES.SESSIONFIINISHED,\n            args: {\n                jqshowid: jqshowid,\n                cmid: cmid\n            }\n        };\n        Ajax.call([request])[0].done(function(response) {\n            Templates.render(TEMPLATES.SESSIONFIINISHED, response).then(function(html, js) {\n                jQuery(REGION.ROOT).html(html);\n                Templates.runTemplateJS(js);\n            }).fail(Notification.exception);\n        });\n    };\n};\n\nSockets.prototype.sendMessageSocket = function(msg) {\n    this.webSocket.send(msg);\n};\n\nexport const studentInitSockets = (region, port) => {\n    return new Sockets(region, port);\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","Object","defineProperty","_exports","value","studentInitSockets","_jquery","_templates","_notification","_ajax","REGION","SERVICES","TEMPLATES","portUrl","Sockets","region","port","this","root","jQuery","initSockets","prototype","userid","usersocketid","username","userimage","messageBox","countusers","cmid","sid","jqshowid","dataset","find","webSocket","WebSocket","M","cfg","wwwroot","replace","onopen","event","append","onmessage","ev","response","JSON","parse","data","action","undefined","console","log","msg","name","pic","sendMessageSocket","stringify","identifier","students","html","each","i","student","templateContext","picture","userfullname","Templates","render","then","js","fail","Notification","exception","count","remove","scrollTop","scrollHeight","onerror","onclose","request","methodname","args","Ajax","call","done","runTemplateJS","send"],"mappings":"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"}