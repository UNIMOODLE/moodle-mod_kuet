{"version":3,"file":"studentsockets.min.js","sources":["../src/studentsockets.js"],"sourcesContent":["\"use strict\";\r\n\r\nimport jQuery from 'jquery';\r\nimport Templates from 'core/templates';\r\nimport Notification from 'core/notification';\r\nimport Ajax from 'core/ajax';\r\nimport Encryptor from 'mod_jqshow/encryptor';\r\nimport mEvent from 'core/event';\r\n\r\nlet REGION = {\r\n    MESSAGEBOX: '#message-box',\r\n    USERLIST: '[data-region=\"active-users\"]',\r\n    COUNTUSERS: '#countusers',\r\n    ROOT: '[data-region=\"student-canvas\"]'\r\n};\r\n\r\nlet SERVICES = {\r\n    SESSIONFIINISHED: 'mod_jqshow_sessionfinished',\r\n    USERQUESTIONRESPONSE: 'mod_jqshow_getuserquestionresponse'\r\n};\r\n\r\nlet TEMPLATES = {\r\n    LOADING: 'core/overlay_loading',\r\n    SUCCESS: 'core/notification_success',\r\n    ERROR: 'core/notification_error',\r\n    PARTICIPANT: 'mod_jqshow/session/manual/waitingroom/participant',\r\n    SESSIONFIINISHED: 'mod_jqshow/session/manual/closeconnection',\r\n    QUESTION: 'mod_jqshow/questions/encasement',\r\n    PROVISIONALRANKING: 'mod_jqshow/ranking/provisional'\r\n};\r\n\r\nlet portUrl = '8080';\r\n\r\n\r\n/**\r\n * @constructor\r\n * @param {String} region\r\n * @param {String} port\r\n */\r\nfunction Sockets(region, port) {\r\n    this.root = jQuery(region);\r\n    portUrl = port;\r\n    this.initSockets();\r\n    this.disableDevTools();\r\n    this.initListeners();\r\n}\r\n\r\nSockets.prototype.disableDevTools = function() {\r\n    document.addEventListener('contextmenu', (e) => e.preventDefault());\r\n    document.onkeydown = (e) => {\r\n        return !(event.keyCode === 123 ||\r\n            this.ctrlShiftKey(e, 'I') ||\r\n            this.ctrlShiftKey(e, 'J') ||\r\n            this.ctrlShiftKey(e, 'C') ||\r\n            (e.ctrlKey && e.keyCode === 'U'.charCodeAt(0)));\r\n    };\r\n};\r\n\r\nSockets.prototype.ctrlShiftKey = function(e, keyCode) {\r\n    return e.ctrlKey && e.shiftKey && e.keyCode === keyCode.charCodeAt(0);\r\n};\r\n\r\n/** @type {jQuery} The jQuery node for the page region. */\r\nSockets.prototype.root = null;\r\n\r\nlet userid = null;\r\nlet usersocketid = null;\r\nlet username = null;\r\nlet userimage = null;\r\nlet messageBox = null;\r\nlet countusers = null;\r\nlet cmid = null;\r\nlet sid = null;\r\nlet jqshowid = null;\r\nlet currentCuestionJqid = null;\r\n\r\nSockets.prototype.initSockets = function() {\r\n    userid = this.root[0].dataset.userid;\r\n    username = this.root[0].dataset.username;\r\n    userimage = this.root[0].dataset.userimage;\r\n    jqshowid = this.root[0].dataset.jqshowid;\r\n    cmid = this.root[0].dataset.cmid;\r\n    sid = this.root[0].dataset.sid;\r\n    messageBox = this.root.find(REGION.MESSAGEBOX);\r\n    countusers = this.root.find(REGION.COUNTUSERS);\r\n\r\n    Sockets.prototype.webSocket = new WebSocket(\r\n        'wss://' + M.cfg.wwwroot.replace(/^https?:\\/\\//, '') + ':' + portUrl + '/jqshow'\r\n    );\r\n\r\n    Sockets.prototype.webSocket.onopen = function() {\r\n\r\n    };\r\n\r\n    Sockets.prototype.webSocket.onmessage = function(ev) {\r\n        let msgDecrypt = Encryptor.decrypt(ev.data);\r\n        let response = JSON.parse(msgDecrypt); // PHP sends Json data.\r\n        let resAction = response.action; // Message type.\r\n        switch (resAction) {\r\n            case 'connect':\r\n                // The server has returned the connected status, it is time to identify yourself.\r\n                if (response.usersocketid !== undefined) {\r\n                    usersocketid = response.usersocketid;\r\n                    let msg = {\r\n                        'userid': userid,\r\n                        'name': username,\r\n                        'pic': userimage, // TODO encrypt.\r\n                        'cmid': cmid,\r\n                        'sid': sid,\r\n                        'usersocketid': usersocketid,\r\n                        'action': 'newuser',\r\n                    };\r\n                    Sockets.prototype.sendMessageSocket(JSON.stringify(msg));\r\n                }\r\n                break;\r\n            case 'newuser': {\r\n                let identifier = jQuery(REGION.USERLIST);\r\n                let data = response.students;\r\n                identifier.html('');\r\n                jQuery.each(data, function (i, student) {\r\n                    let templateContext = {\r\n                        'usersocketid': student.usersocketid,\r\n                        'userimage': student.picture,\r\n                        'userfullname': student.name,\r\n                    };\r\n                    Templates.render(TEMPLATES.PARTICIPANT, templateContext).then(function(html) {\r\n                        identifier.append(html);\r\n                    }).fail(Notification.exception);\r\n                });\r\n                countusers.html(response.count);\r\n                break;\r\n            }\r\n            case 'countusers':\r\n                countusers.html(response.count);\r\n                break;\r\n            case 'question':\r\n                Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\r\n                    let identifier = jQuery(REGION.ROOT);\r\n                    identifier.append(html);\r\n                    currentCuestionJqid = response.context.jqid;\r\n                    let request = {\r\n                        methodname: SERVICES.USERQUESTIONRESPONSE,\r\n                        args: {\r\n                            jqid: response.context.jqid,\r\n                            cmid: cmid,\r\n                            sid: sid,\r\n                            uid: 0\r\n                        }\r\n                    };\r\n                    Ajax.call([request])[0].done(function(answer) {\r\n                        const questionData = {\r\n                            ...response.context.value,\r\n                            ...answer\r\n                        };\r\n                        Templates.render(TEMPLATES.QUESTION, questionData).then(function(html, js) {\r\n                            identifier.html(html);\r\n                            Templates.runTemplateJS(js);\r\n                            mEvent.notifyFilterContentUpdated(document.querySelector(REGION.ROOT));\r\n                            jQuery(REGION.LOADING).remove();\r\n                        }).fail(Notification.exception);\r\n                    });\r\n                });\r\n                break;\r\n            case 'ranking':\r\n                Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\r\n                    let identifier = jQuery(REGION.ROOT);\r\n                    identifier.append(html);\r\n                    Templates.render(TEMPLATES.PROVISIONALRANKING, response.context).then(function(html, js) {\r\n                        identifier.html(html);\r\n                        Templates.runTemplateJS(js);\r\n                        jQuery(REGION.LOADING).remove();\r\n                    }).fail(Notification.exception);\r\n                });\r\n                break;\r\n            case 'pauseQuestion':\r\n                dispatchEvent(new Event('pauseQuestion_' + response.jqid));\r\n                break;\r\n            case 'playQuestion':\r\n                dispatchEvent(new Event('playQuestion_' + response.jqid));\r\n                break;\r\n            case 'showAnswers':\r\n                dispatchEvent(new Event('showAnswers_' + response.jqid));\r\n                break;\r\n            case 'hideAnswers':\r\n                dispatchEvent(new Event('hideAnswers_' + response.jqid));\r\n                break;\r\n            case 'showStatistics':\r\n                dispatchEvent(new Event('showStatistics_' + response.jqid));\r\n                break;\r\n            case 'hideStatistics':\r\n                dispatchEvent(new Event('hideStatistics_' + response.jqid));\r\n                break;\r\n            case 'showFeedback':\r\n                dispatchEvent(new Event('showFeedback_' + response.jqid));\r\n                break;\r\n            case 'hideFeedback':\r\n                dispatchEvent(new Event('hideFeedback_' + response.jqid));\r\n                break;\r\n            case 'endSession':\r\n                Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\r\n                    let identifier = jQuery(REGION.ROOT);\r\n                    identifier.append(html);\r\n                    currentCuestionJqid = response.context.jqid;\r\n                    Templates.render(TEMPLATES.QUESTION, response.context.value).then(function(html, js) {\r\n                        identifier.html(html);\r\n                        Templates.runTemplateJS(js);\r\n                        jQuery(REGION.LOADING).remove();\r\n                    }).fail(Notification.exception);\r\n                });\r\n                break;\r\n            case 'teacherQuestionEnd':\r\n                dispatchEvent(new CustomEvent('teacherQuestionEnd_' + response.jqid, {\r\n                    \"detail\": {\"statistics\": response.statistics}\r\n                }));\r\n                break;\r\n            case 'userdisconnected':\r\n                jQuery('[data-userid=\"' + response.usersocketid + '\"]').remove();\r\n                countusers.html(response.count);\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n        messageBox[0].scrollTop = messageBox[0].scrollHeight;\r\n    };\r\n\r\n    Sockets.prototype.webSocket.onerror = function(ev) {\r\n        messageBox.append('<div class=\"system_error\">Error Occurred - ' + ev.data + '</div>');\r\n    };\r\n\r\n    Sockets.prototype.webSocket.onclose = function() {\r\n        let request = {\r\n            methodname: SERVICES.SESSIONFIINISHED,\r\n            args: {\r\n                jqshowid: jqshowid,\r\n                cmid: cmid\r\n            }\r\n        };\r\n        Ajax.call([request])[0].done(function(response) {\r\n            Templates.render(TEMPLATES.SESSIONFIINISHED, response).then(function(html, js) {\r\n                jQuery(REGION.ROOT).html(html);\r\n                Templates.runTemplateJS(js);\r\n            }).fail(Notification.exception);\r\n        });\r\n    };\r\n};\r\n\r\nSockets.prototype.initListeners = function() {\r\n    addEventListener('studentQuestionEnd', () => {\r\n        // TODO get the result and score of the user's response and send it to the socket for the teacher to receive.\r\n        // TODO there is no way to get the note yet, it can be stored in dataSotarge with id->currentsid so that it can pick it up.\r\n        let msg = {\r\n            'userid': userid,\r\n            'sid': sid,\r\n            'usersocketid': usersocketid,\r\n            'jqid': currentCuestionJqid,\r\n            'answer': '', // TODO get pulsed response.\r\n            'points': '', // TODO obtain total score.\r\n            'oft': true, // IMPORTANT: Only for teacher.\r\n            'action': 'studentQuestionEnd',\r\n        };\r\n        Sockets.prototype.sendMessageSocket(JSON.stringify(msg));\r\n    }, false);\r\n};\r\n\r\nSockets.prototype.sendMessageSocket = function(msg) {\r\n    this.webSocket.send(msg);\r\n};\r\n\r\nexport const studentInitSockets = (region, port) => {\r\n    return new Sockets(region, port);\r\n};\r\n"],"names":["REGION","MESSAGEBOX","USERLIST","COUNTUSERS","ROOT","SERVICES","TEMPLATES","portUrl","Sockets","region","port","root","initSockets","disableDevTools","initListeners","prototype","document","addEventListener","e","preventDefault","onkeydown","event","keyCode","this","ctrlShiftKey","ctrlKey","charCodeAt","shiftKey","userid","usersocketid","username","userimage","messageBox","countusers","cmid","sid","jqshowid","currentCuestionJqid","dataset","find","webSocket","WebSocket","M","cfg","wwwroot","replace","onopen","onmessage","ev","msgDecrypt","Encryptor","decrypt","data","response","JSON","parse","action","undefined","msg","sendMessageSocket","stringify","identifier","students","html","each","i","student","templateContext","picture","name","render","then","append","fail","Notification","exception","count","visible","done","context","jqid","request","methodname","args","uid","call","answer","questionData","value","js","runTemplateJS","notifyFilterContentUpdated","querySelector","LOADING","remove","dispatchEvent","Event","CustomEvent","statistics","scrollTop","scrollHeight","onerror","onclose","send"],"mappings":"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"}