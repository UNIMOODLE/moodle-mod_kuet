{"version":3,"file":"question.min.js","sources":["../src/question.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n// Project implemented by the \"Recovery, Transformation and Resilience Plan.\n// Funded by the European Union - Next GenerationEU\".\n//\n// Produced by the UNIMOODLE University Group: Universities of\n// Valladolid, Complutense de Madrid, UPV/EHU, León, Salamanca,\n// Illes Balears, Valencia, Rey Juan Carlos, La Laguna, Zaragoza, Málaga,\n// Córdoba, Extremadura, Vigo, Las Palmas de Gran Canaria y Burgos\n\n/**\n *\n * @module    mod_jqshow/question\n * @copyright  2023 Proyecto UNIMOODLE\n * @author     UNIMOODLE Group (Coordinator) <direccion.area.estrategia.digital@uva.es>\n * @author     3IPUNT <contacte@tresipunt.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\"use strict\";\n\nimport jQuery from 'jquery';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport mEvent from 'core/event';\nimport ModalFactory from 'core/modal_factory';\n\nlet ACTION = {\n    EXPAND: '[data-action=\"question-fullscreen\"]',\n    COMPRESS: '[data-action=\"question-exit-fullscreen\"]',\n    NEXTQUESTION: '[data-action=\"next-question\"]'\n};\n\nlet REGION = {\n    PAGE_HEADER: '#page-header',\n    BODY: 'body.path-mod-jqshow',\n    NAV: 'nav.navbar',\n    SESSIONCONTENT: '[data-region=\"session-content\"]',\n    QUESTIONCONTENT: '[data-region=\"question-content\"]',\n    RANKINGCONTENT: '[data-region=\"ranking-content\"]',\n};\n\nlet SERVICES = {\n    NEXTQUESTION: 'mod_jqshow_nextquestion',\n    GETSESSIONCONFIG: 'mod_jqshow_getsession',\n    GETPROVISIONALRANKING: 'mod_jqshow_getprovisionalranking',\n    GETFINALRANKING: 'mod_jqshow_getfinalranking',\n};\n\nlet TEMPLATES = {\n    LOADING: 'core/overlay_loading',\n    QUESTION: 'mod_jqshow/questions/encasement',\n    PROVISIONALRANKING: 'mod_jqshow/ranking/provisional'\n};\n\nlet cmId;\nlet sId;\nlet jqId;\nlet isRanking = false;\n\n/**\n * @constructor\n * @param {String} selector\n */\nfunction Question(selector) {\n    this.node = jQuery(selector);\n    if (this.node.attr('data-region') === 'ranking-content') {\n        isRanking = true;\n    }\n    this.initQuestion();\n}\n\n/** @type {jQuery} The jQuery node for the page region. */\nQuestion.prototype.node = null;\n\nQuestion.prototype.initQuestion = function() {\n    sId = this.node.attr('data-sid');\n    cmId = this.node.attr('data-cmid');\n    jqId = this.node.attr('data-jqid');\n    this.node.find(ACTION.EXPAND).on('click', this.fullScreen);\n    this.node.find(ACTION.COMPRESS).on('click', this.exitFullScreen);\n    if (jQuery(REGION.BODY).hasClass('fullscreen')) {\n        jQuery(ACTION.EXPAND).css('display', 'none');\n        jQuery(ACTION.COMPRESS).css('display', 'block');\n    } else {\n        jQuery(ACTION.EXPAND).css('display', 'block');\n        jQuery(ACTION.COMPRESS).css('display', 'none');\n    }\n    jQuery(ACTION.NEXTQUESTION).on('click', this.nextQuestion);\n    jQuery(document).keyup(function(e) {\n        if (e.key === 'Escape' || e.key === 27 || e.key === 'F11' || e.keyCode === 122) {\n            if (jQuery(REGION.BODY).hasClass('fullscreen')) {\n                Question.prototype.exitFullScreen();\n            } else {\n                Question.prototype.fullScreen();\n            }\n        }\n    });\n    addEventListener('questionEnd', () => {\n        jQuery(ACTION.NEXTQUESTION).removeClass('d-none');\n    }, false);\n};\n\nQuestion.prototype.fullScreen = function() {\n    jQuery(ACTION.EXPAND).css('display', 'none');\n    jQuery(ACTION.COMPRESS).css('display', 'block');\n    jQuery(REGION.BODY).addClass('fullscreen');\n    jQuery(window).scrollTop(0);\n    jQuery('html, body').animate({scrollTop: 0}, 500);\n};\n\nQuestion.prototype.exitFullScreen = function() {\n    jQuery(ACTION.EXPAND).css('display', 'block');\n    jQuery(ACTION.COMPRESS).css('display', 'none');\n    jQuery(REGION.BODY).removeClass('fullscreen');\n};\n\nQuestion.prototype.nextQuestion = function(e) { // Only for programed modes, not used by sockets.\n    e.preventDefault();\n    e.stopPropagation();\n    let identifier = jQuery(REGION.SESSIONCONTENT);\n    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n        identifier.append(html);\n        let requestConfig = {\n            methodname: SERVICES.GETSESSIONCONFIG,\n            args: {\n                sid: sId,\n                cmid: cmId\n            }\n        };\n        Ajax.call([requestConfig])[0].done(function(sessionConfig) {\n            if (sessionConfig.session.showgraderanking === 1 && isRanking === false) { // Provisional Ranking.\n                let requestProvisional = {\n                    methodname: SERVICES.GETPROVISIONALRANKING,\n                    args: {\n                        sid: sId,\n                        cmid: cmId,\n                        jqid: jqId\n                    }\n                };\n                Ajax.call([requestProvisional])[0].done(function(provisionalRanking) {\n                    provisionalRanking.programmedmode = true;\n                    Templates.render(TEMPLATES.PROVISIONALRANKING, provisionalRanking).then(function(html, js) {\n                        identifier.html(html);\n                        Templates.runTemplateJS(js);\n                        jQuery(REGION.LOADING).remove();\n                    }).fail(Notification.exception);\n                }).fail(Notification.exception);\n            } else {\n                let requestNext = {\n                    methodname: SERVICES.NEXTQUESTION,\n                    args: {\n                        cmid: cmId,\n                        sessionid: sId,\n                        jqid: jqId,\n                        manual: false\n                    }\n                };\n                Ajax.call([requestNext])[0].done(function(nextQuestion) {\n                    isRanking = false;\n                    let templateQuestions = TEMPLATES.QUESTION;\n                    if (nextQuestion.endsession === true && sessionConfig.session.showfinalgrade === 1) { // Final Ranking.\n                        let requestFinal = {\n                            methodname: SERVICES.GETFINALRANKING,\n                            args: {\n                                sid: sId,\n                                cmid: cmId\n                            }\n                        };\n                        Ajax.call([requestFinal])[0].done(function(finalRanking) {\n                            finalRanking.programmedmode = true;\n                            Templates.render(TEMPLATES.QUESTION, finalRanking).then(function(html, js) {\n                                identifier.html(html);\n                                Templates.runTemplateJS(js);\n                                jQuery(REGION.LOADING).remove();\n                            }).fail(Notification.exception);\n                        }).fail(Notification.exception);\n                    } else { // Normal Question.\n                        Templates.render(templateQuestions, nextQuestion).then(function(html, js) {\n                            identifier.html(html);\n                            Templates.runTemplateJS(js);\n                            mEvent.notifyFilterContentUpdated(document.querySelector(REGION.SESSIONCONTENT));\n                            jQuery(REGION.LOADING).remove();\n                        }).fail(Notification.exception);\n                    }\n                }).fail(async (e) =>  {\n                    if (e.message && e.link) {\n                        const modal = await ModalFactory.create({\n                            title: 'JQSHOW',\n                            body: Templates.render('mod_jqshow/error_modal', {message: e.message, link: e.link})\n                        });\n                        modal.getRoot().css('z-index', '3000');\n                        modal.show();\n                    }\n                });\n            }\n        }).fail(Notification.exception);\n    });\n};\n\nexport const initQuestion = (selector) => {\n    return new Question(selector);\n};\n"],"names":["cmId","sId","jqId","ACTION","REGION","PAGE_HEADER","BODY","NAV","SESSIONCONTENT","QUESTIONCONTENT","RANKINGCONTENT","SERVICES","TEMPLATES","isRanking","Question","selector","node","this","attr","initQuestion","prototype","find","on","fullScreen","exitFullScreen","hasClass","css","nextQuestion","document","keyup","e","key","keyCode","addEventListener","removeClass","addClass","window","scrollTop","animate","preventDefault","stopPropagation","identifier","render","visible","done","html","append","requestConfig","methodname","args","sid","cmid","call","sessionConfig","session","showgraderanking","requestProvisional","jqid","provisionalRanking","programmedmode","then","js","runTemplateJS","LOADING","remove","fail","Notification","exception","requestNext","sessionid","manual","templateQuestions","endsession","showfinalgrade","requestFinal","finalRanking","notifyFilterContentUpdated","querySelector","async","message","link","modal","ModalFactory","create","title","body","Templates","getRoot","show"],"mappings":"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"}