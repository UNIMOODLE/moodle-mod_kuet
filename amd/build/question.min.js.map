{"version":3,"file":"question.min.js","sources":["../src/question.js"],"sourcesContent":["\"use strict\";\r\n\r\nimport jQuery from 'jquery';\r\nimport Ajax from 'core/ajax';\r\nimport Templates from 'core/templates';\r\nimport Notification from 'core/notification';\r\nimport mEvent from 'core/event';\r\n\r\nlet ACTION = {\r\n    EXPAND: '[data-action=\"question-fullscreen\"]',\r\n    COMPRESS: '[data-action=\"question-exit-fullscreen\"]',\r\n    NEXTQUESTION: '[data-action=\"next-question\"]'\r\n};\r\n\r\nlet REGION = {\r\n    PAGE_HEADER: '#page-header',\r\n    BODY: 'body.path-mod-jqshow',\r\n    NAV: 'nav.navbar',\r\n    SESSIONCONTENT: '[data-region=\"session-content\"]',\r\n    QUESTIONCONTENT: '[data-region=\"question-content\"]',\r\n    RANKINGCONTENT: '[data-region=\"ranking-content\"]',\r\n};\r\n\r\nlet SERVICES = {\r\n    NEXTQUESTION: 'mod_jqshow_nextquestion',\r\n    GETSESSIONCONFIG: 'mod_jqshow_getsession',\r\n    GETPROVISIONALRANKING: 'mod_jqshow_getprovisionalranking',\r\n    GETFINALRANKING: 'mod_jqshow_getfinalranking',\r\n};\r\n\r\nlet TEMPLATES = {\r\n    LOADING: 'core/overlay_loading',\r\n    QUESTION: 'mod_jqshow/questions/encasement',\r\n    PROVISIONALRANKING: 'mod_jqshow/ranking/provisional'\r\n};\r\n\r\nlet cmId;\r\nlet sId;\r\nlet jqId;\r\nlet isRanking = false;\r\n\r\n/**\r\n * @constructor\r\n * @param {String} selector\r\n */\r\nfunction Question(selector) {\r\n    this.node = jQuery(selector);\r\n    if (this.node.attr('data-region') === 'ranking-content') {\r\n        isRanking = true;\r\n    }\r\n    this.initQuestion();\r\n}\r\n\r\n/** @type {jQuery} The jQuery node for the page region. */\r\nQuestion.prototype.node = null;\r\n\r\nQuestion.prototype.initQuestion = function() {\r\n    sId = this.node.attr('data-sid');\r\n    cmId = this.node.attr('data-cmid');\r\n    jqId = this.node.attr('data-jqid');\r\n    this.node.find(ACTION.EXPAND).on('click', this.fullScreen);\r\n    this.node.find(ACTION.COMPRESS).on('click', this.exitFullScreen);\r\n    jQuery(ACTION.NEXTQUESTION).on('click', this.nextQuestion);\r\n    let that = this;\r\n    jQuery(document).keyup(function(e) {\r\n        if (e.key === 'Escape') {\r\n            that.exitFullScreen();\r\n        }\r\n    });\r\n    addEventListener('questionEnd', () => {\r\n        // TODO this button is only for programmed mode, in manual mode the teacher controls.\r\n        jQuery(ACTION.NEXTQUESTION).removeClass('d-none');\r\n    }, false);\r\n};\r\n\r\nQuestion.prototype.fullScreen = function(e) {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    jQuery(ACTION.EXPAND).css('display', 'none');\r\n    jQuery(ACTION.COMPRESS).css('display', 'block');\r\n    jQuery(REGION.BODY).addClass('fullscreen');\r\n    jQuery(window).scrollTop(0);\r\n    jQuery('html, body').animate({scrollTop: 0}, 500);\r\n    let element = document.getElementById(\"page-mod-jqshow-view\");\r\n    if (element === undefined || element === null) {\r\n        element = document.getElementById(\"page-mod-jqshow-preview\");\r\n    }\r\n    if (element.requestFullscreen) {\r\n        element.requestFullscreen();\r\n    } else if (element.webkitRequestFullscreen) { /* Safari */\r\n        element.webkitRequestFullscreen();\r\n    } else if (element.msRequestFullscreen) { /* IE11 */\r\n        element.msRequestFullscreen();\r\n    }\r\n};\r\n\r\nQuestion.prototype.exitFullScreen = function() {\r\n    jQuery(ACTION.EXPAND).css('display', 'block');\r\n    jQuery(ACTION.COMPRESS).css('display', 'none');\r\n    jQuery(REGION.BODY).removeClass('fullscreen');\r\n    if (document.fullscreen) {\r\n        document.exitFullscreen();\r\n    }\r\n};\r\n\r\nQuestion.prototype.nextQuestion = function(e) { // Only for programed modes, not used by sockets.\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    let identifier = jQuery(REGION.SESSIONCONTENT);\r\n    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\r\n        identifier.append(html);\r\n        // eslint-disable-next-line no-console\r\n        console.log('isRanking', isRanking);\r\n        let requestConfig = {\r\n            methodname: SERVICES.GETSESSIONCONFIG,\r\n            args: {\r\n                sid: sId,\r\n                cmid: cmId\r\n            }\r\n        };\r\n        Ajax.call([requestConfig])[0].done(function(sessionConfig) {\r\n            if (sessionConfig.session.showgraderanking === 1 && isRanking === false) { // Provisional Ranking.\r\n                let requestProvisional = {\r\n                    methodname: SERVICES.GETPROVISIONALRANKING,\r\n                    args: {\r\n                        sid: sId,\r\n                        cmid: cmId,\r\n                        jqid: jqId\r\n                    }\r\n                };\r\n                Ajax.call([requestProvisional])[0].done(function(provisionalRanking) {\r\n                    provisionalRanking.programmedmode = true;\r\n                    Templates.render(TEMPLATES.PROVISIONALRANKING, provisionalRanking).then(function(html, js) {\r\n                        identifier.html(html);\r\n                        Templates.runTemplateJS(js);\r\n                        jQuery(REGION.LOADING).remove();\r\n                    }).fail(Notification.exception);\r\n                }).fail(Notification.exception);\r\n            } else {\r\n                let requestNext = {\r\n                    methodname: SERVICES.NEXTQUESTION,\r\n                    args: {\r\n                        cmid: cmId,\r\n                        sessionid: sId,\r\n                        jqid: jqId,\r\n                        manual: false\r\n                    }\r\n                };\r\n                Ajax.call([requestNext])[0].done(function(nextQuestion) {\r\n                    isRanking = false;\r\n                    let templateQuestions = TEMPLATES.QUESTION;\r\n                    if (nextQuestion.endsession === true && sessionConfig.session.showfinalgrade === 1) { // Final Ranking.\r\n                        let requestFinal = {\r\n                            methodname: SERVICES.GETFINALRANKING,\r\n                            args: {\r\n                                sid: sId,\r\n                                cmid: cmId\r\n                            }\r\n                        };\r\n                        Ajax.call([requestFinal])[0].done(function(finalRanking) {\r\n                            finalRanking.programmedmode = true;\r\n                            Templates.render(TEMPLATES.QUESTION, finalRanking).then(function(html, js) {\r\n                                identifier.html(html);\r\n                                Templates.runTemplateJS(js);\r\n                                jQuery(REGION.LOADING).remove();\r\n                            }).fail(Notification.exception);\r\n                        }).fail(Notification.exception);\r\n                    } else { // Normal Question.\r\n                        Templates.render(templateQuestions, nextQuestion).then(function(html, js) {\r\n                            identifier.html(html);\r\n                            Templates.runTemplateJS(js);\r\n                            mEvent.notifyFilterContentUpdated(document.querySelector(REGION.SESSIONCONTENT));\r\n                            jQuery(REGION.LOADING).remove();\r\n                        }).fail(Notification.exception);\r\n                    }\r\n                }).fail(Notification.exception);\r\n            }\r\n        }).fail(Notification.exception);\r\n    });\r\n};\r\n\r\nexport const initQuestion = (selector) => {\r\n    return new Question(selector);\r\n};\r\n"],"names":["cmId","sId","jqId","ACTION","REGION","PAGE_HEADER","BODY","NAV","SESSIONCONTENT","QUESTIONCONTENT","RANKINGCONTENT","SERVICES","TEMPLATES","isRanking","Question","selector","node","this","attr","initQuestion","prototype","find","on","fullScreen","exitFullScreen","nextQuestion","that","document","keyup","e","key","addEventListener","removeClass","preventDefault","stopPropagation","css","addClass","window","scrollTop","animate","element","getElementById","requestFullscreen","webkitRequestFullscreen","msRequestFullscreen","fullscreen","exitFullscreen","identifier","render","visible","done","html","append","console","log","requestConfig","methodname","args","sid","cmid","call","sessionConfig","session","showgraderanking","requestProvisional","jqid","provisionalRanking","programmedmode","then","js","runTemplateJS","LOADING","remove","fail","Notification","exception","requestNext","sessionid","manual","templateQuestions","endsession","showfinalgrade","requestFinal","finalRanking","notifyFilterContentUpdated","querySelector"],"mappings":"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"}