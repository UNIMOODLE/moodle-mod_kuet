{"version":3,"file":"question.min.js","sources":["../src/question.js"],"sourcesContent":["\"use strict\";\n\nimport jQuery from 'jquery';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport mEvent from 'core/event';\n\nlet ACTION = {\n    EXPAND: '[data-action=\"question-fullscreen\"]',\n    COMPRESS: '[data-action=\"question-exit-fullscreen\"]',\n    NEXTQUESTION: '[data-action=\"next-question\"]'\n};\n\nlet REGION = {\n    PAGE_HEADER: '#page-header',\n    BODY: 'body.path-mod-jqshow',\n    NAV: 'nav.navbar',\n    SESSIONCONTENT: '[data-region=\"session-content\"]',\n    QUESTIONCONTENT: '[data-region=\"question-content\"]',\n    RANKINGCONTENT: '[data-region=\"ranking-content\"]',\n};\n\nlet SERVICES = {\n    NEXTQUESTION: 'mod_jqshow_nextquestion',\n    GETSESSIONCONFIG: 'mod_jqshow_getsession',\n    GETPROVISIONALRANKING: 'mod_jqshow_getprovisionalranking',\n    GETFINALRANKING: 'mod_jqshow_getfinalranking',\n};\n\nlet TEMPLATES = {\n    LOADING: 'core/overlay_loading',\n    QUESTION: 'mod_jqshow/questions/encasement',\n    PROVISIONALRANKING: 'mod_jqshow/ranking/provisional'\n};\n\nlet cmId;\nlet sId;\nlet jqId;\nlet isRanking = false;\nlet toggleFullScreen = false;\n\n/**\n * @constructor\n * @param {String} selector\n */\nfunction Question(selector) {\n    this.node = jQuery(selector);\n    if (this.node.attr('data-region') === 'ranking-content') {\n        isRanking = true;\n    }\n    this.initQuestion();\n}\n\n/** @type {jQuery} The jQuery node for the page region. */\nQuestion.prototype.node = null;\n\nQuestion.prototype.initQuestion = function() {\n    sId = this.node.attr('data-sid');\n    cmId = this.node.attr('data-cmid');\n    jqId = this.node.attr('data-jqid');\n    this.node.find(ACTION.EXPAND).on('click', this.fullScreen);\n    this.node.find(ACTION.COMPRESS).on('click', this.exitFullScreen);\n    jQuery(ACTION.NEXTQUESTION).on('click', this.nextQuestion);\n    jQuery(document).keyup(function(e) {\n        if (e.key === 'Escape' || e.key === 27) {\n            Question.prototype.exitFullScreen();\n        }\n    });\n    jQuery(document).keydown(function(e) {\n        if (e.key === 'F11' || e.keyCode === 122) {\n            Question.prototype.fullScreen();\n        }\n    });\n    addEventListener('questionEnd', () => {\n        jQuery(ACTION.NEXTQUESTION).removeClass('d-none');\n    }, false);\n};\n\nQuestion.prototype.fullScreen = function() {\n    if (toggleFullScreen === false) {\n        let element = document.getElementById('region-main');\n        if (element.requestFullscreen) {\n            element.requestFullscreen();\n        } else if (element.webkitRequestFullscreen) { /* Safari */\n            element.webkitRequestFullscreen();\n        } else if (element.msRequestFullscreen) { /* IE11 */\n            element.msRequestFullscreen();\n        }\n        jQuery(ACTION.EXPAND).css('display', 'none');\n        jQuery(ACTION.COMPRESS).css('display', 'block');\n        jQuery(REGION.BODY).addClass('fullscreen');\n        jQuery(window).scrollTop(0);\n        jQuery('html, body').animate({scrollTop: 0}, 500);\n        toggleFullScreen = true;\n    }\n};\n\nQuestion.prototype.exitFullScreen = function() {\n    if (toggleFullScreen === true) {\n        if (document.fullscreenElement){\n            document.exitFullscreen();\n        }\n        jQuery(ACTION.EXPAND).css('display', 'block');\n        jQuery(ACTION.COMPRESS).css('display', 'none');\n        jQuery(REGION.BODY).removeClass('fullscreen');\n        toggleFullScreen = false;\n    }\n};\n\nQuestion.prototype.nextQuestion = function(e) { // Only for programed modes, not used by sockets.\n    e.preventDefault();\n    e.stopPropagation();\n    let identifier = jQuery(REGION.SESSIONCONTENT);\n    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n        identifier.append(html);\n        let requestConfig = {\n            methodname: SERVICES.GETSESSIONCONFIG,\n            args: {\n                sid: sId,\n                cmid: cmId\n            }\n        };\n        Ajax.call([requestConfig])[0].done(function(sessionConfig) {\n            if (sessionConfig.session.showgraderanking === 1 && isRanking === false) { // Provisional Ranking.\n                let requestProvisional = {\n                    methodname: SERVICES.GETPROVISIONALRANKING,\n                    args: {\n                        sid: sId,\n                        cmid: cmId,\n                        jqid: jqId\n                    }\n                };\n                Ajax.call([requestProvisional])[0].done(function(provisionalRanking) {\n                    provisionalRanking.programmedmode = true;\n                    Templates.render(TEMPLATES.PROVISIONALRANKING, provisionalRanking).then(function(html, js) {\n                        identifier.html(html);\n                        Templates.runTemplateJS(js);\n                        jQuery(REGION.LOADING).remove();\n                    }).fail(Notification.exception);\n                }).fail(Notification.exception);\n            } else {\n                let requestNext = {\n                    methodname: SERVICES.NEXTQUESTION,\n                    args: {\n                        cmid: cmId,\n                        sessionid: sId,\n                        jqid: jqId,\n                        manual: false\n                    }\n                };\n                Ajax.call([requestNext])[0].done(function(nextQuestion) {\n                    isRanking = false;\n                    let templateQuestions = TEMPLATES.QUESTION;\n                    if (nextQuestion.endsession === true && sessionConfig.session.showfinalgrade === 1) { // Final Ranking.\n                        let requestFinal = {\n                            methodname: SERVICES.GETFINALRANKING,\n                            args: {\n                                sid: sId,\n                                cmid: cmId\n                            }\n                        };\n                        Ajax.call([requestFinal])[0].done(function(finalRanking) {\n                            finalRanking.programmedmode = true;\n                            Templates.render(TEMPLATES.QUESTION, finalRanking).then(function(html, js) {\n                                identifier.html(html);\n                                Templates.runTemplateJS(js);\n                                jQuery(REGION.LOADING).remove();\n                            }).fail(Notification.exception);\n                        }).fail(Notification.exception);\n                    } else { // Normal Question.\n                        Templates.render(templateQuestions, nextQuestion).then(function(html, js) {\n                            identifier.html(html);\n                            Templates.runTemplateJS(js);\n                            mEvent.notifyFilterContentUpdated(document.querySelector(REGION.SESSIONCONTENT));\n                            jQuery(REGION.LOADING).remove();\n                        }).fail(Notification.exception);\n                    }\n                }).fail(Notification.exception);\n            }\n        }).fail(Notification.exception);\n    });\n};\n\nexport const initQuestion = (selector) => {\n    return new Question(selector);\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","Object","defineProperty","_exports","value","initQuestion","_jquery","_ajax","_templates","_notification","_event","cmId","sId","jqId","ACTION","REGION","PAGE_HEADER","BODY","NAV","SESSIONCONTENT","QUESTIONCONTENT","RANKINGCONTENT","SERVICES","TEMPLATES","isRanking","toggleFullScreen","Question","selector","this","node","jQuery","attr","prototype","find","on","fullScreen","exitFullScreen","nextQuestion","document","keyup","e","key","keydown","keyCode","addEventListener","removeClass","element","getElementById","requestFullscreen","webkitRequestFullscreen","msRequestFullscreen","css","addClass","window","scrollTop","animate","fullscreenElement","exitFullscreen","preventDefault","stopPropagation","identifier","Templates","render","visible","done","html","append","requestConfig","methodname","args","sid","cmid","Ajax","call","sessionConfig","session","showgraderanking","requestProvisional","jqid","provisionalRanking","programmedmode","then","js","runTemplateJS","LOADING","remove","fail","Notification","exception","requestNext","sessionid","manual","templateQuestions","endsession","showfinalgrade","requestFinal","finalRanking","mEvent","notifyFilterContentUpdated","querySelector"],"mappings":"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"}