{"version":3,"file":"question.min.js","sources":["../src/question.js"],"sourcesContent":["\"use strict\";\n\nimport jQuery from 'jquery';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport mEvent from 'core/event';\n\nlet ACTION = {\n    EXPAND: '[data-action=\"question-fullscreen\"]',\n    COMPRESS: '[data-action=\"question-exit-fullscreen\"]',\n    NEXTQUESTION: '[data-action=\"next-question\"]'\n};\n\nlet REGION = {\n    PAGE_HEADER: '#page-header',\n    BODY: 'body.path-mod-jqshow',\n    NAV: 'nav.navbar',\n    SESSIONCONTENT: '[data-region=\"session-content\"]',\n    QUESTIONCONTENT: '[data-region=\"question-content\"]',\n    RANKINGCONTENT: '[data-region=\"ranking-content\"]',\n};\n\nlet SERVICES = {\n    NEXTQUESTION: 'mod_jqshow_nextquestion',\n    GETSESSIONCONFIG: 'mod_jqshow_getsession',\n    GETPROVISIONALRANKING: 'mod_jqshow_getprovisionalranking',\n    GETFINALRANKING: 'mod_jqshow_getfinalranking',\n};\n\nlet TEMPLATES = {\n    LOADING: 'core/overlay_loading',\n    QUESTION: 'mod_jqshow/questions/encasement',\n    PROVISIONALRANKING: 'mod_jqshow/ranking/provisional'\n};\n\nlet cmId;\nlet sId;\nlet jqId;\nlet isRanking = false;\n\n/**\n * @constructor\n * @param {String} selector\n */\nfunction Question(selector) {\n    if (selector === REGION.RANKINGCONTENT) {\n        isRanking = true;\n    }\n    this.node = jQuery(selector);\n    this.initQuestion();\n}\n\n/** @type {jQuery} The jQuery node for the page region. */\nQuestion.prototype.node = null;\n\nQuestion.prototype.initQuestion = function() {\n    sId = this.node.attr('data-sid');\n    cmId = this.node.attr('data-cmid');\n    jqId = this.node.attr('data-jqid');\n    this.node.find(ACTION.EXPAND).on('click', this.fullScreen);\n    this.node.find(ACTION.COMPRESS).on('click', this.exitFullScreen);\n    jQuery(ACTION.NEXTQUESTION).on('click', this.nextQuestion);\n    let that = this;\n    jQuery(document).keyup(function(e) {\n        if (e.key === 'Escape') {\n            that.exitFullScreen();\n        }\n    });\n    addEventListener('questionEnd', () => {\n        // TODO this button is only for programmed mode, in manual mode the teacher controls.\n        jQuery(ACTION.NEXTQUESTION).removeClass('d-none');\n    }, false);\n};\n\nQuestion.prototype.fullScreen = function(e) {\n    e.preventDefault();\n    e.stopPropagation();\n    jQuery(ACTION.EXPAND).css('display', 'none');\n    jQuery(ACTION.COMPRESS).css('display', 'block');\n    jQuery(REGION.BODY).addClass('fullscreen');\n    jQuery(window).scrollTop(0);\n    jQuery('html, body').animate({scrollTop: 0}, 500);\n    let element = document.getElementById(\"page-mod-jqshow-view\");\n    if (element === undefined || element === null) {\n        element = document.getElementById(\"page-mod-jqshow-preview\");\n    }\n    if (element.requestFullscreen) {\n        element.requestFullscreen();\n    } else if (element.webkitRequestFullscreen) { /* Safari */\n        element.webkitRequestFullscreen();\n    } else if (element.msRequestFullscreen) { /* IE11 */\n        element.msRequestFullscreen();\n    }\n};\n\nQuestion.prototype.exitFullScreen = function() {\n    jQuery(ACTION.EXPAND).css('display', 'block');\n    jQuery(ACTION.COMPRESS).css('display', 'none');\n    jQuery(REGION.BODY).removeClass('fullscreen');\n    if (document.fullscreen) {\n        document.exitFullscreen();\n    }\n};\n\nQuestion.prototype.nextQuestion = function(e) { // Only for programed modes, not used by sockets.\n    e.preventDefault();\n    e.stopPropagation();\n    let identifier = jQuery(REGION.SESSIONCONTENT);\n    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n        identifier.append(html);\n        let requestNext = {\n            methodname: SERVICES.NEXTQUESTION,\n            args: {\n                cmid: cmId,\n                sessionid: sId,\n                jqid: jqId,\n                manual: false,\n                isranking: isRanking\n            }\n        };\n        Ajax.call([requestNext])[0].done(function(nextQuestion) {\n            let requestConfig = {\n                methodname: SERVICES.GETSESSIONCONFIG,\n                args: {\n                    sid: sId,\n                    cmid: cmId\n                }\n            };\n            Ajax.call([requestConfig])[0].done(function(sessionConfig) {\n                if (nextQuestion.endsession === true && sessionConfig.session.showfinalgrade === 1) { // Final Ranking.\n                    let requestFinal = {\n                        methodname: SERVICES.GETFINALRANKING,\n                        args: {\n                            sid: sId,\n                            cmid: cmId\n                        }\n                    };\n                    Ajax.call([requestFinal])[0].done(function(finalRanking) {\n                        finalRanking.programmedmode = true;\n                        Templates.render(TEMPLATES.QUESTION, finalRanking).then(function(html, js) {\n                            identifier.html(html);\n                            Templates.runTemplateJS(js);\n                            jQuery(REGION.LOADING).remove();\n                        }).fail(Notification.exception);\n                    }).fail(Notification.exception);\n                } else if (sessionConfig.session.showgraderanking === 1 && isRanking === false) { // Provisional Ranking.\n                    let requestProvisional = {\n                        methodname: SERVICES.GETPROVISIONALRANKING,\n                        args: {\n                            sid: sId,\n                            cmid: cmId,\n                            jqid: jqId\n                        }\n                    };\n                    Ajax.call([requestProvisional])[0].done(function(provisionalRanking) {\n                        provisionalRanking.programmedmode = true;\n                        Templates.render(TEMPLATES.PROVISIONALRANKING, provisionalRanking).then(function(html, js) {\n                            identifier.html(html);\n                            Templates.runTemplateJS(js);\n                            jQuery(REGION.LOADING).remove();\n                        }).fail(Notification.exception);\n                    }).fail(Notification.exception);\n                } else { // Normal Question.\n                    isRanking = false;\n                    let templateQuestions = TEMPLATES.QUESTION;\n                    Templates.render(templateQuestions, nextQuestion).then(function(html, js) {\n                        identifier.html(html);\n                        Templates.runTemplateJS(js);\n                        mEvent.notifyFilterContentUpdated(document.querySelector(REGION.SESSIONCONTENT));\n                        jQuery(REGION.LOADING).remove();\n                    }).fail(Notification.exception);\n                }\n            }).fail(Notification.exception);\n        }).fail(Notification.exception);\n    });\n};\n\nexport const initQuestion = (selector) => {\n    return new Question(selector);\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","Object","defineProperty","_exports","value","initQuestion","_jquery","_ajax","_templates","_notification","_event","cmId","sId","jqId","ACTION","REGION","PAGE_HEADER","BODY","NAV","SESSIONCONTENT","QUESTIONCONTENT","RANKINGCONTENT","SERVICES","TEMPLATES","isRanking","Question","selector","this","node","jQuery","prototype","attr","find","on","fullScreen","exitFullScreen","nextQuestion","that","document","keyup","e","key","addEventListener","removeClass","preventDefault","stopPropagation","css","addClass","window","scrollTop","animate","element","getElementById","requestFullscreen","webkitRequestFullscreen","msRequestFullscreen","fullscreen","exitFullscreen","identifier","Templates","render","visible","done","html","append","requestNext","methodname","args","cmid","sessionid","jqid","manual","isranking","Ajax","call","requestConfig","sid","sessionConfig","endsession","session","showfinalgrade","requestFinal","finalRanking","programmedmode","then","js","runTemplateJS","LOADING","remove","fail","Notification","exception","showgraderanking","requestProvisional","provisionalRanking","templateQuestions","mEvent","notifyFilterContentUpdated","querySelector"],"mappings":"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"}