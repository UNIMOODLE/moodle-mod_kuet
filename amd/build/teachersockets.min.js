define("mod_kuet/teachersockets",["exports","jquery","core/templates","core/notification","core/str","core/modal_factory","core/modal_events","core/ajax","mod_kuet/encryptor","mod_kuet/database","core/event"],(function(_exports,_jquery,_templates,_notification,_str,_modal_factory,_modal_events,_ajax,_encryptor,_database,_event){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.teacherInitSockets=void 0,_jquery=_interopRequireDefault(_jquery),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_ajax=_interopRequireDefault(_ajax),_encryptor=_interopRequireDefault(_encryptor),_database=_interopRequireDefault(_database),_event=_interopRequireDefault(_event);let REGION={MESSAGEBOX:"#message-box",USERLIST:'[data-region="active-users"]',COUNTUSERS:"#countusers",TEACHERCANVASCONTENT:'[data-region="teacher-canvas-content"]',TEACHERCANVAS:'[data-region="teacher-canvas"]',TEACHERPANEL:'[data-region="teacher-panel"]',SESSIONCONTROLER:'[data-region="session-controller"]',SESSIONRESUME:'[data-region="session-resume"]',LISTRESULTS:'[data-region="list-results"]',RACERESULTS:'[data-region="race-results"]',SWITCHS:".showhide-action",ESPECIALS:".special-action",VOTEIMPROVISE:".special-action.vote-question",CLOUDTAGS:".cloud",IMPROVISE:'[data-region="teacher-improvise"]',IMPROVISESTATEMENT:".improvise-form #statement",IMPROVISEREPLY:".improvise-form #reply_improvise",TAGSCONTENT:'[data-region="tags-content"]'},ACTION_BACKSESSION='[data-action="back-session"]',ACTION_INITSESSION='[data-action="init-session"]',ACTION_ENDSESSION='[data-action="end-session"]',ACTION_CLOSEIMPROVISE='[data-action="close-improvise"]',ACTION_SUBMITIMPROVISE='[data-action="submit-improvise"]',ACTION_NEXT='[data-action="next"]',ACTION_VOTE='[data-action="vote"]',ACTION_JUMP='[data-action="jump"]',ACTION_FINISHQUESTION='[data-action="finishquestion"]',SERVICES_ACTIVESESSION="mod_kuet_activesession",SERVICES_NEXTQUESTION="mod_kuet_nextquestion",SERVICES_FIRSTQUESTION="mod_kuet_firstquestion",SERVICES_FINISHSESSION="mod_kuet_finishsession",SERVICES_DELETERESPONSES="mod_kuet_deleteresponses",SERVICES_JUMPTOQUESTION="mod_kuet_jumptoquestion",SERVICES_GETSESSIONRESUME="mod_kuet_getsessionresume",SERVICES_GETLISTRESULTS="mod_kuet_getlistresults",SERVICES_GETGROUPLISTRESULTS="mod_kuet_getgrouplistresults",SERVICES_GETQUESTIONSTATISTICS="mod_kuet_getquestionstatistics",SERVICES_GETSESSIONCONFIG="mod_kuet_getsession",SERVICES_GETPROVISIONALRANKING="mod_kuet_getprovisionalranking",SERVICES_GETFINALRANKING="mod_kuet_getfinalranking",SERVICES_GETRACERESULTS="mod_kuet_getraceresults",TEMPLATES_LOADING="core/overlay_loading",TEMPLATES_PARTICIPANT="mod_kuet/session/manual/waitingroom/participant",TEMPLATES_GROUPPARTICIPANT="mod_kuet/session/manual/waitingroom/groupparticipant",TEMPLATES_QUESTION="mod_kuet/questions/encasement",TEMPLATES_SESSIONRESUME="mod_kuet/session/sessionresume",TEMPLATES_LISTRESULTS="mod_kuet/session/listresults",TEMPLATES_PROVISIONALRANKING="mod_kuet/ranking/provisional",socketUrl="",portUrl="8080",userid=null,usersocketid=null,username=null,userimage=null,messageBox=null,countusers=null,cmid=null,sid=null,db=null,questionsKids=[],waitingRoom=!0,currentQuestionKqid=null,nextQuestionKqid=null,sessionMode=null,showRankingBetweenQuestions=!1,showRankingBetweenQuestionsSwitch=!1,showRankingFinal=!1,groupMode=!1,currentQuestionDataForRace={},cloudTags=[],voting=!1;function Sockets(region,socketurl,port,sessionmode,groupmode){switch(this.root=(0,_jquery.default)(region),socketUrl=socketurl,portUrl=port,userid=this.root[0].dataset.userid,username=this.root[0].dataset.username,userimage=this.root[0].dataset.userimage,cmid=this.root[0].dataset.cmid,sid=this.root[0].dataset.sid,messageBox=this.root.find(REGION.MESSAGEBOX),countusers=this.root.find(REGION.COUNTUSERS),groupMode=groupmode,sessionMode=sessionmode,sessionMode){case"inactive_manual":default:showRankingBetweenQuestions=!1,showRankingBetweenQuestionsSwitch=!1,showRankingFinal=!1;break;case"podium_manual":case"race_manual":{let request={methodname:SERVICES_GETSESSIONCONFIG,args:{sid:sid,cmid:cmid}};_ajax.default.call([request])[0].done((function(response){1===response.session.showgraderanking&&(showRankingBetweenQuestions=!0),1===response.session.showfinalgrade&&(showRankingFinal=!0)})).fail(_notification.default.exception);break}}this.measuringSpeed(),this.disableDevTools(),this.initSockets().then((()=>{this.cleanMessages(),this.initListeners()}))}Sockets.prototype.cleanMessages=function(){setInterval((function(){messageBox.find(":first-child").remove()}),1e4)},Sockets.prototype.disableDevTools=function(){document.addEventListener("contextmenu",(e=>e.preventDefault())),document.onkeydown=e=>!(123===event.keyCode||this.ctrlShiftKey(e,"I")||this.ctrlShiftKey(e,"J")||this.ctrlShiftKey(e,"C")||e.ctrlKey&&e.keyCode==="U".charCodeAt(0))},Sockets.prototype.ctrlShiftKey=function(e,keyCode){return e.ctrlKey&&e.shiftKey&&e.keyCode===keyCode.charCodeAt(0)},Sockets.prototype.measuringSpeed=function(){let connection=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(connection){let typeConnection=connection.effectiveType,speedMbps=connection.downlink;if(console.log("Type of Connection: "+typeConnection,"Estimated speed: "+speedMbps+" Mbps"),speedMbps<1){let reason={effectiveType:connection.effectiveType,downlink:connection.downlink};(0,_str.get_string)("lowspeed","mod_kuet",reason).done((s=>{messageBox.append('<div class="alert alert-danger" role="alert">'+s+"</div>")}))}}else console.error("Connection speed detection is not supported in this browser.")},Sockets.prototype.backSession=function(){(0,_str.get_strings)([{key:"backtopanelfromsession",component:"mod_kuet"},{key:"backtopanelfromsession_desc",component:"mod_kuet"},{key:"confirm",component:"mod_kuet"}]).then((langStrings=>_modal_factory.default.create({title:langStrings[0],body:langStrings[1],type:_modal_factory.default.types.SAVE_CANCEL}).then((modal=>(modal.setSaveButtonText(langStrings[2]),modal.getRoot().on(_modal_events.default.save,(()=>{let request={methodname:SERVICES_ACTIVESESSION,args:{cmid:cmid,sessionid:sid}};_ajax.default.call([request])[0].done((function(){window.location.replace(M.cfg.wwwroot+"/mod/kuet/view.php?id="+cmid)})).fail(_notification.default.exception)})),modal.getRoot().on(_modal_events.default.hidden,(()=>{modal.destroy()})),modal))))).done((function(modal){modal.show()})).fail(_notification.default.exception)},Sockets.prototype.root=null,Sockets.prototype.initSockets=async function(){let that=this;this.root.find(ACTION_BACKSESSION).on("click",this.backSession),this.root.find(ACTION_CLOSEIMPROVISE).on("click",this.closeImprovise),this.root.find(ACTION_SUBMITIMPROVISE).on("click",this.submitImprovise),db=await _database.default.initDb(sid,userid);let normalizeSocketUrl=Sockets.prototype.normalizeSocketUrl(socketUrl,portUrl),alreadyteacher=!1;Sockets.prototype.webSocket=new WebSocket(normalizeSocketUrl),Sockets.prototype.webSocket.onopen=function(){let request={methodname:SERVICES_FIRSTQUESTION,args:{cmid:cmid,sessionid:sid}};_ajax.default.call([request])[0].done((function(firstquestion){let data={kid:firstquestion.kid,value:firstquestion};db.add("questions",data),questionsKids.push(firstquestion.kid),currentQuestionKqid=firstquestion.kid,that.setCurrentQuestion(firstquestion.kid),that.getNextQuestion(firstquestion.kid),!1===alreadyteacher&&(that.root.find(ACTION_INITSESSION).removeClass("disabled"),that.root.find(ACTION_INITSESSION).on("click",that.initSession),that.root.find(ACTION_ENDSESSION).on("click",that.endSession))})).fail(_notification.default.exception)},Sockets.prototype.webSocket.onmessage=function(ev){let msgDecrypt=_encryptor.default.decrypt(ev.data),response=JSON.parse(msgDecrypt);switch(response.action){case"connect":if(void 0!==response.usersocketid){usersocketid=response.usersocketid;let msg={userid:userid,name:username,pic:userimage,isteacher:!0,cmid:cmid,sid:sid,usersocketid:usersocketid,action:"newuser"};Sockets.prototype.sendMessageSocket(JSON.stringify(msg))}break;case"newuser":{let identifier=(0,_jquery.default)(REGION.USERLIST),data=response.students;identifier.html(""),!1===waitingRoom&&Sockets.prototype.normalizeUser(response.usersocketid),_jquery.default.each(data,(function(i,student){let templateContext={usersocketid:student.usersocketid,userimage:student.picture,userfullname:student.name};_templates.default.render(TEMPLATES_PARTICIPANT,templateContext).then((function(html){identifier.append(html)})).fail(_notification.default.exception)})),countusers.html(response.count);break}case"newgroup":{let participantshtml=(0,_jquery.default)(REGION.USERLIST),grouplist=response.groups;participantshtml.html(""),_jquery.default.each(grouplist,(function(i,group){let templateContext={usersocketid:group.usersocketid,groupimage:group.picture,groupid:group.groupid,name:group.name,numgroupusers:group.numgroupusers};_templates.default.render(TEMPLATES_GROUPPARTICIPANT,templateContext).then((function(html){participantshtml.append(html)})).fail(_notification.default.exception)})),countusers.html(response.count);break}case"countusers":countusers.html(response.count);break;case"studentQuestionEnd":"race_manual"===sessionMode&&Sockets.prototype.raceResults();break;case"userdisconnected":"1"!=groupMode&&((0,_jquery.default)('[data-userid="'+response.usersocketid+'"]').remove(),countusers.html(response.count)),messageBox.append("<div>"+response.message+"</div>");break;case"groupdisconnected":(0,_jquery.default)(".participants").find('[data-groupid="'+response.groupid+'"]').remove(),countusers.html(response.count),messageBox.append("<div>"+response.message+"</div>");break;case"groupmemberdisconnected":(0,_jquery.default)(".participants").find('[data-groupid="'+response.groupid+'"]').find(".numgroupusers").html("("+response.count+")"),messageBox.append("<div>"+response.message+"</div>");break;case"alreadyteacher":messageBox.append('<div class="alert alert-danger" role="alert">'+response.message+"</div>"),alreadyteacher=!0,(0,_jquery.default)(ACTION_INITSESSION).addClass("disabled");break;case"pauseQuestion":dispatchEvent(new Event("pauseQuestion_"+response.kid));break;case"playQuestion":dispatchEvent(new Event("playQuestion_"+response.kid));break;case"showAnswers":dispatchEvent(new Event("showAnswers_"+response.kid));break;case"hideAnswers":dispatchEvent(new Event("hideAnswers_"+response.kid));break;case"showStatistics":dispatchEvent(new Event("showStatistics_"+response.kid));break;case"hideStatistics":dispatchEvent(new Event("hideStatistics_"+response.kid));break;case"showFeedback":dispatchEvent(new Event("showFeedback_"+response.kid));break;case"hideFeedback":dispatchEvent(new Event("hideFeedback_"+response.kid));break;case"ImproviseStudentTag":Sockets.prototype.manageCloudTags(response.improvisereply),Sockets.prototype.printNewTag();break;case"StudentVotedTag":!0===voting&&(Sockets.prototype.manageTagsVotes(response.votedtag),Sockets.prototype.printNewTag())}messageBox[0].scrollTop=messageBox[0].scrollHeight},Sockets.prototype.webSocket.onerror=function(){(0,_str.get_string)("system_error","mod_kuet").done((s=>{messageBox.append('<div class="alert alert-danger" role="alert">'+s+"</div>")})),that.root.find(ACTION_INITSESSION).addClass("disabled"),that.root.find(ACTION_INITSESSION).off("click"),that.root.find(ACTION_ENDSESSION).off("click")},Sockets.prototype.webSocket.onclose=function(ev){let reason={reason:ev.reason,code:ev.code};(0,_str.get_string)("connection_closed","mod_kuet",reason).done((s=>{(0,_jquery.default)(REGION.TEACHERCANVASCONTENT).prepend('<div class="alert alert-danger" role="alert">'+s+"</div>")})),that.root.find(ACTION_INITSESSION).addClass("disabled"),that.root.find(ACTION_INITSESSION).off("click"),that.root.find(ACTION_ENDSESSION).off("click")}},Sockets.prototype.normalizeSocketUrl=function(socketUrl,port){let jsUrl=new URL(socketUrl);return"https:"===jsUrl.protocol?(jsUrl.port=port,jsUrl.protocol="wss:","/"===jsUrl.pathname?jsUrl.pathname=jsUrl.pathname+"kuet":jsUrl.pathname=jsUrl.pathname+"/kuet",jsUrl.toString()):((0,_str.get_strings)([{key:"httpsrequired",component:"mod_kuet"}]).done((function(strings){messageBox=this.root.find("#testresult"),messageBox.append('<div class="alert alert-danger" role="alert">'+strings[0]+"</div>")})).fail(_notification.default.exception),"")},Sockets.prototype.initListeners=function(){let that=this;addEventListener("nextQuestion",(()=>{switch(sessionMode){case"inactive_programmed":case"inactive_manual":default:that.nextQuestion();break;case"podium_manual":case"podium_programmed":case"race_manual":case"race_programmed":that.manageNext()}cloudTags=[],voting=!1}),!1),addEventListener("pauseQuestionSelf",(()=>{that.pauseQuestion()}),!1),addEventListener("playQuestionSelf",(()=>{that.playQuestion()}),!1),addEventListener("resendSelf",(()=>{that.resendSelf()}),!1),addEventListener("jumpTo",(e=>{that.jumpTo(e.detail.jumpTo)}),!1),addEventListener("teacherQuestionEndSelf",(()=>{"race_manual"===sessionMode?(currentQuestionDataForRace.isteacher=!0,_templates.default.render(TEMPLATES_QUESTION,currentQuestionDataForRace).then((function(html,js){(0,_jquery.default)(REGION.TEACHERCANVAS).html(html),_templates.default.runTemplateJS(js),(0,_jquery.default)(REGION.SWITCHS).removeClass("disabled"),(0,_jquery.default)(REGION.ESPECIALS).removeClass("disabled"),setTimeout((()=>{that.questionEnd(),(0,_jquery.default)(REGION.SWITCHS).removeClass("disabled"),(0,_jquery.default)(REGION.IMPROVISE).removeClass("disabled"),(0,_jquery.default)(ACTION_FINISHQUESTION).addClass("d-none"),(0,_jquery.default)(ACTION_NEXT).removeClass("d-none"),(0,_jquery.default)(ACTION_VOTE).addClass("disabled"),(0,_jquery.default)(ACTION_JUMP).addClass("disabled"),_event.default.notifyFilterContentUpdated(document.querySelector(REGION.TEACHERCANVAS))}),300)})).fail(_notification.default.exception)):that.questionEnd(),cloudTags=[]}),!1),addEventListener("showAnswersSelf",(()=>{that.showAnswers()}),!1),addEventListener("hideAnswersSelf",(()=>{that.hideAnswers()}),!1),addEventListener("showStatisticsSelf",(()=>{that.showStatistics()}),!1),addEventListener("hideStatisticsSelf",(()=>{that.hideStatistics()}),!1),addEventListener("showFeedbackSelf",(()=>{that.showFeedback()}),!1),addEventListener("hideFeedbackSelf",(()=>{that.hideFeedback()}),!1),addEventListener("endSession",(()=>{that.endSession()}),{once:!0}),addEventListener("improvise",(()=>{that.improvise()}),!1),addEventListener("initVote",(()=>{that.vote()}),!1)},Sockets.prototype.setCurrentQuestion=function(currentQuestion){let data={state:"currentQuestion",value:currentQuestion};db.update("statequestions",data)},Sockets.prototype.setNextQuestion=function(nextQuestion){let data={state:"nextQuestion",value:nextQuestion};db.update("statequestions",data)},Sockets.prototype.setEndSession=function(endData){db.delete("statequestions","nextQuestion");let data={state:"endSession",value:endData};db.update("statequestions",data),showRankingBetweenQuestionsSwitch=!1},Sockets.prototype.getNextQuestion=function(kid){let that=this,request={methodname:SERVICES_NEXTQUESTION,args:{cmid:cmid,sessionid:sid,kid:kid,manual:!0}};nextQuestionKqid=null,_ajax.default.call([request])[0].done((function(nextquestion){if(!0!==nextquestion.endsession){let data={kid:nextquestion.kid,value:nextquestion};db.add("questions",data),nextQuestionKqid=nextquestion.kid,that.setNextQuestion(nextquestion.kid)}else nextQuestionKqid=null,that.setEndSession(nextquestion)})).fail(_notification.default.exception)},Sockets.prototype.initSession=function(){db.delete("statequestions","endSession");(0,_str.get_strings)([{key:"init_session",component:"mod_kuet"},{key:"init_session_desc",component:"mod_kuet"},{key:"confirm",component:"mod_kuet"},{key:"sessionstarted",component:"mod_kuet"},{key:"sessionstarted_info",component:"mod_kuet"}]).then((langStrings=>_modal_factory.default.create({title:langStrings[0],body:langStrings[1],type:_modal_factory.default.types.SAVE_CANCEL}).then((modal=>(modal.setSaveButtonText(langStrings[2]),modal.getRoot().on(_modal_events.default.save,(()=>{let firstQuestion=db.get("questions",currentQuestionKqid);firstQuestion.onsuccess=function(){let msg={action:"question",sid:sid,context:firstQuestion.result};Sockets.prototype.sendMessageSocket(JSON.stringify(msg)),_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){Sockets.prototype.initPanel();let identifier=(0,_jquery.default)(REGION.TEACHERCANVAS);identifier.append(html),currentQuestionKqid=firstQuestion.result.kid,firstQuestion.result.value.isteacher=!0,currentQuestionDataForRace=firstQuestion.result.value,"podium_manual"!==sessionMode&&"inactive_manual"!==sessionMode||_templates.default.render(TEMPLATES_QUESTION,firstQuestion.result.value).then((function(html,js){identifier.html(html),_templates.default.runTemplateJS(js),(0,_jquery.default)(REGION.LOADING).remove(),_event.default.notifyFilterContentUpdated(document.querySelector(REGION.TEACHERCANVAS))})).fail(_notification.default.exception),"race_manual"===sessionMode&&Sockets.prototype.raceResults(),(0,_jquery.default)(REGION.TEACHERCANVASCONTENT).find(".content-title h2").html(langStrings[3]),(0,_jquery.default)(REGION.TEACHERCANVASCONTENT).find(".content-title small").html(langStrings[4]),(0,_jquery.default)(ACTION_BACKSESSION).remove(),(0,_jquery.default)(ACTION_INITSESSION).remove(),(0,_jquery.default)(ACTION_ENDSESSION).removeClass("hidden").removeClass("disabled"),waitingRoom=!1,showRankingBetweenQuestions&&(showRankingBetweenQuestionsSwitch=!0)}))}})),modal.getRoot().on(_modal_events.default.hidden,(()=>{modal.destroy()})),modal))))).done((function(modal){modal.show()})).fail(_notification.default.exception)},Sockets.prototype.initPanel=function(){let requestResume={methodname:SERVICES_GETSESSIONRESUME,args:{sid:sid,cmid:cmid}};_ajax.default.call([requestResume])[0].done((function(responseResume){_templates.default.render(TEMPLATES_SESSIONRESUME,responseResume).then((function(html){(0,_jquery.default)(REGION.SESSIONRESUME).append(html)}))}));let methodname=SERVICES_GETLISTRESULTS;!0===groupMode&&(methodname=SERVICES_GETGROUPLISTRESULTS),setInterval((function(){let requestResults={methodname:methodname,args:{sid:sid,cmid:cmid}};_ajax.default.call([requestResults])[0].done((function(responseResults){_templates.default.render(TEMPLATES_LISTRESULTS,responseResults).then((function(html){(0,_jquery.default)(REGION.LISTRESULTS).html(html)}))}))}),2e4),(0,_jquery.default)(REGION.TEACHERPANEL).removeClass("d-none")},Sockets.prototype.endSession=function(){(0,_str.get_strings)([{key:"end_session",component:"mod_kuet"},{key:"end_session_manual_desc",component:"mod_kuet"},{key:"confirm",component:"mod_kuet"},{key:"end_session_error",component:"mod_kuet"}]).then((langStrings=>_modal_factory.default.create({title:langStrings[0],body:langStrings[1],type:_modal_factory.default.types.SAVE_CANCEL}).then((modal=>(modal.setSaveButtonText(langStrings[2]),modal.getRoot().on(_modal_events.default.save,(()=>{let request={methodname:SERVICES_FINISHSESSION,args:{cmid:cmid,sessionid:sid}};_ajax.default.call([request])[0].done((function(response){if(!0===response.finished){let deleteDb=db.deleteDatabase();deleteDb.onerror=function(event){console.error("Error deleting database.",event)},deleteDb.onsuccess=function(){window.location.replace(M.cfg.wwwroot+"/mod/kuet/view.php?id="+cmid)}}else _notification.default.alert("Error",langStrings[3],langStrings[2])})).fail(_notification.default.exception)})),modal.getRoot().on(_modal_events.default.hidden,(()=>{modal.destroy()})),modal))))).done((function(modal){modal.show()})).fail(_notification.default.exception)},Sockets.prototype.nextQuestion=function(){let that=this;null===nextQuestionKqid&&this.getNextQuestion(currentQuestionKqid);let nextQuestion=db.get("statequestions","nextQuestion");nextQuestion.onsuccess=function(){if(void 0!==nextQuestion.result){let nextQuestionData=db.get("questions",nextQuestion.result.value);nextQuestionData.onsuccess=function(){let msg={action:"question",sid:sid,context:nextQuestionData.result};currentQuestionDataForRace=nextQuestionData.result.value,Sockets.prototype.sendMessageSocket(JSON.stringify(msg));let removeEvents=new CustomEvent("removeEvents");dispatchEvent(removeEvents),_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){let identifier=(0,_jquery.default)(REGION.TEACHERCANVAS);identifier.append(html),currentQuestionKqid=nextQuestionData.result.kid,that.setCurrentQuestion(nextQuestionData.result.kid),that.getNextQuestion(nextQuestionData.result.kid),"podium_manual"!==sessionMode&&"inactive_manual"!==sessionMode||(nextQuestionData.result.value.isteacher=!0,_templates.default.render(TEMPLATES_QUESTION,nextQuestionData.result.value).then((function(html,js){identifier.html(html),_templates.default.runTemplateJS(js),_event.default.notifyFilterContentUpdated(document.querySelector(REGION.TEACHERCANVAS)),(0,_jquery.default)(REGION.LOADING).remove()})).fail(_notification.default.exception)),"race_manual"===sessionMode&&Sockets.prototype.raceResults()}))}}else{let endSession=db.get("statequestions","endSession");endSession.onsuccess=!1===showRankingFinal?function(){let msg={action:"endSession",sid:sid,context:endSession.result};Sockets.prototype.sendMessageSocket(JSON.stringify(msg)),_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){let identifier=(0,_jquery.default)(REGION.TEACHERCANVAS);identifier.append(html),currentQuestionKqid=null,db.delete("statequestions","currentQuestion"),that.setEndSession(endSession.result),endSession.result.value.isteacher=!0,_templates.default.render(TEMPLATES_QUESTION,endSession.result.value).then((function(html,js){identifier.html(html),_templates.default.runTemplateJS(js),(0,_jquery.default)(REGION.LOADING).remove()})).fail(_notification.default.exception)}))}:function(){let request={methodname:SERVICES_GETFINALRANKING,args:{sid:sid,cmid:cmid}};_ajax.default.call([request])[0].done((function(finalRanking){endSession.result.value=finalRanking;let msg={action:"endSession",sid:sid,context:endSession.result};Sockets.prototype.sendMessageSocket(JSON.stringify(msg)),_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){let identifier=(0,_jquery.default)(REGION.TEACHERCANVAS);identifier.append(html),currentQuestionKqid=null,db.delete("statequestions","currentQuestion"),that.setEndSession(endSession.result),endSession.result.value.isteacher=!0,_templates.default.render(TEMPLATES_QUESTION,endSession.result.value).then((function(html,js){identifier.html(html),_templates.default.runTemplateJS(js),(0,_jquery.default)(REGION.LOADING).remove()})).fail(_notification.default.exception)}))})).fail(_notification.default.exception)}}}},Sockets.prototype.raceResults=function(){let identifier=(0,_jquery.default)(REGION.TEACHERCANVAS),request={methodname:SERVICES_GETRACERESULTS,args:{sid:sid,cmid:cmid}};_ajax.default.call([request])[0].done((function(response){response.raceresults=!0,response.isteacher=!0,response.programmedmode=!1,response.sessionprogress=currentQuestionDataForRace.sessionprogress,response.question_index_string=currentQuestionDataForRace.question_index_string,response.numquestions=currentQuestionDataForRace.numquestions,_templates.default.render(TEMPLATES_QUESTION,response).then(((html,js)=>{let scrollUsersTop=0,scrollQuestionsLeft=0;null!==document.querySelector("#content-users")&&(scrollUsersTop=document.querySelector("#content-users").scrollTop,scrollQuestionsLeft=document.querySelector("#questions-list").scrollLeft),identifier.html(html),_templates.default.runTemplateJS(js);let newScrollUsers=document.querySelector("#content-users"),newScrollQuestions=document.querySelector("#questions-list"),scrollUsers=document.querySelector("#content-users"),questions=document.querySelectorAll(".content-responses");scrollUsers.addEventListener("scroll",(function(){questions.forEach((question=>{question.scrollTop=scrollUsers.scrollTop}))}),{passive:!0}),newScrollUsers.scrollTop=scrollUsersTop,newScrollQuestions.scrollLeft=scrollQuestionsLeft})).fail(_notification.default.exception)})).fail(_notification.default.exception)},Sockets.prototype.manageNext=function(){let that=this;if(!1===showRankingBetweenQuestions)that.nextQuestion();else if(!1===showRankingBetweenQuestionsSwitch)that.nextQuestion(),showRankingBetweenQuestionsSwitch=!0;else{let request={methodname:SERVICES_GETPROVISIONALRANKING,args:{sid:sid,cmid:cmid,kid:currentQuestionKqid}};_ajax.default.call([request])[0].done((function(provisionalRanking){let msg={action:"ranking",sid:sid,context:provisionalRanking};Sockets.prototype.sendMessageSocket(JSON.stringify(msg)),showRankingBetweenQuestionsSwitch=!1,_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){let identifier=(0,_jquery.default)(REGION.TEACHERCANVAS);identifier.append(html),provisionalRanking.isteacher=!0,_templates.default.render(TEMPLATES_PROVISIONALRANKING,provisionalRanking).then((function(html,js){identifier.html(html),_templates.default.runTemplateJS(js),(0,_jquery.default)(REGION.LOADING).remove()})).fail(_notification.default.exception)}))})).fail(_notification.default.exception)}},Sockets.prototype.pauseQuestion=function(){let msg={action:"pauseQuestion",sid:sid,kid:currentQuestionKqid};Sockets.prototype.sendMessageSocket(JSON.stringify(msg))},Sockets.prototype.playQuestion=function(){let msg={action:"playQuestion",sid:sid,kid:currentQuestionKqid};Sockets.prototype.sendMessageSocket(JSON.stringify(msg))},Sockets.prototype.resendSelf=function(){let request={methodname:SERVICES_DELETERESPONSES,args:{cmid:cmid,sessionid:sid,kid:currentQuestionKqid}},removeEvents=new CustomEvent("removeEvents");dispatchEvent(removeEvents),_ajax.default.call([request])[0].done((function(response){if(!0===response.deleted){let currentQuestionData=db.get("questions",currentQuestionKqid);currentQuestionData.onsuccess=function(){let msg={action:"question",sid:sid,context:currentQuestionData.result};Sockets.prototype.sendMessageSocket(JSON.stringify(msg)),showRankingBetweenQuestionsSwitch=!0,currentQuestionDataForRace=currentQuestionData.result.value,"race_manual"===sessionMode?Sockets.prototype.raceResults():_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){let identifier=(0,_jquery.default)(REGION.TEACHERCANVAS);identifier.append(html),currentQuestionData.result.value.isteacher=!0,_templates.default.render(TEMPLATES_QUESTION,currentQuestionData.result.value).then((function(html,js){identifier.html(html),_templates.default.runTemplateJS(js),_event.default.notifyFilterContentUpdated(document.querySelector(REGION.TEACHERCANVAS)),(0,_jquery.default)(REGION.LOADING).remove()})).fail(_notification.default.exception)}))}}})).fail(_notification.default.exception)},Sockets.prototype.jumpTo=function(questionNumber){let that=this,request={methodname:SERVICES_JUMPTOQUESTION,args:{cmid:cmid,sessionid:sid,position:questionNumber,manual:!0}};nextQuestionKqid=null;let removeEvents=new CustomEvent("removeEvents");dispatchEvent(removeEvents),_ajax.default.call([request])[0].done((function(question){let data={kid:question.kid,value:question};db.add("questions",data),currentQuestionKqid=question.kid,that.setCurrentQuestion(question.kid),that.getNextQuestion(question.kid);let msg={action:"question",sid:sid,context:data};Sockets.prototype.sendMessageSocket(JSON.stringify(msg)),showRankingBetweenQuestionsSwitch=!0,_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){let identifier=(0,_jquery.default)(REGION.TEACHERCANVAS);identifier.append(html),question.isteacher=!0,currentQuestionDataForRace=question,"race_manual"===sessionMode?Sockets.prototype.raceResults():_templates.default.render(TEMPLATES_QUESTION,question).then((function(html,js){identifier.html(html),_templates.default.runTemplateJS(js),_event.default.notifyFilterContentUpdated(document.querySelector(REGION.TEACHERCANVAS)),(0,_jquery.default)(REGION.LOADING).remove()})).fail(_notification.default.exception)}))})).fail(_notification.default.exception)},Sockets.prototype.questionEnd=function(){let request={methodname:SERVICES_GETQUESTIONSTATISTICS,args:{sid:sid,kid:currentQuestionKqid}};_ajax.default.call([request])[0].done((function(response){let msg={action:"teacherQuestionEnd",sid:sid,kid:currentQuestionKqid,statistics:response.statistics};Sockets.prototype.sendMessageSocket(JSON.stringify(msg)),dispatchEvent(new CustomEvent("teacherQuestionEnd_"+currentQuestionKqid,{detail:{statistics:response.statistics}}))})).fail(_notification.default.exception)},Sockets.prototype.showAnswers=function(){let msg={action:"showAnswers",sid:sid,kid:currentQuestionKqid};Sockets.prototype.sendMessageSocket(JSON.stringify(msg))},Sockets.prototype.hideAnswers=function(){let msg={action:"hideAnswers",sid:sid,kid:currentQuestionKqid};Sockets.prototype.sendMessageSocket(JSON.stringify(msg))},Sockets.prototype.showStatistics=function(){let msg={action:"showStatistics",sid:sid,kid:currentQuestionKqid};Sockets.prototype.sendMessageSocket(JSON.stringify(msg))},Sockets.prototype.hideStatistics=function(){let msg={action:"hideStatistics",sid:sid,kid:currentQuestionKqid};Sockets.prototype.sendMessageSocket(JSON.stringify(msg))},Sockets.prototype.showFeedback=function(){let msg={action:"showFeedback",sid:sid,kid:currentQuestionKqid};Sockets.prototype.sendMessageSocket(JSON.stringify(msg))},Sockets.prototype.hideFeedback=function(){let msg={action:"hideFeedback",sid:sid,kid:currentQuestionKqid};Sockets.prototype.sendMessageSocket(JSON.stringify(msg))},Sockets.prototype.closeImprovise=function(){let msg={action:"closeImprovise",sid:sid};Sockets.prototype.sendMessageSocket(JSON.stringify(msg)),(0,_jquery.default)(REGION.IMPROVISE).addClass("d-none"),(0,_jquery.default)(REGION.TEACHERCANVAS).addClass("d-flex").removeClass("d-none")},Sockets.prototype.improvise=function(){let msg={action:"improvising",sid:sid};Sockets.prototype.sendMessageSocket(JSON.stringify(msg)),(0,_jquery.default)(REGION.IMPROVISE).removeClass("d-none"),(0,_jquery.default)(REGION.TEACHERCANVAS).removeClass("d-flex").addClass("d-none")},Sockets.prototype.submitImprovise=function(){let improviseStatement=(0,_jquery.default)(REGION.IMPROVISESTATEMENT).val(),improviseReply=(0,_jquery.default)(REGION.IMPROVISEREPLY).val();if(""===improviseStatement)(0,_jquery.default)(REGION.IMPROVISESTATEMENT).focus((()=>{(0,_jquery.default)(REGION.IMPROVISESTATEMENT).css({"border-color":"red"})}));else{(0,_jquery.default)(REGION.IMPROVISESTATEMENT).val(""),(0,_jquery.default)(REGION.IMPROVISEREPLY).val("");let msg={action:"improvised",sid:sid,improvisestatement:improviseStatement,improvisereply:improviseReply,cmid:cmid};Sockets.prototype.sendMessageSocket(JSON.stringify(msg)),_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){(0,_jquery.default)(REGION.IMPROVISE).addClass("d-none"),(0,_jquery.default)(REGION.TEACHERCANVAS).addClass("d-flex").removeClass("d-none");let identifier=(0,_jquery.default)(REGION.TEACHERCANVAS);identifier.append(html),""!==improviseReply&&Sockets.prototype.manageCloudTags(improviseReply);let cloudtagsData={sessionid:sid,cmid:cmid,improvised:!0,sessionprogress:0,cloudtags:!0,isteacher:!0,questiontext:improviseStatement,programmedmode:!1,preview:!1,tags:cloudTags};_templates.default.render(TEMPLATES_QUESTION,cloudtagsData).then((function(html,js){identifier.html(html),(0,_jquery.default)('[data-action="delete-tag"]').on("click",Sockets.prototype.deleteTag.bind(this)),_templates.default.runTemplateJS(js),(0,_jquery.default)(REGION.LOADING).remove(),(0,_jquery.default)(REGION.VOTEIMPROVISE).removeClass("disabled")})).fail(_notification.default.exception)}))}},Sockets.prototype.manageCloudTags=function(newtag){if(""!==newtag){let exist=!1;cloudTags.length&&(cloudTags=cloudTags.map((tag=>(tag.name.toLowerCase()===newtag.toLowerCase()&&(tag.count=tag.count+1,tag.votenum=0,exist=!0),tag)))),exist||cloudTags.push({name:newtag,count:1,votenum:0});const maxCount=Math.max(...cloudTags.map((item=>item.count)));cloudTags.forEach((item=>{item.size=Math.ceil(item.count/maxCount*10)}))}},Sockets.prototype.manageTagsVotes=function(voteTag){if(cloudTags.length){cloudTags=cloudTags.map((tag=>(tag.name.toLowerCase()===voteTag.toLowerCase()&&(tag.votenum=tag.votenum+1),tag)));const maxCount=Math.max(...cloudTags.map((item=>item.votenum)));cloudTags.forEach((item=>{item.size=Math.ceil(item.votenum/maxCount*10)}))}},Sockets.prototype.printNewTag=function(){let htmlTags="";cloudTags.forEach((tag=>{htmlTags+='<li><span class="tag" data-count="'+tag.count+'" data-vote="'+tag.votenum+'"  data-size="'+tag.size+'"><div class="delete-tag" data-name="'+tag.name+'" data-action="delete-tag">x</div>'+tag.name+"</span></li>"})),(0,_jquery.default)(REGION.TAGSCONTENT).html(htmlTags),(0,_jquery.default)('[data-action="delete-tag"]').on("click",Sockets.prototype.deleteTag.bind(this));let msg={action:"printNewTag",sid:sid,tags:cloudTags};Sockets.prototype.sendMessageSocket(JSON.stringify(msg))},Sockets.prototype.deleteTag=function(e){let nameToDelete=(0,_jquery.default)(e.currentTarget).attr("data-name");if(cloudTags.length){const indexToDelete=cloudTags.findIndex((item=>item.name===nameToDelete));-1!==indexToDelete&&cloudTags.splice(indexToDelete,1)}Sockets.prototype.printNewTag()},Sockets.prototype.vote=function(){voting=!0,(0,_jquery.default)(REGION.VOTEIMPROVISE).addClass("disabled"),(0,_jquery.default)(REGION.CLOUDTAGS).attr("data-show-votes",!0),(0,_jquery.default)(REGION.CLOUDTAGS).attr("data-show-value",!1);let msg={action:"initVote",sid:sid};Sockets.prototype.sendMessageSocket(JSON.stringify(msg))},Sockets.prototype.normalizeUser=function(usersocketid){let currentQuestion=db.get("statequestions","currentQuestion");currentQuestion.onsuccess=function(){let currentQuestiondata=db.get("questions",currentQuestion.result.value);currentQuestiondata.onsuccess=function(){let msg={action:"normalizeUser",sid:sid,ofs:!0,usersocketid:usersocketid,context:currentQuestiondata.result};Sockets.prototype.sendMessageSocket(JSON.stringify(msg))}}},Sockets.prototype.sendMessageSocket=function(msg){this.webSocket.send(msg)};_exports.teacherInitSockets=(region,socketurl,port,sessionmode,groupmode)=>new Sockets(region,socketurl,port,sessionmode,groupmode)}));

//# sourceMappingURL=teachersockets.min.js.map