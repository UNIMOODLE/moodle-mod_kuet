define("mod_jqshow/match",["exports","jquery","core/ajax","core/templates"],(function(_exports,_jquery,_ajax,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.initMatch=void 0,_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates);var cmId,sId,questionid,jqshowId,jqid,startPoint,color,toucheX,toucheY,ACTION_SEND_RESPONSE='[data-action="send-match"]',REGION={ROOT:'[data-region="question-content"]',LOADING:'[data-region="overlay-icon-container"]',LEFT_OPTION:"#dragOption",RIGHT_OPTION:"#dropOption",CONTAINER_ANSWERS:"#dragQuestion",CANVAS:"#canvas",CANVASTEMP:"#canvasTemp",LEFT_OPTION_SELECTOR:"#dragOption .option",OPTION:".option",CLEARPATH:"#dropOption .drop-element",POINTER:".option-pointer"},SERVICES_REPLY="mod_jqshow_match",TEMPLATES_LOADING="core/overlay_loading",linkList=[],linkCorrection=[];function Match(selector){var showquestionfeedback=arguments.length>1&&void 0!==arguments[1]&&arguments[1],manualmode=arguments.length>2&&void 0!==arguments[2]&&arguments[2],jsonresponse=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";this.node=(0,_jquery.default)(selector),sId=this.node.attr("data-sid"),cmId=this.node.attr("data-cmid"),questionid=this.node.attr("data-questionid"),jqshowId=this.node.attr("data-jqshowid"),jqid=this.node.attr("data-jqid"),showquestionfeedback,manualmode,!1,""!==jsonresponse&&(linkList=JSON.parse(jsonresponse)),this.initMatch(),this.createLinkCorrection()}Match.prototype.node=null,Match.prototype.endTimer=new Event("endTimer"),Match.prototype.studentQuestionEnd=new Event("studentQuestionEnd"),Match.prototype.initMatch=function(){var _this=this,height=(0,_jquery.default)(REGION.LEFT_OPTION).height();(0,_jquery.default)(REGION.CANVAS).attr("height",height),(0,_jquery.default)(REGION.CANVAS).attr("width",(0,_jquery.default)(REGION.CANVAS).width()),(0,_jquery.default)(REGION.CANVASTEMP).attr("width",(0,_jquery.default)(REGION.CANVASTEMP).width()),(0,_jquery.default)(REGION.CANVASTEMP).attr("height",height),(0,_jquery.default)(REGION.CONTAINER_ANSWERS).bind("dragover",(function(){var top=window.event.pageY,left=window.event.pageX;Match.prototype.drawLinkTemp(startPoint,{top:top,left:left})})),(0,_jquery.default)(REGION.LEFT_OPTION).find(REGION.OPTION).toArray().forEach((function(dragEl){return _this.addEventsDragAndDrop(dragEl)})),(0,_jquery.default)(REGION.RIGHT_OPTION).find(REGION.OPTION).toArray().forEach((function(dropEl){return _this.addTargetEvents(dropEl)})),Match.prototype.drawLinks(),(0,_jquery.default)(REGION.CLEARPATH).on("click",Match.prototype.clearPath.bind(this)),(0,_jquery.default)(ACTION_SEND_RESPONSE).on("click",Match.prototype.sendResponse)},Match.prototype.createLinkCorrection=function(){_jquery.default.each((0,_jquery.default)(REGION.LEFT_OPTION_SELECTOR),(function(index,item){var dragId=(0,_jquery.default)(item).data("stems")+"-draggable",steam=Match.prototype.baseConvert((0,_jquery.default)(item).data("stems"),2,16),dropId=Match.prototype.baseConvert(steam,10,26)+"-draggable";linkCorrection.push({dragId:dragId,dropId:dropId})}))},Match.prototype.getRandomColor=function(position){return["#FF6633","#FFB399","#FF33FF","#FF9999","#00B3E6","#E6B333","#3366E6","#999966","#99FF99","#B34D4D","#80B300","#809900","#E6B3B3","#6680B3","#66991A","#FF99E6","#CCFF1A","#FF1A66","#E6331A","#33FFCC","#66994D","#B366CC","#4D8000","#B33300","#CC80CC","#66664D","#991AFF","#E666FF","#4DB3FF","#1AB399","#E666B3","#33991A","#CC9999","#B3B31A","#00E680","#4D8066","#809980","#E6FF80","#1AFF33","#999933","#FF3380","#CCCC00","#66E64D","#4D80CC","#9900B3","#E64D66","#4DB380","#FF4D4D","#99E6E6","#6666FF"][position]},Match.prototype.sendResponse=function(){_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){(0,_jquery.default)(REGION.ROOT).append(html),dispatchEvent(Match.prototype.endTimer);var timeLeft=parseInt((0,_jquery.default)(REGION.SECONDS).text()),result=3,corrects=0,fails=0;linkList.forEach((function(userR){userR.stemDragId===userR.stemDropId?(userR.color="green",corrects++):(userR.color="red",fails++)})),0!==corrects&&(result=2),(0,_jquery.default)(REGION.LEFT_OPTION_SELECTOR).length===corrects&&(result=1),(0,_jquery.default)(REGION.LEFT_OPTION_SELECTOR).length===fails&&(result=0),Match.prototype.drawLinks();var request={methodname:SERVICES_REPLY,args:{jsonresponse:JSON.stringify(linkList),result:result,sessionid:sId,jqshowid:jqshowId,cmid:cmId,questionid:questionid,jqid:jqid,timeleft:timeLeft||0,preview:!1}};_ajax.default.call([request])[0].done((function(response){!0===response.reply_status?((0,_jquery.default)(ACTION_SEND_RESPONSE).addClass("d-none"),dispatchEvent(Match.prototype.studentQuestionEnd)):alert("error"),(0,_jquery.default)(REGION.LOADING).remove()}))}))},Match.prototype.addEventsDragAndDrop=function(el){el.addEventListener("dragstart",Match.prototype.onDragStart,!1),el.addEventListener("dragend",Match.prototype.onDragEnd,!1),el.addEventListener("touchstart",Match.prototype.touchStart,!1),el.addEventListener("touchmove",Match.prototype.touchMove,!1),el.addEventListener("touchend",Match.prototype.touchEnd,!1)},Match.prototype.addTargetEvents=function(target){target.addEventListener("dragover",Match.prototype.onDragOver,!1),target.addEventListener("drop",Match.prototype.onDrop,!1)},Match.prototype.onDragStart=function(event){event.dataTransfer.setData("text/plain",event.target.id),startPoint=event.target.id;var options=document.querySelectorAll(REGION.LEFT_OPTION_SELECTOR);color=Match.prototype.getRandomColor(Array.from(options).indexOf(event.currentTarget))},Match.prototype.onDragOver=function(event){Match.prototype.clearPathTemp(),event.preventDefault()},Match.prototype.onDragEnd=function(event){Match.prototype.clearPathTemp(),event.preventDefault()},Match.prototype.onDrop=function(event){var dragId=event.dataTransfer.getData("text"),dropId=(0,_jquery.default)(event.currentTarget).find(REGION.POINTER).attr("id");Match.prototype.Drop(dragId,dropId)},Match.prototype.Drop=function(dragId,dropId){var deselected=linkList.filter((function(obj){return obj.dragId===dragId||obj.dropId===dropId}));deselected.length&&deselected.forEach((function(x){var selectroDropId=(0,_jquery.default)("#"+x.dropId);selectroDropId.find("i").css("font-weight","400"),selectroDropId.find("i").css("color","#5a57ff"),selectroDropId.find("i").removeClass("linked"),selectroDropId.find("i").css("font-weight","400"),selectroDropId.find("i").css("color","#5a57ff")})),linkList=(linkList=linkList.filter((function(obj){return obj.dragId!==dragId}))).filter((function(obj){return obj.dropId!==dropId}));var stemDragId=Match.prototype.baseConvert((0,_jquery.default)("#"+dragId).data("forstems"),2,16),stemDropId=Match.prototype.baseConvert((0,_jquery.default)("#"+dropId).data("forstems"),26,10);linkList.push({dragId:dragId,dropId:dropId,color:color,stemDragId:stemDragId,stemDropId:stemDropId}),Match.prototype.drawLinks(),Match.prototype.clearPathTemp()},Match.prototype.baseConvert=function(number,frombase,tobase){return parseInt(number+"",0|frombase).toString(0|tobase)},Match.prototype.touchStart=function(e){var dragEl=e.path.find((function(x){return"drag-element"===x.className}));startPoint=(0,_jquery.default)(dragEl).get(0).id;var options=document.querySelectorAll(REGION.LEFT_OPTION_SELECTOR);color=Match.prototype.getRandomColor(Array.from(options).indexOf(event.currentTarget))},Match.prototype.touchMove=function(e){e.preventDefault();var top=toucheY=e.touches[0].pageY,left=toucheX=e.touches[0].pageX;Match.prototype.drawLinkTemp(startPoint,{top:top,left:left})},Match.prototype.touchEnd=function(e){(0,_jquery.default)(REGION.RIGHT_OPTION).find(REGION.OPTION).toArray().forEach((function(target){var box2=target.getBoundingClientRect(),x=box2.left,y=box2.top,h=target.offsetHeight,w=target.offsetWidth;if(!(toucheX>x&&toucheX<x+w&&toucheY>y&&toucheY<y+h))return!1;Match.prototype.Drop(startPoint,target.id)})),Match.prototype.clearPathTemp(),e.preventDefault()},Match.prototype.drawLinks=function(){var canvas=(0,_jquery.default)(REGION.CANVAS).get(0);canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height),linkList.forEach((function(link){return Match.prototype.drawLink(link.dragId,link.dropId,link.color)}))},Match.prototype.drawLink=function(obj1,obj2,pColor){var ctx=(0,_jquery.default)(REGION.CANVAS).get(0).getContext("2d"),$obj1=(0,_jquery.default)("#"+obj1),$obj2=(0,_jquery.default)("#"+obj2),parent=(0,_jquery.default)(REGION.CONTAINER_ANSWERS).offset(),p1=$obj1.offset(),h1=($obj1.width(),$obj1.height()),p2=$obj2.offset(),h2=($obj2.width(),$obj2.height()),wc=(0,_jquery.default)(REGION.CANVAS).width();ctx.beginPath(),ctx.strokeStyle=pColor||color,ctx.lineWidth=3,ctx.moveTo(0,p1.top-parent.top+h1/2-20-2),ctx.bezierCurveTo(wc/2,p1.top-parent.top+h1/2-20-2,wc/2,p2.top-parent.top+h2/2-20-2,wc-4,p2.top-parent.top+h2/2-20-2),ctx.stroke(),$obj1.children().css("color",pColor||color),$obj1.children().css("font-weight","900"),$obj2.children().css("color",pColor||color),$obj2.children().css("font-weight","900"),$obj2.children().addClass("linked")},Match.prototype.clearPath=function(event){var ident=event.currentTarget.id;linkList=linkList.filter((function(obj){return obj.dropId!==ident}));var dragQuestionObject=(0,_jquery.default)(REGION.CONTAINER_ANSWERS);dragQuestionObject.find("i").removeClass("linked"),dragQuestionObject.find("i").css("font-weight","400"),dragQuestionObject.find("i").css("color","#5a57ff"),Match.prototype.drawLinks()},Match.prototype.drawLinkTemp=function(obj1,coordPt){var ctx=(0,_jquery.default)(REGION.CANVASTEMP).get(0).getContext("2d"),$obj1=(0,_jquery.default)("#"+obj1),parent=(0,_jquery.default)(REGION.CONTAINER_ANSWERS).offset(),p1=$obj1.offset(),h1=($obj1.width(),$obj1.height()),p2=coordPt,c=(0,_jquery.default)(REGION.CANVASTEMP).offset();ctx.beginPath(),ctx.strokeStyle=color,ctx.lineWidth=3,ctx.moveTo(0,p1.top-parent.top+h1/2-20-2),ctx.bezierCurveTo((p2.left-c.left)/2,p1.top-parent.top-19-2,(p2.left-c.left)/2,p2.top-parent.top-19-2,p2.left-c.left,p2.top-parent.top-19-2),Match.prototype.clearPathTemp(),ctx.stroke()},Match.prototype.clearPathTemp=function(){var canvas=(0,_jquery.default)(REGION.CANVASTEMP).get(0);canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height)};_exports.initMatch=function(selector,showquestionfeedback,manualmode,jsonresponse){return new Match(selector,showquestionfeedback,manualmode,jsonresponse)}}));

//# sourceMappingURL=match.min.js.map