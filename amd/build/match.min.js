define("mod_jqshow/match",["exports","jquery","core/ajax","core/templates"],(function(_exports,_jquery,_ajax,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.initMatch=void 0,_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates);var cmId,sId,questionid,jqshowId,jqid,startPoint,color,toucheX,toucheY,ACTION={SEND_RESPONSE:'[data-action="send-match"]'},REGION_ROOT='[data-region="question-content"]',REGION_LOADING='[data-region="overlay-icon-container"]',REGION_LEFT_OPTION="#dragOption",REGION_RIGHT_OPTION="#dropOption",REGION_CONTAINER_ANSWERS="#dragQuestion",REGION_CANVAS="#canvas",REGION_CANVASTEMP="#canvasTemp",REGION_LEFT_OPTION_SELECTOR="#dragOption .option",REGION_OPTION=".option",REGION_CLEARPATH="#dropOption .drop-element",REGION_POINTER=".option-pointer",REGION_NEXT='[data-action="next-question"]',REGION_TIMER='[data-region="question-timer"]',REGION_SECONDS='[data-region="seconds"]',REGION_CONTENTFEEDBACKS='[data-region="containt-feedbacks"]',REGION_FEEDBACKBACGROUND='[data-region="feedback-background"]',SERVICES_REPLY="mod_jqshow_match",TEMPLATES_LOADING="core/overlay_loading",questionEnd=!1,linkList=[],linkCorrection=[];function Match(selector){var showquestionfeedback=arguments.length>1&&void 0!==arguments[1]&&arguments[1],manualmode=arguments.length>2&&void 0!==arguments[2]&&arguments[2],jsonresponse=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";this.node=(0,_jquery.default)(selector),sId=this.node.attr("data-sid"),cmId=this.node.attr("data-cmid"),questionid=this.node.attr("data-questionid"),jqshowId=this.node.attr("data-jqshowid"),jqid=this.node.attr("data-jqid"),showquestionfeedback,manualmode,questionEnd=!1,""!==jsonresponse&&this.answered(jsonresponse),this.initMatch(),this.createLinkCorrection()}Match.prototype.node=null,Match.prototype.endTimer=new Event("endTimer"),Match.prototype.studentQuestionEnd=new Event("studentQuestionEnd"),Match.prototype.answered=function(jsonresponse){linkList=JSON.parse(jsonresponse),(0,_jquery.default)(ACTION.SEND_RESPONSE).addClass("d-none"),(0,_jquery.default)(REGION_NEXT).removeClass("d-none")},Match.prototype.initMatch=function(){var _this=this,height=(0,_jquery.default)(REGION_LEFT_OPTION).height();(0,_jquery.default)(REGION_CANVAS).attr("height",height),(0,_jquery.default)(REGION_CANVAS).attr("width",(0,_jquery.default)(REGION_CANVAS).width()),(0,_jquery.default)(REGION_CANVASTEMP).attr("width",(0,_jquery.default)(REGION_CANVASTEMP).width()),(0,_jquery.default)(REGION_CANVASTEMP).attr("height",height),(0,_jquery.default)(REGION_CONTAINER_ANSWERS).bind("dragover",(function(){var top=window.event.pageY,left=window.event.pageX;Match.prototype.drawLinkTemp(startPoint,{top:top,left:left})})),(0,_jquery.default)(REGION_LEFT_OPTION).find(REGION_OPTION).toArray().forEach((function(dragEl){return _this.addEventsDragAndDrop(dragEl)})),(0,_jquery.default)(REGION_RIGHT_OPTION).find(REGION_OPTION).toArray().forEach((function(dropEl){return _this.addTargetEvents(dropEl)})),Match.prototype.drawLinks(),(0,_jquery.default)(REGION_CLEARPATH).on("click",Match.prototype.clearPath.bind(this)),(0,_jquery.default)(ACTION.SEND_RESPONSE).on("click",Match.prototype.sendResponse),Match.prototype.initEvents()},Match.prototype.initEvents=function(){addEventListener("timeFinish",(function(){Match.prototype.sendResponse()}),{once:!0}),addEventListener("teacherQuestionEnd_"+jqid,(function(e){!0!==questionEnd&&Match.prototype.sendResponse(),e.detail.statistics.forEach((function(statistic){(0,_jquery.default)('[data-answerid="'+statistic.answerid+'"] .numberofreplies').html(statistic.numberofreplies)}))}),{once:!0}),addEventListener("pauseQuestion_"+jqid,(function(){Match.prototype.pauseQuestion()}),!1),addEventListener("playQuestion_"+jqid,(function(){Match.prototype.playQuestion()}),!1),addEventListener("showAnswers_"+jqid,(function(){Match.prototype.showAnswers()}),!1),addEventListener("hideAnswers_"+jqid,(function(){Match.prototype.hideAnswers()}),!1),addEventListener("showStatistics_"+jqid,(function(){Match.prototype.showStatistics()}),!1),addEventListener("hideStatistics_"+jqid,(function(){Match.prototype.hideStatistics()}),!1),addEventListener("showFeedback_"+jqid,(function(){Match.prototype.showFeedback()}),!1),addEventListener("hideFeedback_"+jqid,(function(){Match.prototype.hideFeedback()}),!1),window.onbeforeunload=function(){if((0,_jquery.default)(REGION_SECONDS).length>0&&!1===questionEnd)return Match.prototype.sendResponse(),"Because the question is overdue and an attempt has been made to reload the page, the question has remained unanswered."}},Match.prototype.createLinkCorrection=function(){_jquery.default.each((0,_jquery.default)(REGION_LEFT_OPTION_SELECTOR),(function(index,item){var dragId=(0,_jquery.default)(item).data("stems")+"-draggable",steam=Match.prototype.baseConvert((0,_jquery.default)(item).data("stems"),2,16),dropId=Match.prototype.baseConvert(steam,10,26)+"-draggable";linkCorrection.push({dragId:dragId,dropId:dropId})}))},Match.prototype.getRandomColor=function(position){return["#FF6633","#FFB399","#FF33FF","#FF9999","#00B3E6","#E6B333","#3366E6","#999966","#99FF99","#B34D4D","#80B300","#809900","#E6B3B3","#6680B3","#66991A","#FF99E6","#CCFF1A","#FF1A66","#E6331A","#33FFCC","#66994D","#B366CC","#4D8000","#B33300","#CC80CC","#66664D","#991AFF","#E666FF","#4DB3FF","#1AB399","#E666B3","#33991A","#CC9999","#B3B31A","#00E680","#4D8066","#809980","#E6FF80","#1AFF33","#999933","#FF3380","#CCCC00","#66E64D","#4D80CC","#9900B3","#E64D66","#4DB380","#FF4D4D","#99E6E6","#6666FF"][position]},Match.prototype.sendResponse=function(){_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){(0,_jquery.default)(REGION_ROOT).append(html),dispatchEvent(Match.prototype.endTimer);var timeLeft=parseInt((0,_jquery.default)(REGION_SECONDS).text()),result=3,corrects=0,fails=0;linkList.forEach((function(userR){userR.stemDragId===userR.stemDropId?(userR.color="green",corrects++):(userR.color="red",fails++)})),0!==corrects&&(result=2),(0,_jquery.default)(REGION_LEFT_OPTION_SELECTOR).length===corrects&&(result=1),(0,_jquery.default)(REGION_LEFT_OPTION_SELECTOR).length===fails&&(result=0),Match.prototype.drawLinks();var request={methodname:SERVICES_REPLY,args:{jsonresponse:JSON.stringify(linkList),result:result,sessionid:sId,jqshowid:jqshowId,cmid:cmId,questionid:questionid,jqid:jqid,timeleft:timeLeft||0,preview:!1}};_ajax.default.call([request])[0].done((function(response){!0===response.reply_status?((0,_jquery.default)(ACTION.SEND_RESPONSE).addClass("d-none"),(0,_jquery.default)(REGION_NEXT).removeClass("d-none"),dispatchEvent(Match.prototype.studentQuestionEnd)):alert("error"),(0,_jquery.default)(REGION_LOADING).remove()}))}))},Match.prototype.addEventsDragAndDrop=function(el){el.addEventListener("dragstart",Match.prototype.onDragStart,!1),el.addEventListener("dragend",Match.prototype.onDragEnd,!1),el.addEventListener("touchstart",Match.prototype.touchStart,!1),el.addEventListener("touchmove",Match.prototype.touchMove,!1),el.addEventListener("touchend",Match.prototype.touchEnd,!1)},Match.prototype.addTargetEvents=function(target){target.addEventListener("dragover",Match.prototype.onDragOver,!1),target.addEventListener("drop",Match.prototype.onDrop,!1)},Match.prototype.onDragStart=function(event){event.dataTransfer.setData("text/plain",event.target.id),startPoint=event.target.id,console.log(startPoint);var options=document.querySelectorAll(REGION_LEFT_OPTION_SELECTOR);color=Match.prototype.getRandomColor(Array.from(options).indexOf(event.currentTarget))},Match.prototype.onDragOver=function(event){Match.prototype.clearPathTemp(),event.preventDefault()},Match.prototype.onDragEnd=function(event){Match.prototype.clearPathTemp(),event.preventDefault()},Match.prototype.onDrop=function(event){var dragId=event.dataTransfer.getData("text"),dropId=(0,_jquery.default)(event.currentTarget).find(REGION_POINTER).attr("id");Match.prototype.Drop(dragId,dropId)},Match.prototype.Drop=function(dragId,dropId){var deselected=linkList.filter((function(obj){return obj.dragId===dragId||obj.dropId===dropId}));deselected.length&&deselected.forEach((function(x){var selectroDropId=(0,_jquery.default)("#"+x.dropId);selectroDropId.find("i").css("font-weight","400"),selectroDropId.find("i").css("color","#5a57ff"),selectroDropId.find("i").removeClass("linked"),selectroDropId.find("i").css("font-weight","400"),selectroDropId.find("i").css("color","#5a57ff")})),linkList=(linkList=linkList.filter((function(obj){return obj.dragId!==dragId}))).filter((function(obj){return obj.dropId!==dropId}));var stemDragId=Match.prototype.baseConvert((0,_jquery.default)("#"+dragId).data("forstems"),2,16),stemDropId=Match.prototype.baseConvert((0,_jquery.default)("#"+dropId).data("forstems"),26,10);linkList.push({dragId:dragId,dropId:dropId,color:color,stemDragId:stemDragId,stemDropId:stemDropId}),Match.prototype.drawLinks(),Match.prototype.clearPathTemp()},Match.prototype.baseConvert=function(number,frombase,tobase){return parseInt(number+"",0|frombase).toString(0|tobase)},Match.prototype.touchStart=function(e){void 0!==e.target.id&&""!==e.target.id||(startPoint=void 0!==(0,_jquery.default)(e.target).parent().attr("id")?(0,_jquery.default)(e.target).parent().attr("id"):(0,_jquery.default)(e.target).closest(".option").find(".drag-element").first().attr("id"));var options=document.querySelectorAll(REGION_LEFT_OPTION_SELECTOR);color=Match.prototype.getRandomColor(Array.from(options).indexOf(e.currentTarget))},Match.prototype.touchMove=function(e){e.preventDefault();var top=toucheY=e.touches[0].pageY,left=toucheX=e.touches[0].pageX;Match.prototype.drawLinkTemp(startPoint,{top:top,left:left})},Match.prototype.touchEnd=function(e){(0,_jquery.default)(REGION_RIGHT_OPTION).find(REGION_OPTION).toArray().forEach((function(target){console.log(target);var dropId,box2=target.getBoundingClientRect(),x=box2.left,y=box2.top,h=target.offsetHeight,w=target.offsetWidth;if(!(toucheX>x&&toucheX<x+w&&toucheY>y&&toucheY<y+h))return!1;void 0===target.id||""===target.id||"dropOption"===target.id?(console.log("primero"),void 0!==(0,_jquery.default)(target).parent().attr("id")&&"dropOption"!==(0,_jquery.default)(target).parent().attr("id")?(console.log("segundo"),dropId=(0,_jquery.default)(target).parent().attr("id")):(console.log("tercero"),dropId=(0,_jquery.default)(target).closest(".option-right").find(".drop-element").first().attr("id"))):dropId=target.id,console.log(dropId),Match.prototype.Drop(startPoint,dropId)})),Match.prototype.clearPathTemp(),e.preventDefault()},Match.prototype.drawLinks=function(){var canvas=(0,_jquery.default)(REGION_CANVAS).get(0);canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height),linkList.forEach((function(link){return Match.prototype.drawLink(link.dragId,link.dropId,link.color)}))},Match.prototype.drawLink=function(obj1,obj2,pColor){var ctx=(0,_jquery.default)(REGION_CANVAS).get(0).getContext("2d"),$obj1=(0,_jquery.default)("#"+obj1),$obj2=(0,_jquery.default)("#"+obj2),parent=(0,_jquery.default)(REGION_CONTAINER_ANSWERS).offset(),p1=$obj1.offset(),h1=($obj1.width(),$obj1.height()),p2=$obj2.offset(),h2=($obj2.width(),$obj2.height()),wc=(0,_jquery.default)(REGION_CANVAS).width();ctx.beginPath(),ctx.strokeStyle=pColor||color,ctx.lineWidth=3,ctx.moveTo(0,p1.top-parent.top+h1/2-20-2),ctx.bezierCurveTo(wc/2,p1.top-parent.top+h1/2-20-2,wc/2,p2.top-parent.top+h2/2-20-2,wc-4,p2.top-parent.top+h2/2-20-2),ctx.stroke(),$obj1.children().css("color",pColor||color),$obj1.children().css("font-weight","900"),$obj2.children().css("color",pColor||color),$obj2.children().css("font-weight","900"),$obj2.children().addClass("linked")},Match.prototype.clearPath=function(event){var ident=event.currentTarget.id;linkList=linkList.filter((function(obj){return obj.dropId!==ident}));var dragQuestionObject=(0,_jquery.default)(REGION_CONTAINER_ANSWERS);dragQuestionObject.find("i").removeClass("linked"),dragQuestionObject.find("i").css("font-weight","400"),dragQuestionObject.find("i").css("color","#5a57ff"),Match.prototype.drawLinks()},Match.prototype.drawLinkTemp=function(obj1,coordPt){var ctx=(0,_jquery.default)(REGION_CANVASTEMP).get(0).getContext("2d"),$obj1=(0,_jquery.default)("#"+obj1),parent=(0,_jquery.default)(REGION_CONTAINER_ANSWERS).offset(),p1=$obj1.offset(),h1=($obj1.width(),$obj1.height()),p2=coordPt,c=(0,_jquery.default)(REGION_CANVASTEMP).offset();ctx.beginPath(),ctx.strokeStyle=color,ctx.lineWidth=3,ctx.moveTo(0,p1.top-parent.top+h1/2-20-2),ctx.bezierCurveTo((p2.left-c.left)/2,p1.top-parent.top-19-2,(p2.left-c.left)/2,p2.top-parent.top-19-2,p2.left-c.left,p2.top-parent.top-19-2),Match.prototype.clearPathTemp(),ctx.stroke()},Match.prototype.clearPathTemp=function(){var canvas=(0,_jquery.default)(REGION_CANVASTEMP).get(0);canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height)},Match.prototype.pauseQuestion=function(){dispatchEvent(new Event("pauseQuestion")),(0,_jquery.default)(REGION_TIMER).css("z-index",3),(0,_jquery.default)(REGION_FEEDBACKBACGROUND).css("display","block"),(0,_jquery.default)(ACTION.REPLY).css("pointer-events","none")},Match.prototype.playQuestion=function(){dispatchEvent(new Event("playQuestion")),(0,_jquery.default)(REGION_TIMER).css("z-index",1),(0,_jquery.default)(REGION_FEEDBACKBACGROUND).css("display","none"),(0,_jquery.default)(ACTION.REPLY).css("pointer-events","auto")},Match.prototype.showAnswers=function(){},Match.prototype.hideAnswers=function(){!0===questionEnd&&(0,_jquery.default)(".feedback-icon").css("display","none")},Match.prototype.showStatistics=function(){!0===questionEnd&&(0,_jquery.default)(".statistics-icon").css("display","flex")},Match.prototype.hideStatistics=function(){!0===questionEnd&&(0,_jquery.default)(".statistics-icon").css("display","none")},Match.prototype.showFeedback=function(){!0===questionEnd&&(0,_jquery.default)(REGION_CONTENTFEEDBACKS).css({display:"block","z-index":3})},Match.prototype.hideFeedback=function(){!0===questionEnd&&(0,_jquery.default)(REGION_CONTENTFEEDBACKS).css({display:"none","z-index":0})};_exports.initMatch=function(selector,showquestionfeedback,manualmode,jsonresponse){return new Match(selector,showquestionfeedback,manualmode,jsonresponse)}}));

//# sourceMappingURL=match.min.js.map