{"version":3,"file":"teacher_programmedmode.min.js","sources":["../src/teacher_programmedmode.js"],"sourcesContent":["\"use strict\";\n\nimport jQuery from 'jquery';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport {get_strings as getStrings} from 'core/str';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\n\nlet REGION = {\n    LISTRESULTS: '[data-region=\"list-results\"]'\n};\n\nlet ACTION = {\n    ENDSESSION: '[data-action=\"end_session\"]'\n};\n\nlet SERVICES = {\n    GETLISTRESULTS: 'mod_jqshow_getlistresults',\n    GETGROUPLISTRESULTS: 'mod_jqshow_getgrouplistresults',\n    FINISHSESSION: 'mod_jqshow_finishsession'\n};\n\nlet TEMPLATES = {\n    LOADING: 'core/overlay_loading',\n    LISTRESULTS: 'mod_jqshow/session/listresults'\n};\n\nlet cmId;\nlet sId;\nlet groupMode = false;\n\n/**\n * @constructor\n * @param {String} selector\n */\nfunction ProgrammedMode(selector) {\n    this.node = jQuery(selector);\n    this.initProgrammedMode();\n    jQuery(ACTION.ENDSESSION).on('click', this.finishSession);\n}\n\n/** @type {jQuery} The jQuery node for the page region. */\nProgrammedMode.prototype.node = null;\n\nProgrammedMode.prototype.initProgrammedMode = function() {\n    sId = this.node.attr('data-sid');\n    cmId = this.node.attr('data-cmid');\n    groupMode = Boolean(this.node.attr('data-groupmode'));\n    setInterval(this.reloadList, 20000);\n};\n\nProgrammedMode.prototype.reloadList = function() {\n    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n        let identifier = jQuery(REGION.LISTRESULTS);\n        identifier.append(html);\n        let methodname = SERVICES.GETLISTRESULTS;\n        if (groupMode === true) {\n            methodname = SERVICES.GETGROUPLISTRESULTS;\n        }\n        let request = {\n            methodname: methodname,\n            args: {\n                sid: sId,\n                cmid: cmId\n            }\n        };\n        Ajax.call([request])[0].done(function(response) {\n            // eslint-disable-next-line promise/always-return\n            Templates.render(TEMPLATES.LISTRESULTS, response).then((html) => {\n                identifier.html(html);\n            }).fail(Notification.exception);\n        }).fail(Notification.exception);\n    });\n};\n\nProgrammedMode.prototype.finishSession = function(e) {\n    e.preventDefault();\n    e.stopPropagation();\n    const stringkeys = [\n        {key: 'end_session', component: 'mod_jqshow'},\n        {key: 'end_session_desc', component: 'mod_jqshow'},\n        {key: 'confirm', component: 'mod_jqshow'}\n    ];\n    getStrings(stringkeys).then((langStrings) => {\n        const title = langStrings[0];\n        const confirmMessage = langStrings[1];\n        const buttonText = langStrings[2];\n        return ModalFactory.create({\n            title: title,\n            body: confirmMessage,\n            type: ModalFactory.types.SAVE_CANCEL\n        }).then(modal => {\n            modal.setSaveButtonText(buttonText);\n            modal.getRoot().on(ModalEvents.save, () => {\n                let request = {\n                    methodname: SERVICES.FINISHSESSION,\n                    args: {\n                        cmid: cmId,\n                        sessionid: sId\n                    }\n                };\n                Ajax.call([request])[0].done(function(response) {\n                    if (response.finished === true) {\n                        window.location.replace(M.cfg.wwwroot + '/mod/jqshow/view.php?id=' + cmId);\n                    }\n                }).fail(Notification.exception);\n            });\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                modal.destroy();\n            });\n            return modal;\n        });\n    }).done(function(modal) {\n        modal.show();\n        // eslint-disable-next-line no-restricted-globals\n    }).fail(Notification.exception);\n};\n\nexport const initProgrammedMode = (selector) => {\n    return new ProgrammedMode(selector);\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","Object","defineProperty","_exports","value","initProgrammedMode","_jquery","_ajax","_templates","_notification","_modal_factory","_modal_events","cmId","sId","REGION","ACTION","SERVICES","TEMPLATES","groupMode","ProgrammedMode","selector","this","node","jQuery","on","finishSession","prototype","attr","Boolean","setInterval","reloadList","Templates","render","visible","done","html","identifier","append","methodname","request","args","sid","cmid","Ajax","call","response","then","fail","Notification","exception","e","preventDefault","stopPropagation","getStrings","key","component","langStrings","title","confirmMessage","buttonText","ModalFactory","create","body","type","types","SAVE_CANCEL","modal","setSaveButtonText","getRoot","ModalEvents","save","sessionid","finished","window","location","replace","M","cfg","wwwroot","hidden","destroy","show"],"mappings":"kQAQ4C,SAAAA,uBAAAC,KAAAA,OAAAA,KAAAA,IAAAC,WAAAD,IAAAE,CAAAA,QAAAF,IAAA,CAR/BG,OAAAC,eAAAC,SAAA,aAAA,CAAAC,OAAA,IAAAD,SAAAE,wBAAA,EAEbC,QAAAT,uBAAAS,SACAC,MAAAV,uBAAAU,OACAC,WAAAX,uBAAAW,YACAC,cAAAZ,uBAAAY,eAEAC,eAAAb,uBAAAa,gBACAC,cAAAd,uBAAAc,eAEA,IAmBIC,KACAC,IApBAC,mBACa,+BAGbC,kBACY,8BAGZC,wBACgB,4BADhBA,6BAEqB,iCAFrBA,uBAGe,2BAGfC,kBACS,uBADTA,sBAEa,iCAKbC,WAAY,EAMhB,SAASC,eAAeC,UACpBC,KAAKC,MAAO,EAAAC,QAAMvB,SAACoB,UACnBC,KAAKhB,sBACL,EAAAkB,QAAMvB,SAACe,mBAAmBS,GAAG,QAASH,KAAKI,cAC/C,CAGAN,eAAeO,UAAUJ,KAAO,KAEhCH,eAAeO,UAAUrB,mBAAqB,WAC1CQ,IAAMQ,KAAKC,KAAKK,KAAK,YACrBf,KAAOS,KAAKC,KAAKK,KAAK,aACtBT,UAAYU,QAAQP,KAAKC,KAAKK,KAAK,mBACnCE,YAAYR,KAAKS,WAAY,MAGjCX,eAAeO,UAAUI,WAAa,WAClCC,WAAAA,QAAUC,OAAOf,kBAAmB,CAACgB,SAAS,IAAOC,MAAK,SAASC,MAC/D,IAAIC,YAAa,EAAAb,QAAAA,SAAOT,oBACxBsB,WAAWC,OAAOF,MAClB,IAAIG,WAAatB,yBACC,IAAdE,YACAoB,WAAatB,8BAEjB,IAAIuB,QAAU,CACVD,WAAYA,WACZE,KAAM,CACFC,IAAK5B,IACL6B,KAAM9B,OAGd+B,MAAAA,QAAKC,KAAK,CAACL,UAAU,GAAGL,MAAK,SAASW,UAElCd,WAAAA,QAAUC,OAAOf,sBAAuB4B,UAAUC,MAAK,SAACX,MACpDC,WAAWD,KAAKA,KACnB,IAAEY,KAAKC,cAAYhD,QAACiD,UACxB,IAAEF,KAAKC,cAAYhD,QAACiD,UACzB,KAGJ9B,eAAeO,UAAUD,cAAgB,SAASyB,GAC9CA,EAAEC,iBACFD,EAAEE,mBAMF,EAAAC,KAAAA,aALmB,CACf,CAACC,IAAK,cAAeC,UAAW,cAChC,CAACD,IAAK,mBAAoBC,UAAW,cACrC,CAACD,IAAK,UAAWC,UAAW,gBAETT,MAAK,SAACU,aACzB,IAAMC,MAAQD,YAAY,GACpBE,eAAiBF,YAAY,GAC7BG,WAAaH,YAAY,GAC/B,OAAOI,eAAAA,QAAaC,OAAO,CACvBJ,MAAOA,MACPK,KAAMJ,eACNK,KAAMH,eAAAA,QAAaI,MAAMC,cAC1BnB,MAAK,SAAAoB,OAmBJ,OAlBAA,MAAMC,kBAAkBR,YACxBO,MAAME,UAAU5C,GAAG6C,cAAWrE,QAACsE,MAAM,WACjC,IAAI/B,QAAU,CACVD,WAAYtB,uBACZwB,KAAM,CACFE,KAAM9B,KACN2D,UAAW1D,MAGnB8B,MAAAA,QAAKC,KAAK,CAACL,UAAU,GAAGL,MAAK,SAASW,WACR,IAAtBA,SAAS2B,UACTC,OAAOC,SAASC,QAAQC,EAAEC,IAAIC,QAAU,2BAA6BlE,KAE5E,IAAEmC,KAAKC,cAAYhD,QAACiD,UACzB,IACAiB,MAAME,UAAU5C,GAAG6C,cAAWrE,QAAC+E,QAAQ,WACnCb,MAAMc,SACV,IACOd,KACX,GACJ,IAAGhC,MAAK,SAASgC,OACbA,MAAMe,MAET,IAAElC,KAAKC,cAAYhD,QAACiD,YAKvB9C,SAAAE,mBAFgC,SAACe,UAC/B,OAAO,IAAID,eAAeC,UAC5B"}