{"version":3,"file":"teacher_programmedmode.min.js","sources":["../src/teacher_programmedmode.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n// Project implemented by the \"Recovery, Transformation and Resilience Plan.\n// Funded by the European Union - Next GenerationEU\".\n//\n// Produced by the UNIMOODLE University Group: Universities of\n// Valladolid, Complutense de Madrid, UPV/EHU, León, Salamanca,\n// Illes Balears, Valencia, Rey Juan Carlos, La Laguna, Zaragoza, Málaga,\n// Córdoba, Extremadura, Vigo, Las Palmas de Gran Canaria y Burgos..\n\n/**\n *\n * @module    mod_kuet/teacher_programmedmode\n * @copyright  2023 Proyecto UNIMOODLE {@link https://unimoodle.github.io}\n * @author     UNIMOODLE Group (Coordinator) <direccion.area.estrategia.digital@uva.es>\n * @author     3IPUNT <contacte@tresipunt.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\"use strict\";\n\nimport jQuery from 'jquery';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport {get_strings as getStrings} from 'core/str';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\n\nlet REGION = {\n    LISTRESULTS: '[data-region=\"list-results\"]',\n    RACERESULTS: '[data-region=\"race-results\"]'\n};\n\nlet ACTION = {\n    ENDSESSION: '[data-action=\"end_session\"]'\n};\n\nlet SERVICES = {\n    GETLISTRESULTS: 'mod_kuet_getlistresults',\n    GETGROUPLISTRESULTS: 'mod_kuet_getgrouplistresults',\n    GETRACERESULTS: 'mod_kuet_getraceresults',\n    FINISHSESSION: 'mod_kuet_finishsession'\n};\n\nlet TEMPLATES = {\n    LOADING: 'core/overlay_loading',\n    LISTRESULTS: 'mod_kuet/session/listresults',\n    RACERESULTS: 'mod_kuet/session/raceresults'\n};\n\nlet cmId;\nlet sId;\nlet groupMode = false;\n\n/**\n * @constructor\n * @param {String} selector\n * @param {boolean} racemode\n */\nfunction ProgrammedMode(selector, racemode) {\n    this.node = jQuery(selector);\n    this.initProgrammedMode();\n    jQuery(ACTION.ENDSESSION).on('click', this.finishSession);\n    if (racemode) {\n        this.raceMode();\n        setInterval(this.reloadRace, 5000);\n    }\n}\n\n/** @type {jQuery} The jQuery node for the page region. */\nProgrammedMode.prototype.node = null;\n\nProgrammedMode.prototype.initProgrammedMode = function() {\n    sId = this.node.attr('data-sid');\n    cmId = this.node.attr('data-cmid');\n    groupMode = Boolean(this.node.attr('data-groupmode'));\n    setInterval(this.reloadList, 20000);\n};\n\nProgrammedMode.prototype.reloadList = function() {\n    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n        let identifier = jQuery(REGION.LISTRESULTS);\n        identifier.append(html);\n        let methodname = SERVICES.GETLISTRESULTS;\n        if (groupMode === true) {\n            methodname = SERVICES.GETGROUPLISTRESULTS;\n        }\n        let request = {\n            methodname: methodname,\n            args: {\n                sid: sId,\n                cmid: cmId\n            }\n        };\n        Ajax.call([request])[0].done(function(response) {\n            // eslint-disable-next-line promise/always-return\n            Templates.render(TEMPLATES.LISTRESULTS, response).then((html) => {\n                identifier.html(html);\n            }).fail(Notification.exception);\n        }).fail(Notification.exception);\n    });\n};\n\nProgrammedMode.prototype.finishSession = function(e) {\n    e.preventDefault();\n    e.stopPropagation();\n    const stringkeys = [\n        {key: 'end_session', component: 'mod_kuet'},\n        {key: 'end_session_desc', component: 'mod_kuet'},\n        {key: 'confirm', component: 'mod_kuet'}\n    ];\n    getStrings(stringkeys).then((langStrings) => {\n        const title = langStrings[0];\n        const confirmMessage = langStrings[1];\n        const buttonText = langStrings[2];\n        return ModalFactory.create({\n            title: title,\n            body: confirmMessage,\n            type: ModalFactory.types.SAVE_CANCEL\n        }).then(modal => {\n            modal.setSaveButtonText(buttonText);\n            modal.getRoot().on(ModalEvents.save, () => {\n                let request = {\n                    methodname: SERVICES.FINISHSESSION,\n                    args: {\n                        cmid: cmId,\n                        sessionid: sId\n                    }\n                };\n                Ajax.call([request])[0].done(function(response) {\n                    if (response.finished === true) {\n                        window.location.replace(M.cfg.wwwroot + '/mod/kuet/view.php?id=' + cmId);\n                    }\n                }).fail(Notification.exception);\n            });\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                modal.destroy();\n            });\n            return modal;\n        });\n    }).done(function(modal) {\n        modal.show();\n        // eslint-disable-next-line no-restricted-globals\n    }).fail(Notification.exception);\n};\n\nProgrammedMode.prototype.raceMode = function() {\n    let scrollUsers = document.querySelector('#content-users');\n    let questions = document.querySelectorAll('.content-responses');\n    scrollUsers.addEventListener('scroll', function() {\n        questions.forEach((question) => {\n            question.scrollTop = scrollUsers.scrollTop;\n        });\n    }, {passive: true});\n};\n\nProgrammedMode.prototype.reloadRace = function() {\n    let identifier = jQuery(REGION.RACERESULTS);\n    let request = {\n        methodname: SERVICES.GETRACERESULTS,\n        args: {\n            sid: sId,\n            cmid: cmId\n        }\n    };\n    Ajax.call([request])[0].done(function(response) {\n        response.programmedmode = true;\n        // eslint-disable-next-line promise/always-return\n        Templates.render(TEMPLATES.RACERESULTS, response).then((html) => {\n            let scrollUsersTop = document.querySelector('#content-users').scrollTop;\n            let scrollQuestionsLeft = document.querySelector('#questions-list').scrollLeft;\n            identifier.html(html);\n            let newScrollUsers = document.querySelector('#content-users');\n            let newScrollQuestions = document.querySelector('#questions-list');\n            ProgrammedMode.prototype.raceMode();\n            newScrollUsers.scrollTop = scrollUsersTop;\n            newScrollQuestions.scrollLeft = scrollQuestionsLeft;\n        }).fail(Notification.exception);\n    }).fail(Notification.exception);\n};\n\nexport const initProgrammedMode = (selector, racemode = false) => {\n    return new ProgrammedMode(selector, racemode);\n};\n"],"names":["cmId","sId","REGION","ACTION","SERVICES","TEMPLATES","groupMode","ProgrammedMode","selector","racemode","node","initProgrammedMode","on","this","finishSession","raceMode","setInterval","reloadRace","prototype","attr","Boolean","reloadList","render","visible","done","html","identifier","append","methodname","request","args","sid","cmid","call","response","then","fail","Notification","exception","e","preventDefault","stopPropagation","key","component","langStrings","title","confirmMessage","buttonText","ModalFactory","create","body","type","types","SAVE_CANCEL","modal","setSaveButtonText","getRoot","ModalEvents","save","sessionid","finished","window","location","replace","M","cfg","wwwroot","hidden","destroy","show","scrollUsers","document","querySelector","questions","querySelectorAll","addEventListener","forEach","question","scrollTop","passive","programmedmode","scrollUsersTop","scrollQuestionsLeft","scrollLeft","newScrollUsers","newScrollQuestions"],"mappings":"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"}