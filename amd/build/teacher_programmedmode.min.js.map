{"version":3,"file":"teacher_programmedmode.min.js","sources":["../src/teacher_programmedmode.js"],"sourcesContent":["\"use strict\";\r\n\r\nimport jQuery from 'jquery';\r\nimport Ajax from 'core/ajax';\r\nimport Templates from 'core/templates';\r\nimport Notification from 'core/notification';\r\nimport {get_strings as getStrings} from 'core/str';\r\nimport ModalFactory from 'core/modal_factory';\r\nimport ModalEvents from 'core/modal_events';\r\n\r\nlet REGION = {\r\n    LISTRESULTS: '[data-region=\"list-results\"]'\r\n};\r\n\r\nlet ACTION = {\r\n    ENDSESSION: '[data-action=\"end_session\"]'\r\n};\r\n\r\nlet SERVICES = {\r\n    GETLISTRESULTS: 'mod_jqshow_getlistresults',\r\n    GETGROUPLISTRESULTS: 'mod_jqshow_getgrouplistresults',\r\n    FINISHSESSION: 'mod_jqshow_finishsession'\r\n};\r\n\r\nlet TEMPLATES = {\r\n    LOADING: 'core/overlay_loading',\r\n    LISTRESULTS: 'mod_jqshow/session/listresults'\r\n};\r\n\r\nlet cmId;\r\nlet sId;\r\nlet groupmode;\r\n\r\n/**\r\n * @constructor\r\n * @param {String} selector\r\n */\r\nfunction ProgrammedMode(selector) {\r\n    this.node = jQuery(selector);\r\n    this.initProgrammedMode();\r\n    jQuery(ACTION.ENDSESSION).on('click', this.finishSession);\r\n}\r\n\r\n/** @type {jQuery} The jQuery node for the page region. */\r\nProgrammedMode.prototype.node = null;\r\n\r\nProgrammedMode.prototype.initProgrammedMode = function() {\r\n    sId = this.node.attr('data-sid');\r\n    cmId = this.node.attr('data-cmid');\r\n    groupmode = this.node.attr('data-groupmode');\r\n    setInterval(this.reloadList, 20000);\r\n};\r\n\r\nProgrammedMode.prototype.reloadList = function() {\r\n    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\r\n        let identifier = jQuery(REGION.LISTRESULTS);\r\n        identifier.append(html);\r\n        let methodname = SERVICES.GETLISTRESULTS;\r\n        if (groupmode == '1') {\r\n            methodname = SERVICES.GETGROUPLISTRESULTS\r\n        }\r\n        let request = {\r\n            methodname: methodname,\r\n            args: {\r\n                sid: sId,\r\n                cmid: cmId\r\n            }\r\n        };\r\n        Ajax.call([request])[0].done(function(response) {\r\n            // eslint-disable-next-line promise/always-return\r\n            Templates.render(TEMPLATES.LISTRESULTS, response).then((html) => {\r\n                identifier.html(html);\r\n            }).fail(Notification.exception);\r\n        }).fail(Notification.exception);\r\n    });\r\n};\r\n\r\nProgrammedMode.prototype.finishSession = function(e) {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    const stringkeys = [\r\n        {key: 'end_session', component: 'mod_jqshow'},\r\n        {key: 'end_session_desc', component: 'mod_jqshow'},\r\n        {key: 'confirm', component: 'mod_jqshow'}\r\n    ];\r\n    getStrings(stringkeys).then((langStrings) => {\r\n        const title = langStrings[0];\r\n        const confirmMessage = langStrings[1];\r\n        const buttonText = langStrings[2];\r\n        return ModalFactory.create({\r\n            title: title,\r\n            body: confirmMessage,\r\n            type: ModalFactory.types.SAVE_CANCEL\r\n        }).then(modal => {\r\n            modal.setSaveButtonText(buttonText);\r\n            modal.getRoot().on(ModalEvents.save, () => {\r\n                let request = {\r\n                    methodname: SERVICES.FINISHSESSION,\r\n                    args: {\r\n                        cmid: cmId,\r\n                        sessionid: sId\r\n                    }\r\n                };\r\n                Ajax.call([request])[0].done(function(response) {\r\n                    if (response.finished === true) {\r\n                        window.location.replace(M.cfg.wwwroot + '/mod/jqshow/view.php?id=' + cmId);\r\n                    }\r\n                }).fail(Notification.exception);\r\n            });\r\n            modal.getRoot().on(ModalEvents.hidden, () => {\r\n                modal.destroy();\r\n            });\r\n            return modal;\r\n        });\r\n    }).done(function(modal) {\r\n        modal.show();\r\n        // eslint-disable-next-line no-restricted-globals\r\n    }).fail(Notification.exception);\r\n};\r\n\r\nexport const initProgrammedMode = (selector) => {\r\n    return new ProgrammedMode(selector);\r\n};\r\n"],"names":["cmId","sId","groupmode","REGION","ACTION","SERVICES","TEMPLATES","ProgrammedMode","selector","node","initProgrammedMode","on","this","finishSession","prototype","attr","setInterval","reloadList","render","visible","done","html","identifier","append","methodname","request","args","sid","cmid","call","response","then","fail","Notification","exception","e","preventDefault","stopPropagation","key","component","langStrings","title","confirmMessage","buttonText","ModalFactory","create","body","type","types","SAVE_CANCEL","modal","setSaveButtonText","getRoot","ModalEvents","save","sessionid","finished","window","location","replace","M","cfg","wwwroot","hidden","destroy","show"],"mappings":"2sBA6BIA,KACAC,IACAC,UArBAC,mBACa,+BAGbC,kBACY,8BAGZC,wBACgB,4BADhBA,6BAEqB,iCAFrBA,uBAGe,2BAGfC,kBACS,uBADTA,sBAEa,0CAWRC,eAAeC,eACfC,MAAO,mBAAOD,eACdE,yCACEN,mBAAmBO,GAAG,QAASC,KAAKC,eAI/CN,eAAeO,UAAUL,KAAO,KAEhCF,eAAeO,UAAUJ,mBAAqB,WAC1CT,IAAMW,KAAKH,KAAKM,KAAK,YACrBf,KAAOY,KAAKH,KAAKM,KAAK,aACtBb,UAAYU,KAAKH,KAAKM,KAAK,kBAC3BC,YAAYJ,KAAKK,WAAY,MAGjCV,eAAeO,UAAUG,WAAa,8BACxBC,OAAOZ,kBAAmB,CAACa,SAAS,IAAOC,MAAK,SAASC,UAC3DC,YAAa,mBAAOnB,oBACxBmB,WAAWC,OAAOF,UACdG,WAAanB,wBACA,KAAbH,YACAsB,WAAanB,kCAEboB,QAAU,CACVD,WAAYA,WACZE,KAAM,CACFC,IAAK1B,IACL2B,KAAM5B,qBAGT6B,KAAK,CAACJ,UAAU,GAAGL,MAAK,SAASU,6BAExBZ,OAAOZ,sBAAuBwB,UAAUC,MAAMV,OACpDC,WAAWD,KAAKA,SACjBW,KAAKC,sBAAaC,cACtBF,KAAKC,sBAAaC,eAI7B3B,eAAeO,UAAUD,cAAgB,SAASsB,GAC9CA,EAAEC,iBACFD,EAAEE,uCACiB,CACf,CAACC,IAAK,cAAeC,UAAW,cAChC,CAACD,IAAK,mBAAoBC,UAAW,cACrC,CAACD,IAAK,UAAWC,UAAW,gBAETR,MAAMS,oBACnBC,MAAQD,YAAY,GACpBE,eAAiBF,YAAY,GAC7BG,WAAaH,YAAY,UACxBI,uBAAaC,OAAO,CACvBJ,MAAOA,MACPK,KAAMJ,eACNK,KAAMH,uBAAaI,MAAMC,cAC1BlB,MAAKmB,QACJA,MAAMC,kBAAkBR,YACxBO,MAAME,UAAUzC,GAAG0C,sBAAYC,MAAM,SAC7B7B,QAAU,CACVD,WAAYnB,uBACZqB,KAAM,CACFE,KAAM5B,KACNuD,UAAWtD,oBAGd4B,KAAK,CAACJ,UAAU,GAAGL,MAAK,SAASU,WACR,IAAtBA,SAAS0B,UACTC,OAAOC,SAASC,QAAQC,EAAEC,IAAIC,QAAU,2BAA6B9D,SAE1EgC,KAAKC,sBAAaC,cAEzBgB,MAAME,UAAUzC,GAAG0C,sBAAYU,QAAQ,KACnCb,MAAMc,aAEHd,QAvBX,IAyBD9B,MAAK,SAAS8B,OACbA,MAAMe,UAEPjC,KAAKC,sBAAaC,wCAGU1B,UACxB,IAAID,eAAeC"}