{"version":3,"file":"teachersockets.min.js","sources":["../src/teachersockets.js"],"sourcesContent":["\"use strict\";\n\nimport jQuery from 'jquery';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport {get_string as getString, get_strings as getStrings} from 'core/str';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Ajax from 'core/ajax';\nimport Encryptor from 'mod_jqshow/encryptor';\nimport Database from 'mod_jqshow/database';\n\nlet REGION = {\n    MESSAGEBOX: '#message-box',\n    USERLIST: '[data-region=\"active-users\"]',\n    COUNTUSERS: '#countusers',\n    TEACHERCANVASCONTENT: '[data-region=\"teacher-canvas-content\"]', // This root.\n    TEACHERCANVAS: '[data-region=\"teacher-canvas\"]',\n    TEACHERPANEL: '[data-region=\"teacher-panel\"]',\n    SESSIONCONTROLER: '[data-region=\"session-controller\"]',\n};\n\nlet ACTION = {\n    BACKSESSION: '[data-action=\"back-session\"]',\n    INITSESSION: '[data-action=\"init-session\"]',\n    ENDSESSION: '[data-action=\"end-session\"]'\n};\n\nlet SERVICES = {\n    ACTIVESESSION: 'mod_jqshow_activesession',\n    GETALLQUESTIONS: 'mod_jqshow_session_getallquestions',\n    NEXTQUESTION: 'mod_jqshow_nextquestion',\n    FIRSTQUESTION: 'mod_jqshow_firstquestion',\n    FINISHSESSION: 'mod_jqshow_finishsession'\n};\n\nlet TEMPLATES = {\n    LOADING: 'core/overlay_loading',\n    SUCCESS: 'core/notification_success',\n    ERROR: 'core/notification_error',\n    PARTICIPANT: 'mod_jqshow/session/manual/waitingroom/participant',\n    QUESTION: 'mod_jqshow/questions/encasement'\n};\n\nlet portUrl = '8080'; // It is rewritten in the constructor.\n\n/**\n * @constructor\n * @param {String} region\n * @param {String} port\n */\nfunction Sockets(region, port) {\n    this.root = jQuery(region);\n    portUrl = port;\n    this.measuringSpeed(); // TODO extend to the whole mod.\n    this.disableDevTools(); // TODO extend to the whole mod.\n    this.initSockets();\n    this.cleanMessages();\n    this.initListeners();\n}\n\nSockets.prototype.cleanMessages = function() {\n    setInterval(function() {\n        messageBox.find(':first-child').remove();\n    }, 10000);\n};\n\nSockets.prototype.disableDevTools = function(){\n    document.addEventListener('contextmenu', (e) => e.preventDefault());\n    document.onkeydown = (e) => {\n        return !(event.keyCode === 123 ||\n            this.ctrlShiftKey(e, 'I') ||\n            this.ctrlShiftKey(e, 'J') ||\n            this.ctrlShiftKey(e, 'C') ||\n            (e.ctrlKey && e.keyCode === 'U'.charCodeAt(0)));\n    };\n};\n\nSockets.prototype.ctrlShiftKey = function(e, keyCode) {\n    return e.ctrlKey && e.shiftKey && e.keyCode === keyCode.charCodeAt(0);\n};\n\nSockets.prototype.measuringSpeed = function() {\n    let connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;\n    if (connection) {\n        let typeConnection = connection.effectiveType;\n        let speedMbps = connection.downlink;\n        // eslint-disable-next-line no-console\n        console.log(\"Type of Connection: \" + typeConnection, \"Estimated speed: \" + speedMbps + \" Mbps\");\n        if (speedMbps < 1) {\n            let reason = {\n                effectiveType: connection.effectiveType,\n                downlink: connection.downlink\n            };\n            getString('lowspeed', 'mod_jqshow', reason).done((s) => {\n                messageBox.append(\n                    '<div class=\"alert alert-danger\" role=\"alert\">' + s + '</div>'\n                );\n            });\n        }\n    } else {\n        // eslint-disable-next-line no-console\n        console.log(\"Connection speed detection is not supported in this browser.\");\n    }\n};\n\nSockets.prototype.backSession = function() {\n    const stringkeys = [\n        {key: 'backtopanelfromsession', component: 'mod_jqshow'},\n        {key: 'backtopanelfromsession_desc', component: 'mod_jqshow'},\n        {key: 'confirm', component: 'mod_jqshow'}\n    ];\n    getStrings(stringkeys).then((langStrings) => {\n        return ModalFactory.create({\n            title: langStrings[0],\n            body: langStrings[1],\n            type: ModalFactory.types.SAVE_CANCEL\n        }).then(modal => {\n            modal.setSaveButtonText(langStrings[2]);\n            modal.getRoot().on(ModalEvents.save, () => {\n                let request = {\n                    methodname: SERVICES.ACTIVESESSION,\n                    args: {\n                        cmid: cmid,\n                        sessionid: sid\n                    }\n                };\n                Ajax.call([request])[0].done(function() {\n                    window.location.replace(M.cfg.wwwroot + '/mod/jqshow/view.php?id=' + cmid);\n                }).fail(Notification.exception);\n            });\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                modal.destroy();\n            });\n            return modal;\n        });\n    }).done(function(modal) {\n        modal.show();\n        // eslint-disable-next-line no-restricted-globals\n    }).fail(Notification.exception);\n};\n\n/* ****************** */\n\n/** @type {jQuery} The jQuery node for the page region. */\nSockets.prototype.root = null;\n\nlet userid = null;\nlet usersocketid = null;\nlet username = null;\nlet userimage = null;\nlet messageBox = null;\nlet countusers = null;\nlet cmid = null;\nlet sid = null;\nlet db = null;\nlet questionsJqids = [];\n// eslint-disable-next-line no-unused-vars\nlet waitingRoom = true;\nlet currentQuestionJqid = null;\nlet nextQuestionJqid = null;\nlet currentCuestionJqid = null;\n\nSockets.prototype.initSockets = function() {\n    userid = this.root[0].dataset.userid;\n    username = this.root[0].dataset.username;\n    userimage = this.root[0].dataset.userimage;\n    cmid = this.root[0].dataset.cmid;\n    sid = this.root[0].dataset.sid;\n    messageBox = this.root.find(REGION.MESSAGEBOX);\n    countusers = this.root.find(REGION.COUNTUSERS);\n    let that = this;\n    this.root.find(ACTION.BACKSESSION).on('click', this.backSession);\n\n    db = Database.initDb(sid, userid);\n    Sockets.prototype.webSocket = new WebSocket(\n        'wss://' + M.cfg.wwwroot.replace(/^https?:\\/\\//, '') + ':' + portUrl + '/jqshow'\n    );\n\n    Sockets.prototype.webSocket.onopen = function() { // Waitingroom.\n        /* The first and second questions are obtained.\n        When the teacher clicks on init session, the teacher will send the first question over the socket to all\n        students, and will get the 3rd question. When a student answers a question, a service will be called to save the answer\n        and progress, and the teacher will be informed via the socket. When the teacher clicks on next question,\n        the 2nd question will be sent by socket to all students, and the 4th question will be obtained.\n        The questions will be stored in the teacher's data storage, you can even store the user's answers so that you\n        don't have to call a service at the end for the ranking.\n        */\n\n        let request = {\n            methodname: SERVICES.FIRSTQUESTION,\n            args: {\n                cmid: cmid,\n                sessionid: sid\n            }\n        };\n        Ajax.call([request])[0].done(function(firstquestion) {\n            let data = {\n                jqid: firstquestion.jqid,\n                value: firstquestion\n            };\n            db.add('questions', data);\n            questionsJqids.push(firstquestion.jqid);\n            currentQuestionJqid = firstquestion.jqid;\n            that.setCurrentQuestion(firstquestion.jqid);\n            that.getNextQuestion(firstquestion.jqid);\n            that.root.find(ACTION.INITSESSION).removeClass('disabled');\n            that.root.find(ACTION.INITSESSION).on('click', that.initSession);\n            that.root.find(ACTION.ENDSESSION).on('click', that.endSession);\n        }).fail(Notification.exception);\n    };\n\n    Sockets.prototype.webSocket.onmessage = function(ev) {\n        // TODO Refactor.\n        let msgDecrypt = Encryptor.decrypt(ev.data);\n        let response = JSON.parse(msgDecrypt); // PHP sends Json data.\n        switch (response.action) {\n            case 'connect':\n                // The server has returned the connected status, it is time to identify yourself.\n                if (response.usersocketid !== undefined) {\n                    usersocketid = response.usersocketid;\n                    let msg = {\n                        'userid': userid,\n                        'name': username,\n                        'pic': userimage, // TODO encrypt.\n                        'isteacher': true,\n                        'cmid': cmid,\n                        'sid': sid,\n                        'usersocketid': usersocketid,\n                        'action': 'newuser'\n                    };\n                    Sockets.prototype.sendMessageSocket(JSON.stringify(msg));\n                }\n                break;\n            case 'newuser': {\n                let identifier = jQuery(REGION.USERLIST);\n                let data = response.students;\n                identifier.html('');\n                if (waitingRoom === false) {\n                    Sockets.prototype.normalizeUser(response.usersocketid);\n                }\n                jQuery.each(data, function(i, student) {\n                    let templateContext = {\n                        'usersocketid': student.usersocketid,\n                        'userimage': student.picture,\n                        'userfullname': student.name,\n                    };\n                    Templates.render(TEMPLATES.PARTICIPANT, templateContext).then(function(html) {\n                        identifier.append(html);\n                    }).fail(Notification.exception);\n                });\n                countusers.html(response.count);\n                break;\n            }\n            case 'countusers':\n                countusers.html(response.count);\n                break;\n            case 'studentQuestionEnd':\n                messageBox.append('<div>' + response.message + '</div>');\n                break;\n            case 'userdisconnected':\n                jQuery('[data-userid=\"' + response.usersocketid + '\"]').remove();\n                countusers.html(response.count);\n                messageBox.append('<div>' + response.message + '</div>');\n                break;\n            case 'alreadyteacher':\n                messageBox.append(\n                    '<div class=\"alert alert-danger\" role=\"alert\">' + response.message + '</div>'\n                );\n                break;\n            default:\n                break;\n        }\n        messageBox[0].scrollTop = messageBox[0].scrollHeight;\n    };\n\n    Sockets.prototype.webSocket.onerror = function() {\n        getString('system_error', 'mod_jqshow').done((s) => {\n            messageBox.append(\n                '<div class=\"alert alert-danger\" role=\"alert\">' + s + '</div>'\n            );\n        });\n    };\n\n    Sockets.prototype.webSocket.onclose = function(ev) {\n        let reason = {\n            reason: ev.reason,\n            code: ev.code\n        };\n        getString('connection_closed', 'mod_jqshow', reason).done((s) => {\n            messageBox.append(\n                '<div class=\"alert alert-warning\" role=\"alert\">' + s + '</div>'\n            );\n            setTimeout(() => {\n                // ... window.location.replace(M.cfg.wwwroot + '/mod/jqshow/view.php?id=' + cmid);\n            }, 5000);\n        });\n    };\n};\n\nSockets.prototype.initListeners = function() {\n    let that = this;\n    addEventListener('nextQuestion', () => {\n        that.nextQuestion();\n    }, false);\n    addEventListener('teacherQuestionEndSelf', () => {\n        that.questionEnd();\n    }, false);\n};\n\nSockets.prototype.setCurrentQuestion = function(currentQuestion) {\n    let data = {\n        state: 'currentQuestion',\n        value: currentQuestion\n    };\n    db.update('statequestions', data);\n};\n\nSockets.prototype.setNextQuestion = function(nextQuestion) {\n    let data = {\n        state: 'nextQuestion',\n        value: nextQuestion\n    };\n    db.update('statequestions', data);\n};\n\nSockets.prototype.getNextQuestion = function(jqid) {\n    let that = this;\n    let request = {\n        methodname: SERVICES.NEXTQUESTION,\n        args: {\n            cmid: cmid,\n            sessionid: sid,\n            jqid: jqid,\n            manual: true\n        }\n    };\n    nextQuestionJqid = null;\n    Ajax.call([request])[0].done(function(nextquestion) {\n        let data = {\n            jqid: nextquestion.jqid,\n            value: nextquestion\n        };\n        db.add('questions', data);\n        nextQuestionJqid = nextquestion.jqid;\n        that.setNextQuestion(nextquestion.jqid);\n    }).fail(Notification.exception);\n};\n\nSockets.prototype.initSession = function() {\n    const stringkeys = [\n        {key: 'init_session', component: 'mod_jqshow'},\n        {key: 'init_session_desc', component: 'mod_jqshow'},\n        {key: 'confirm', component: 'mod_jqshow'},\n        {key: 'sessionstarted', component: 'mod_jqshow'},\n        {key: 'sessionstarted_info', component: 'mod_jqshow'}\n    ];\n    getStrings(stringkeys).then((langStrings) => {\n        return ModalFactory.create({\n            title: langStrings[0],\n            body: langStrings[1],\n            type: ModalFactory.types.SAVE_CANCEL\n        }).then(modal => {\n            modal.setSaveButtonText(langStrings[2]);\n            modal.getRoot().on(ModalEvents.save, () => {\n                let firstQuestion = db.get('questions', currentQuestionJqid);\n                firstQuestion.onsuccess = function() {\n                    let msg = {\n                        'action': 'question',\n                        'sid': sid,\n                        'context': firstQuestion.result\n                    };\n                    Sockets.prototype.sendMessageSocket(JSON.stringify(msg));\n                    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n                        let identifier = jQuery(REGION.TEACHERCANVAS);\n                        identifier.append(html);\n                        currentCuestionJqid = firstQuestion.result.jqid;\n                        firstQuestion.result.value.isteacher = true;\n                        Templates.render(TEMPLATES.QUESTION, firstQuestion.result.value).then(function(html, js) {\n                            identifier.html(html);\n                            jQuery(REGION.TEACHERCANVASCONTENT).find('.content-title h2').html(langStrings[3]);\n                            jQuery(REGION.TEACHERCANVASCONTENT).find('.content-title small').html(langStrings[4]);\n                            jQuery(ACTION.BACKSESSION).remove();\n                            jQuery(ACTION.INITSESSION).remove();\n                            jQuery(ACTION.ENDSESSION).removeClass('hidden').removeClass('disabled');\n                            waitingRoom = false;\n                            Templates.runTemplateJS(js);\n                            jQuery(REGION.LOADING).remove();\n                        }).fail(Notification.exception);\n                    });\n                };\n            });\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                modal.destroy();\n            });\n            return modal;\n        });\n    }).done(function(modal) {\n        modal.show();\n        // eslint-disable-next-line no-restricted-globals\n    }).fail(Notification.exception);\n};\n\nSockets.prototype.endSession = function() {\n    const stringkeys = [\n        {key: 'end_session', component: 'mod_jqshow'},\n        {key: 'end_session_manual_desc', component: 'mod_jqshow'},\n        {key: 'confirm', component: 'mod_jqshow'},\n        {key: 'end_session_error', component: 'mod_jqshow'}\n    ];\n    getStrings(stringkeys).then((langStrings) => {\n        return ModalFactory.create({\n            title: langStrings[0],\n            body: langStrings[1],\n            type: ModalFactory.types.SAVE_CANCEL\n        }).then(modal => {\n            modal.setSaveButtonText(langStrings[2]);\n            modal.getRoot().on(ModalEvents.save, () => {\n                let request = {\n                    methodname: SERVICES.FINISHSESSION,\n                    args: {\n                        cmid: cmid,\n                        sessionid: sid\n                    }\n                };\n                Ajax.call([request])[0].done(function(response) {\n                    if (response.finished === true) {\n                        let deleteDb = db.deleteDatabase();\n                        deleteDb.onerror = function(event) {\n                            // eslint-disable-next-line no-console\n                            console.error(\"Error deleting database.\", event);\n                        };\n                        deleteDb.onsuccess = function() {\n                            window.location.replace(M.cfg.wwwroot + '/mod/jqshow/view.php?id=' + cmid);\n                        };\n                    } else {\n                        Notification.alert('Error', langStrings[3], langStrings[2]);\n                    }\n                }).fail(Notification.exception);\n            });\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                modal.destroy();\n            });\n            return modal;\n        });\n    }).done(function(modal) {\n        modal.show();\n        // eslint-disable-next-line no-restricted-globals\n    }).fail(Notification.exception);\n};\n\nSockets.prototype.nextQuestion = function() {\n    let that = this;\n    if (nextQuestionJqid === null) {\n        this.getNextQuestion(currentCuestionJqid);\n    }\n    let nextQuestion = db.get('statequestions', 'nextQuestion');\n    nextQuestion.onsuccess = function() {\n        let nextQuestionData = db.get('questions', nextQuestion.result.value);\n        nextQuestionData.onsuccess = function() {\n            let msg = {\n                'action': 'question',\n                'sid': sid,\n                'context': nextQuestionData.result\n            };\n            Sockets.prototype.sendMessageSocket(JSON.stringify(msg));\n            Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n                let identifier = jQuery(REGION.TEACHERCANVAS);\n                identifier.append(html);\n                currentCuestionJqid = nextQuestionData.result.jqid;\n                that.setCurrentQuestion(nextQuestionData.result.jqid);\n                that.getNextQuestion(nextQuestionData.result.jqid);\n                nextQuestionData.result.value.isteacher = true;\n                Templates.render(TEMPLATES.QUESTION, nextQuestionData.result.value).then(function(html, js) {\n                    identifier.html(html);\n                    Templates.runTemplateJS(js);\n                    jQuery(REGION.LOADING).remove();\n                }).fail(Notification.exception);\n            });\n        };\n    };\n};\n\nSockets.prototype.questionEnd = function() {\n    let msg = {\n        'action': 'teacherQuestionEnd',\n        'sid': sid,\n        'jqid': currentCuestionJqid\n    };\n    Sockets.prototype.sendMessageSocket(JSON.stringify(msg));\n};\n\nSockets.prototype.normalizeUser = function(usersocketid) {\n    let currentQuestion = db.get('statequestions', 'currentQuestion');\n    currentQuestion.onsuccess = function() {\n        let currentQuestiondata = db.get('questions', currentQuestion.result.value);\n        currentQuestiondata.onsuccess = function() {\n            let msg = {\n                'action': 'normalizeUser',\n                'sid': sid,\n                'ofs': true, // Only for student.\n                'usersocketid': usersocketid,\n                'context': currentQuestiondata.result\n            };\n            Sockets.prototype.sendMessageSocket(JSON.stringify(msg));\n        };\n    };\n};\n\nSockets.prototype.sendMessageSocket = function(msg) {\n    this.webSocket.send(msg);\n};\n\nexport const teacherInitSockets = (region, port) => {\n    return new Sockets(region, port);\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","Object","defineProperty","_exports","value","teacherInitSockets","_jquery","_templates","_notification","_modal_factory","_modal_events","_ajax","_encryptor","_database","REGION","MESSAGEBOX","USERLIST","COUNTUSERS","TEACHERCANVASCONTENT","TEACHERCANVAS","TEACHERPANEL","SESSIONCONTROLER","ACTION","SERVICES","TEMPLATES","portUrl","Sockets","region","port","this","root","jQuery","measuringSpeed","disableDevTools","initSockets","cleanMessages","initListeners","prototype","setInterval","messageBox","find","remove","_this","document","addEventListener","e","preventDefault","onkeydown","event","keyCode","ctrlShiftKey","ctrlKey","charCodeAt","shiftKey","connection","navigator","mozConnection","webkitConnection","typeConnection","effectiveType","speedMbps","downlink","console","log","reason","getString","get_string","done","s","append","backSession","getStrings","key","component","then","langStrings","ModalFactory","create","title","body","type","types","SAVE_CANCEL","modal","setSaveButtonText","getRoot","on","ModalEvents","save","request","methodname","args","cmid","sessionid","sid","Ajax","call","window","location","replace","M","cfg","wwwroot","fail","Notification","exception","hidden","destroy","show","userid","usersocketid","username","userimage","countusers","db","questionsJqids","waitingRoom","currentQuestionJqid","nextQuestionJqid","currentCuestionJqid","dataset","that","Database","initDb","webSocket","WebSocket","onopen","firstquestion","data","jqid","add","push","setCurrentQuestion","getNextQuestion","removeClass","initSession","endSession","onmessage","ev","msgDecrypt","Encryptor","decrypt","response","JSON","parse","action","undefined","msg","name","pic","isteacher","sendMessageSocket","stringify","identifier","students","html","normalizeUser","each","i","student","templateContext","picture","userfullname","Templates","render","count","message","scrollTop","scrollHeight","onerror","onclose","code","setTimeout","nextQuestion","questionEnd","currentQuestion","state","update","setNextQuestion","manual","nextquestion","firstQuestion","get","onsuccess","context","result","visible","js","runTemplateJS","LOADING","finished","deleteDb","deleteDatabase","error","alert","nextQuestionData","currentQuestiondata","ofs","send"],"mappings":"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"}