{"version":3,"file":"teachersockets.min.js","sources":["../src/teachersockets.js"],"sourcesContent":["\"use strict\";\n/* eslint-disable no-unused-vars */ // TODO remove.\n\nimport jQuery from 'jquery';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport {get_string as getString, get_strings as getStrings} from 'core/str';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Ajax from 'core/ajax';\n\nlet REGION = {\n    MESSAGEBOX: '#message-box',\n    USERLIST: '[data-region=\"active-users\"]',\n    COUNTUSERS: '#countusers'\n};\n\nlet ACTION = {\n    BACKSESSION: '[data-action=\"back-session\"]',\n    INITSESSION: '[data-action=\"init-session\"]',\n};\n\nlet SERVICES = {\n    ACTIVESESSION: 'mod_jqshow_activesession'\n};\n\nlet TEMPLATES = {\n    LOADING: 'core/overlay_loading',\n    SUCCESS: 'core/notification_success',\n    ERROR: 'core/notification_error',\n    PARTICIPANT: 'mod_jqshow/session/manual/waitingroom/participant'\n};\n\nlet portUrl = '8080'; // It is rewritten in the constructor.\n\n/**\n * @constructor\n * @param {String} region\n * @param {String} port\n */\nfunction Sockets(region, port) {\n    this.root = jQuery(region);\n    portUrl = port;\n    this.measuringSpeed();\n    this.initSockets();\n}\n\nSockets.prototype.measuringSpeed = function() {\n    let connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;\n    if (connection) {\n        let typeConnection = connection.effectiveType;\n        let speedMbps = connection.downlink;\n        // eslint-disable-next-line no-console\n        console.log(\"Type of Connection: \" + typeConnection);\n        // eslint-disable-next-line no-console\n        console.log(\"Estimated speed: \" + speedMbps + \" Mbps\");\n        if (speedMbps > 1) {\n            let reason = {\n                effectiveType: connection.effectiveType,\n                downlink: connection.downlink\n            };\n            getString('lowspeed', 'mod_jqshow', reason).done((s) => {\n                messageBox.append(\n                    '<div class=\"alert alert-warning\" role=\"alert\">' + s + '</div>'\n                );\n                setTimeout(() => {\n                    // ... window.location.replace(M.cfg.wwwroot + '/mod/jqshow/view.php?id=' + cmid);\n                }, 5000);\n            });\n        }\n    } else {\n        // eslint-disable-next-line no-console\n        console.log(\"Connection speed detection is not supported in this browser.\");\n    }\n};\n\n/** @type {jQuery} The jQuery node for the page region. */\nSockets.prototype.root = null;\n\nlet userid = null;\nlet usersocketid = null;\nlet username = null;\nlet userimage = null;\nlet messageBox = null;\nlet userlist = null;\nlet countusers = null;\nlet cmid = null;\nlet sid = null;\n\nSockets.prototype.initSockets = function() {\n    userid = this.root[0].dataset.userid;\n    username = this.root[0].dataset.username;\n    userimage = this.root[0].dataset.userimage;\n    cmid = this.root[0].dataset.cmid;\n    sid = this.root[0].dataset.sid;\n    messageBox = this.root.find(REGION.MESSAGEBOX);\n    userlist = this.root.find(REGION.USERLIST);\n    countusers = this.root.find(REGION.COUNTUSERS);\n\n    this.root.find(ACTION.BACKSESSION).on('click', this.backSession);\n\n    Sockets.prototype.webSocket = new WebSocket(\n        'wss://' + M.cfg.wwwroot.replace(/^https?:\\/\\//, '') + ':' + portUrl + '/jqshow'\n    );\n\n    Sockets.prototype.webSocket.onopen = function(event) {\n        messageBox.append(\n            '<div class=\"system_msg\" style=\"color:#bbbbbb\">' +\n            'Bienvenido a Jam Quiz Show ' + username + '!</div>'\n        );\n    };\n\n    Sockets.prototype.webSocket.onmessage = function(ev) {\n        let response = JSON.parse(ev.data); // PHP sends Json data.\n        let resAction = response.action; // Message type.\n        switch (resAction) {\n            case 'connect':\n                // The server has returned the connected status, it is time to identify yourself.\n                if (response.usersocketid !== undefined) {\n                    usersocketid = response.usersocketid;\n                    // eslint-disable-next-line no-console\n                    console.log(response.usersocketid);\n                    let msg = {\n                        'userid': userid,\n                        'name': username,\n                        'isteacher': true,\n                        'cmid': cmid,\n                        'sid': sid,\n                        'usersocketid': usersocketid,\n                        'action': 'newuser'\n                    };\n                    Sockets.prototype.sendMessageSocket(JSON.stringify(msg));\n                }\n                break;\n            case 'newuser': {\n                let identifier = jQuery(REGION.USERLIST);\n                let data = response.students;\n                identifier.html('');\n                jQuery.each(data, function (i, student) {\n                    let templateContext = {\n                        'usersocketid': student.usersocketid,\n                        'userimage': student.picture,\n                        'userfullname': student.name,\n                    };\n                    Templates.render(TEMPLATES.PARTICIPANT, templateContext).then(function(html, js) {\n                        identifier.append(html);\n                    }).fail(Notification.exception);\n                });\n                countusers.html(response.count);\n                break;\n            }\n            case 'countusers':\n                countusers.html(response.count);\n                break;\n            case 'userdisconnected':\n                jQuery('[data-userid=\"' + response.usersocketid + '\"]').remove();\n                countusers.html(response.count);\n                messageBox.append('<div>' + response.message + '</div>');\n                break;\n            default:\n                break;\n        }\n        messageBox[0].scrollTop = messageBox[0].scrollHeight;\n    };\n\n    Sockets.prototype.webSocket.onerror = function() {\n        getString('system_error', 'mod_jqshow').done((s) => {\n            messageBox.append(\n                '<div class=\"alert alert-danger\" role=\"alert\">' + s + '</div>'\n            );\n        });\n    };\n\n    Sockets.prototype.webSocket.onclose = function(ev) {\n        let reason = {\n            reason: ev.reason,\n            code: ev.code\n        };\n        getString('connection_closed', 'mod_jqshow', reason).done((s) => {\n            messageBox.append(\n                '<div class=\"alert alert-warning\" role=\"alert\">' + s + '</div>'\n            );\n            setTimeout(() => {\n                // ... window.location.replace(M.cfg.wwwroot + '/mod/jqshow/view.php?id=' + cmid);\n            }, 5000);\n        });\n    };\n};\n\nSockets.prototype.backSession = function() {\n    const stringkeys = [\n        {key: 'backtopanelfromsession', component: 'mod_jqshow'},\n        {key: 'backtopanelfromsession_desc', component: 'mod_jqshow'},\n        {key: 'confirm', component: 'mod_jqshow'}\n    ];\n    getStrings(stringkeys).then((langStrings) => {\n        return ModalFactory.create({\n            title: langStrings[0],\n            body: langStrings[1],\n            type: ModalFactory.types.SAVE_CANCEL\n        }).then(modal => {\n            modal.setSaveButtonText(langStrings[2]);\n            modal.getRoot().on(ModalEvents.save, () => {\n                let request = {\n                    methodname: SERVICES.ACTIVESESSION,\n                    args: {\n                        cmid: cmid,\n                        sessionid: sid\n                    }\n                };\n                Ajax.call([request])[0].done(function() {\n                    window.location.replace(M.cfg.wwwroot + '/mod/jqshow/view.php?id=' + cmid);\n                }).fail(Notification.exception);\n            });\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                modal.destroy();\n            });\n            return modal;\n        });\n    }).done(function(modal) {\n        modal.show();\n        // eslint-disable-next-line no-restricted-globals\n    }).fail(Notification.exception);\n    // eslint-disable-next-line no-console\n    console.log('back');\n};\n\nSockets.prototype.sendMessageSocket = function(msg) {\n    this.webSocket.send(msg);\n};\n\nexport const teacherInitSockets = (region, port) => {\n    return new Sockets(region, port);\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","Object","defineProperty","_exports","value","teacherInitSockets","_jquery","_templates","_notification","_modal_factory","_modal_events","_ajax","REGION","ACTION","SERVICES","TEMPLATES","portUrl","Sockets","region","port","this","root","jQuery","measuringSpeed","initSockets","prototype","connection","navigator","mozConnection","webkitConnection","typeConnection","effectiveType","speedMbps","downlink","console","log","reason","getString","get_string","done","s","messageBox","append","setTimeout","userid","usersocketid","username","countusers","cmid","sid","dataset","userimage","find","on","backSession","webSocket","WebSocket","M","cfg","wwwroot","replace","onopen","event","onmessage","ev","response","JSON","parse","data","action","undefined","msg","name","isteacher","sendMessageSocket","stringify","identifier","students","html","each","i","student","templateContext","picture","userfullname","Templates","render","then","js","fail","Notification","exception","count","remove","message","scrollTop","scrollHeight","onerror","onclose","code","getStrings","key","component","langStrings","ModalFactory","create","title","body","type","types","SAVE_CANCEL","modal","setSaveButtonText","getRoot","ModalEvents","save","request","methodname","args","sessionid","Ajax","call","window","location","hidden","destroy","show","send"],"mappings":"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"}