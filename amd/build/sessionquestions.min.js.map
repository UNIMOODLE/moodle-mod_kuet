{"version":3,"file":"sessionquestions.min.js","sources":["../src/sessionquestions.js"],"sourcesContent":["\"use strict\";\r\n\r\nimport jQuery from 'jquery';\r\nimport {get_string as getString, get_strings as getStrings} from 'core/str';\r\nimport Ajax from 'core/ajax';\r\nimport ModalFactory from 'core/modal_factory';\r\nimport ModalEvents from 'core/modal_events';\r\nimport Templates from 'core/templates';\r\nimport Notification from 'core/notification';\r\nimport SortableList from 'core/sortable_list';\r\nimport ModalJqshow from 'mod_jqshow/modal';\r\n\r\nlet ACTION = {\r\n    DELETEQUESTION: '[data-action=\"delete_question\"]',\r\n    QUESTION: '.question-item',\r\n    QUESTIONPREVIEW: '[data-action=\"question_preview\"]',\r\n};\r\n\r\nlet SERVICES = {\r\n    DELETEQUESTION: 'mod_jqshow_deletequestion',\r\n    SESSIONQUESTIONS: 'mod_jqshow_sessionquestions',\r\n    REORDER: 'mod_jqshow_reorderquestions',\r\n    GETQUESTION: 'mod_jqshow_getquestion'\r\n};\r\n\r\nlet REGION = {\r\n    ROOT: '[data-region=\"question_list\"]',\r\n    PANEL: '[data-region=\"questions-panel\"]',\r\n    LOADING: '[data-region=\"overlay-icon-container\"]',\r\n    SESSIONQUESTIONS: '[data-region=\"session-questions\"]',\r\n    QUESTIONLIST: '[data-region=\"question_list\"]'\r\n};\r\n\r\nlet TEMPLATES = {\r\n    LOADING: 'core/overlay_loading',\r\n    SUCCESS: 'core/notification_success',\r\n    ERROR: 'core/notification_error',\r\n    QUESTIONSSELECTED: 'mod_jqshow/createsession/sessionquestions',\r\n    QUESTION: 'mod_jqshow/questions/encasement'\r\n};\r\n\r\nlet cmId;\r\nlet sId;\r\nlet jqshowId;\r\nlet sortable;\r\n\r\n/**\r\n * @constructor\r\n * @param {String} selector The selector for the page region containing the page.\r\n */\r\nfunction SessionQuestions(selector) {\r\n    this.node = jQuery(selector);\r\n    sId = this.node.attr('data-sid');\r\n    cmId = this.node.attr('data-cmid');\r\n    jqshowId = this.node.attr('data-jqshowid');\r\n    this.initPanel();\r\n}\r\n\r\n/** @type {jQuery} The jQuery node for the page region. */\r\nSessionQuestions.prototype.node = null;\r\n\r\nSessionQuestions.prototype.initPanel = function() {\r\n    this.node.find(ACTION.DELETEQUESTION).on('click', this.deleteQuestion.bind(this));\r\n    this.node.find(ACTION.QUESTIONPREVIEW).on('click', this.questionPreview.bind(this));\r\n    if (!(sortable instanceof SortableList)) {\r\n        sortable = new SortableList(REGION.QUESTIONLIST);\r\n    }\r\n    jQuery(REGION.QUESTIONLIST + ' > ' + ACTION.QUESTION).on(SortableList.EVENTS.DROP, this.reorderQuestions.bind(this));\r\n};\r\n\r\nSessionQuestions.prototype.questionPreview = function(e) {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    let questionnId = jQuery(e.currentTarget).attr('data-questionnid');\r\n    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\r\n        let identifier = jQuery(REGION.ROOT);\r\n        identifier.append(html);\r\n        let request = {\r\n            methodname: SERVICES.GETQUESTION,\r\n            args: {\r\n                cmid: cmId,\r\n                sid: sId,\r\n                jqid: questionnId\r\n            }\r\n        };\r\n        Ajax.call([request])[0].done(function(question) {\r\n            Templates.render(TEMPLATES.QUESTION, question).then(function(html, js) {\r\n                getString('preview', 'mod_jqshow').done((title) => {\r\n                    ModalFactory.create({\r\n                        classes: 'modal_jqshow',\r\n                        body: html,\r\n                        title: title,\r\n                        footer: '',\r\n                        type: ModalJqshow.TYPE\r\n                    }).then(modal => {\r\n                        modal.getRoot().on(ModalEvents.hidden, function() {\r\n                            modal.destroy();\r\n                        });\r\n                        jQuery(REGION.LOADING).remove();\r\n                        modal.show();\r\n                        Templates.runTemplateJS(js);\r\n                    }).fail(Notification.exception);\r\n                }).fail(Notification.exception);\r\n            });\r\n        });\r\n    });\r\n};\r\n\r\nSessionQuestions.prototype.reloadSessionQuestionsHtml = function() {\r\n    let request = {\r\n        methodname: SERVICES.SESSIONQUESTIONS,\r\n        args: {\r\n            jqshowid: jqshowId,\r\n            cmid: cmId,\r\n            sid: sId\r\n        }\r\n    };\r\n    Ajax.call([request])[0].done(function(response) {\r\n        Templates.render(TEMPLATES.QUESTIONSSELECTED, response).then(function(html, js) {\r\n            jQuery(REGION.SESSIONQUESTIONS).html(html);\r\n            Templates.runTemplateJS(js);\r\n            jQuery(REGION.LOADING).remove();\r\n        }).fail(Notification.exception);\r\n    }).fail(Notification.exception);\r\n};\r\n\r\nSessionQuestions.prototype.deleteQuestion = function(e) {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    let that = this;\r\n    let questionId = jQuery(e.currentTarget).attr('data-questionnid');\r\n    const stringkeys = [\r\n        {key: 'deletequestion', component: 'mod_jqshow'},\r\n        {key: 'deletequestion_desc', component: 'mod_jqshow'},\r\n        {key: 'confirm', component: 'mod_jqshow'}\r\n    ];\r\n    getStrings(stringkeys).then((langStrings) => {\r\n        const title = langStrings[0];\r\n        const message = langStrings[1];\r\n        const buttonText = langStrings[2];\r\n        return ModalFactory.create({\r\n            title: title,\r\n            body: message,\r\n            type: ModalFactory.types.SAVE_CANCEL\r\n        }).then(modal => {\r\n            modal.setSaveButtonText(buttonText);\r\n            modal.getRoot().on(ModalEvents.save, () => {\r\n                Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\r\n                    let identifier = jQuery(REGION.PANEL);\r\n                    identifier.append(html);\r\n                });\r\n                let request = {\r\n                    methodname: SERVICES.DELETEQUESTION,\r\n                    args: {\r\n                        qid: questionId,\r\n                        sid: sId\r\n                    }\r\n                };\r\n                Ajax.call([request])[0].done(function(response) {\r\n                    if (response.deleted) {\r\n                        that.reloadSessionQuestionsHtml();\r\n                    } else {\r\n                        jQuery(REGION.LOADING).remove();\r\n                        alert('no se ha podido borrar la pregunta. intentalo de nuevo mas tarde.');\r\n                    }\r\n                });\r\n            });\r\n            modal.getRoot().on(ModalEvents.hidden, () => {\r\n                modal.destroy();\r\n            });\r\n            return modal;\r\n        });\r\n    }).done(function(modal) {\r\n        modal.show();\r\n        // eslint-disable-next-line no-restricted-globals\r\n    }).fail(Notification.exception);\r\n};\r\n\r\nSessionQuestions.prototype.reorderQuestions = function(e) {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    let that = this;\r\n    let allQuestions = jQuery(ACTION.QUESTION);\r\n    let newOrder = [];\r\n    let order = 1;\r\n    allQuestions.each(function callback(index, question) {\r\n        let questiondata = {\r\n            qid: jQuery(question).attr('data-questionnid'),\r\n            qorder: order\r\n        };\r\n        newOrder.push(questiondata);\r\n        order++;\r\n    });\r\n    newOrder.pop();\r\n    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\r\n        let identifier = jQuery(REGION.PANEL);\r\n        identifier.append(html);\r\n    });\r\n    let request = {\r\n        methodname: SERVICES.REORDER,\r\n        args: {\r\n            questions: newOrder\r\n        }\r\n    };\r\n    Ajax.call([request])[0].done(function() {\r\n        that.reloadSessionQuestionsHtml();\r\n    });\r\n};\r\n\r\nexport const initSessionQuestions = (selector) => {\r\n    return new SessionQuestions(selector);\r\n};\r\n"],"names":["cmId","sId","jqshowId","sortable","ACTION","SERVICES","REGION","TEMPLATES","SessionQuestions","selector","node","this","attr","initPanel","prototype","find","on","deleteQuestion","bind","questionPreview","SortableList","EVENTS","DROP","reorderQuestions","e","preventDefault","stopPropagation","questionnId","currentTarget","render","visible","done","html","append","request","methodname","args","cmid","sid","jqid","call","question","then","js","title","create","classes","body","footer","type","ModalJqshow","TYPE","modal","getRoot","ModalEvents","hidden","destroy","remove","show","runTemplateJS","fail","Notification","exception","reloadSessionQuestionsHtml","jqshowid","response","that","questionId","key","component","langStrings","message","buttonText","ModalFactory","types","SAVE_CANCEL","setSaveButtonText","save","qid","deleted","alert","allQuestions","newOrder","order","each","index","questiondata","qorder","push","pop","questions"],"mappings":"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"}