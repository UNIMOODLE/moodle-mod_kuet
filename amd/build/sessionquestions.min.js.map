{"version":3,"file":"sessionquestions.min.js","sources":["../src/sessionquestions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n// Project implemented by the \"Recovery, Transformation and Resilience Plan.\n// Funded by the European Union - Next GenerationEU\".\n//\n// Produced by the UNIMOODLE University Group: Universities of\n// Valladolid, Complutense de Madrid, UPV/EHU, León, Salamanca,\n// Illes Balears, Valencia, Rey Juan Carlos, La Laguna, Zaragoza, Málaga,\n// Córdoba, Extremadura, Vigo, Las Palmas de Gran Canaria y Burgos..\n\n/**\n *\n * @module    mod_kuet/sessionquestions\n * @copyright  2023 Proyecto UNIMOODLE\n * @author     UNIMOODLE Group (Coordinator) <direccion.area.estrategia.digital@uva.es>\n * @author     3IPUNT <contacte@tresipunt.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\"use strict\";\n\nimport jQuery from 'jquery';\nimport {get_string as getString, get_strings as getStrings} from 'core/str';\nimport Ajax from 'core/ajax';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport SortableList from 'core/sortable_list';\nimport ModalKuet from 'mod_kuet/modal';\n\nlet ACTION = {\n    DELETEQUESTION: '[data-action=\"delete_question\"]',\n    QUESTION: '.question-item',\n    QUESTIONDROP: '.question-item [data-drag-type=\"move\"]',\n    QUESTIONPREVIEW: '[data-action=\"question_preview\"]',\n    ENDCREATESESSION: '[data-action=\"end_create_session\"]',\n};\n\nlet SERVICES = {\n    DELETEQUESTION: 'mod_kuet_deletequestion',\n    SESSIONQUESTIONS: 'mod_kuet_sessionquestions',\n    REORDER: 'mod_kuet_reorderquestions',\n    GETQUESTION: 'mod_kuet_getquestion',\n    ACTIVESESSION: 'mod_kuet_activesession',\n};\n\nlet REGION = {\n    ROOT: '[data-region=\"question_list\"]',\n    PANEL: '[data-region=\"questions-panel\"]',\n    LOADING: '[data-region=\"overlay-icon-container\"]',\n    SESSIONQUESTIONS: '[data-region=\"session-questions\"]',\n    QUESTIONLIST: '[data-region=\"question_list\"]'\n};\n\nlet TEMPLATES = {\n    LOADING: 'core/overlay_loading',\n    SUCCESS: 'core/notification_success',\n    ERROR: 'core/notification_error',\n    QUESTIONSSELECTED: 'mod_kuet/createsession/sessionquestions',\n    QUESTION: 'mod_kuet/questions/encasement'\n};\n\nlet cmId;\nlet sId;\nlet kuetId;\nlet sortable;\n\n/**\n * @constructor\n * @param {String} selector The selector for the page region containing the page.\n */\nfunction SessionQuestions(selector) {\n    this.node = jQuery(selector);\n    sId = this.node.attr('data-sid');\n    cmId = this.node.attr('data-cmid');\n    kuetId = this.node.attr('data-kuetid');\n    this.initPanel();\n}\n\n/** @type {jQuery} The jQuery node for the page region. */\nSessionQuestions.prototype.node = null;\n\nSessionQuestions.prototype.initPanel = function() {\n    this.node.find(ACTION.DELETEQUESTION).on('click', this.deleteQuestion.bind(this));\n    this.node.find(ACTION.QUESTIONPREVIEW).on('click', this.questionPreview.bind(this));\n    if (!(sortable instanceof SortableList)) {\n        sortable = new SortableList(REGION.QUESTIONLIST);\n    }\n    jQuery(REGION.QUESTIONLIST + ' > ' + ACTION.QUESTIONDROP).on('click', function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n    });\n    jQuery(REGION.QUESTIONLIST + ' > ' + ACTION.QUESTION).on(SortableList.EVENTS.DROP, this.reorderQuestions.bind(this));\n    jQuery(ACTION.ENDCREATESESSION).on('click', this.activeSession.bind(this)).removeClass('disabled');\n};\n\nSessionQuestions.prototype.activeSession = function(e) {\n    e.preventDefault();\n    e.stopPropagation();\n    let request = {\n        methodname: SERVICES.ACTIVESESSION,\n        args: {\n            cmid: cmId,\n            sessionid: sId\n        }\n    };\n    Ajax.call([request])[0].done(function() {\n        window.location.replace(M.cfg.wwwroot + '/mod/kuet/view.php?id=' + cmId);\n    }).fail(Notification.exception);\n};\n\nSessionQuestions.prototype.questionPreview = function(e) {\n    e.preventDefault();\n    e.stopPropagation();\n    let questionnId = jQuery(e.currentTarget).attr('data-questionnid');\n    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n        let identifier = jQuery(REGION.ROOT);\n        identifier.append(html);\n        let request = {\n            methodname: SERVICES.GETQUESTION,\n            args: {\n                cmid: cmId,\n                sid: sId,\n                kid: questionnId\n            }\n        };\n        Ajax.call([request])[0].done(function(question) {\n            Templates.render(TEMPLATES.QUESTION, question).then(function(html, js) {\n                getString('preview', 'mod_kuet').done((title) => {\n                    ModalFactory.create({\n                        classes: 'modal_kuet',\n                        body: html,\n                        title: title,\n                        footer: '',\n                        type: ModalKuet.TYPE\n                    }).then(modal => {\n                        modal.getRoot().on(ModalEvents.hidden, function() {\n                            modal.destroy();\n                        });\n                        jQuery(REGION.LOADING).remove();\n                        modal.show();\n                        Templates.runTemplateJS(js);\n                    }).fail(Notification.exception);\n                }).fail(Notification.exception);\n            });\n        });\n    });\n};\n\nSessionQuestions.prototype.reloadSessionQuestionsHtml = function() {\n    let request = {\n        methodname: SERVICES.SESSIONQUESTIONS,\n        args: {\n            kuetid: kuetId,\n            cmid: cmId,\n            sid: sId\n        }\n    };\n    Ajax.call([request])[0].done(function(response) {\n        Templates.render(TEMPLATES.QUESTIONSSELECTED, response).then(function(html, js) {\n            jQuery(REGION.SESSIONQUESTIONS).html(html);\n            Templates.runTemplateJS(js);\n            jQuery(REGION.LOADING).remove();\n        }).fail(Notification.exception);\n    }).fail(Notification.exception);\n};\n\nSessionQuestions.prototype.deleteQuestion = function(e) {\n    e.preventDefault();\n    e.stopPropagation();\n    let that = this;\n    let questionId = jQuery(e.currentTarget).attr('data-questionnid');\n    const stringkeys = [\n        {key: 'deletequestion', component: 'mod_kuet'},\n        {key: 'deletequestion_desc', component: 'mod_kuet'},\n        {key: 'confirm', component: 'mod_kuet'}\n    ];\n    getStrings(stringkeys).then((langStrings) => {\n        const title = langStrings[0];\n        const message = langStrings[1];\n        const buttonText = langStrings[2];\n        return ModalFactory.create({\n            title: title,\n            body: message,\n            type: ModalFactory.types.SAVE_CANCEL\n        }).then(modal => {\n            modal.setSaveButtonText(buttonText);\n            modal.getRoot().on(ModalEvents.save, () => {\n                Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n                    let identifier = jQuery(REGION.PANEL);\n                    identifier.append(html);\n                });\n                let request = {\n                    methodname: SERVICES.DELETEQUESTION,\n                    args: {\n                        qid: questionId,\n                        sid: sId\n                    }\n                };\n                Ajax.call([request])[0].done(function(response) {\n                    if (response.deleted) {\n                        that.reloadSessionQuestionsHtml();\n                    } else {\n                        jQuery(REGION.LOADING).remove();\n                        alert('no se ha podido borrar la pregunta. intentalo de nuevo mas tarde.');\n                    }\n                });\n            });\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                modal.destroy();\n            });\n            return modal;\n        });\n    }).done(function(modal) {\n        modal.show();\n        // eslint-disable-next-line no-restricted-globals\n    }).fail(Notification.exception);\n};\n\nSessionQuestions.prototype.reorderQuestions = function(e) {\n    e.preventDefault();\n    e.stopPropagation();\n    let that = this;\n    let allQuestions = jQuery(ACTION.QUESTION);\n    let newOrder = [];\n    let order = 1;\n    allQuestions.each(function callback(index, question) {\n        let questiondata = {\n            qid: jQuery(question).attr('data-questionnid'),\n            qorder: order\n        };\n        newOrder.push(questiondata);\n        order++;\n    });\n    newOrder.pop();\n    Templates.render(TEMPLATES.LOADING, {visible: true}).done(function(html) {\n        let identifier = jQuery(REGION.PANEL);\n        identifier.append(html);\n    });\n    let request = {\n        methodname: SERVICES.REORDER,\n        args: {\n            questions: newOrder\n        }\n    };\n    Ajax.call([request])[0].done(function() {\n        that.reloadSessionQuestionsHtml();\n    });\n};\n\nexport const initSessionQuestions = (selector) => {\n    return new SessionQuestions(selector);\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","Object","defineProperty","_exports","value","initSessionQuestions","_jquery","_ajax","_modal_factory","_modal_events","_templates","_notification","_sortable_list","_modal","cmId","sId","kuetId","sortable","ACTION","SERVICES","REGION","TEMPLATES","SessionQuestions","selector","this","node","jQuery","attr","initPanel","prototype","find","on","deleteQuestion","bind","questionPreview","SortableList","e","preventDefault","stopPropagation","EVENTS","DROP","reorderQuestions","activeSession","removeClass","request","methodname","args","cmid","sessionid","Ajax","call","done","window","location","replace","M","cfg","wwwroot","fail","Notification","exception","questionnId","currentTarget","Templates","render","visible","html","append","sid","kid","question","then","js","getString","title","ModalFactory","create","classes","body","footer","type","ModalKuet","TYPE","modal","getRoot","ModalEvents","hidden","destroy","remove","show","runTemplateJS","reloadSessionQuestionsHtml","kuetid","response","that","questionId","getStrings","key","component","langStrings","message","buttonText","types","SAVE_CANCEL","setSaveButtonText","save","qid","deleted","alert","allQuestions","newOrder","order","each","index","questiondata","qorder","push","pop","questions"],"mappings":"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"}